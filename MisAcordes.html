<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Chord Helper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            .modal-content {
                margin: 10% auto;
                width: 95%;
                max-height: 70vh;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .modal-header {
                padding: 20px;
            }
            
            .modal-header h2 {
                font-size: 1.5em;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .help-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            padding: 10px 20px;
            font-size: 1em;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .help-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .language-toggle {
            position: absolute;
            top: 20px;
            right: 140px;
            padding: 8px 15px;
            font-size: 1.5em;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            line-height: 1;
        }

        .language-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .notation-toggle {
            position: absolute;
            top: 20px;
            left: 30px;
            padding: 10px 20px;
            font-size: 1em;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notation-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .content {
            padding: 40px;
        }

        .chord-input-section {
            margin-bottom: 40px;
            text-align: center;
        }

        .chord-input-section h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-weight: 400;
        }

        .chord-input {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .chord-input input {
            padding: 15px 20px;
            font-size: 1.2em;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            min-width: 200px;
            transition: all 0.3s ease;
        }

        .chord-input input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
        }

        .chord-input button {
            padding: 15px 30px;
            font-size: 1.2em;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chord-input button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .piano-container {
            margin: 40px 0;
            text-align: center;
        }

        .piano-container h2 {
            margin-bottom: 30px;
            color: #2c3e50;
            font-weight: 400;
        }

        .piano {
            display: inline-block;
            background: #333;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            overflow-x: auto;
        }

        .octave {
            display: inline-block;
            position: relative;
            margin-right: 2px;
        }

        .white-key {
            width: 50px;
            height: 200px;
            background: #fff;
            border: 2px solid #ddd;
            display: inline-block;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            border-radius: 0 0 8px 8px;
            user-select: none;
        }

        .white-key:hover {
            background: #f0f0f0;
            transform: translateY(2px);
        }

        .white-key.active {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            transform: translateY(3px);
            box-shadow: inset 0 3px 10px rgba(0,0,0,0.3);
        }

        .black-key {
            width: 35px;
            height: 130px;
            background: #222;
            position: absolute;
            top: 0;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 0 0 5px 5px;
            z-index: 2;
            user-select: none;
        }

        .black-key:hover {
            background: #444;
            transform: translateY(2px);
        }

        .black-key.active {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            transform: translateY(3px);
            box-shadow: inset 0 3px 10px rgba(0,0,0,0.5);
        }

        .white-key.preview {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .black-key.preview {
            background: linear-gradient(45deg, #3498db, #2980b9);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.6);
        }

        .key-label {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            font-weight: bold;
        }

        .black-key .key-label {
            color: white;
            bottom: 15px;
            font-size: 0.7em;
        }

        .chord-info {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            text-align: center;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .chord-name {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .chord-notes {
            font-size: 1.3em;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .chord-type {
            font-size: 1.1em;
            color: #95a5a6;
            font-style: italic;
        }

        .controls {
            text-align: center;
            margin: 30px 0;
        }

        .clear-btn {
            padding: 12px 25px;
            font-size: 1.1em;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .instructions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            text-align: left;
        }

        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .instructions ul {
            color: #7f8c8d;
            line-height: 1.6;
        }

        .insights-btn {
            padding: 12px 25px;
            font-size: 1.1em;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
            opacity: 0.7;
            pointer-events: none;
        }

        .insights-btn.active {
            opacity: 1;
            pointer-events: all;
        }

        .insights-btn:hover.active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .other-chords-btn {
            padding: 12px 25px;
            font-size: 1.1em;
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
            opacity: 0.7;
            pointer-events: none;
        }

        .other-chords-btn.active {
            opacity: 1;
            pointer-events: all;
        }

        .other-chords-btn:hover.active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }

        .chord-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 6px;
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .chord-list::-webkit-scrollbar {
            width: 5px;
        }
        
        .chord-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }
        
        .chord-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }
        
        .chord-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .chord-list-item {
            padding: 8px;
            background: linear-gradient(45deg, #ecf0f1, #bdc3c7);
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
            font-size: 0.85em;
        }

        .chord-list-item:hover {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .chord-list-item.highlighted {
            border-color: #3498db;
            background: linear-gradient(45deg, #e8f4f8, #d4e9f5);
        }

        .chord-list-item.selected {
            border-color: #27ae60;
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            font-weight: 600;
        }

        #otherChordsModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.3);
        }

        #otherChordsModal .modal-content {
            background-color: white;
            margin: 1% auto;
            padding: 0;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            width: 35%;
            max-width: 400px;
            max-height: 45vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #otherChordsModal .modal-body {
            overflow-y: auto;
            flex: 1;
            padding: 0;
        }

        #otherChordsModal .modal-header {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            padding: 12px 18px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #otherChordsModal .modal-header h2 {
            margin: 0;
            font-size: 1em;
            font-weight: 400;
        }

        #otherChordsModal .close {
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 3px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        #otherChordsModal .close:hover {
            background-color: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 300;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close:hover {
            background-color: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
            line-height: 1.6;
            color: #2c3e50;
        }

        .insight-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #9b59b6;
        }

        .insight-section h3 {
            color: #8e44ad;
            margin-bottom: 12px;
            font-size: 1.2em;
        }

        .insight-section p {
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #9b59b6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .header {
                padding: 50px 20px 20px;
            }
            
            .header h1 {
                font-size: 1.5em;
                margin-top: 10px;
            }
            
            .notation-toggle {
                top: 10px;
                left: 10px;
                padding: 8px 12px;
                font-size: 0.85em;
            }
            
            .help-btn {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 0.85em;
            }
            
            .language-toggle {
                top: 10px;
                right: 80px;
                padding: 6px 10px;
                font-size: 1.2em;
            }
            
            .chord-input {
                flex-direction: column;
                align-items: center;
            }
            
            .chord-input input {
                min-width: 250px;
            }
            
            .white-key {
                width: 40px;
                height: 160px;
            }
            
            .black-key {
                width: 28px;
                height: 110px;
            }
            
            .chord-name {
                font-size: 2em;
            }

            #otherChordsModal .modal-content {
                width: 85%;
                max-width: 85%;
                max-height: 50vh;
            }

            .chord-list {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                gap: 4px;
                padding: 8px;
            }

            .chord-list-item {
                padding: 6px;
                font-size: 0.75em;
            }
            
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="notation-toggle" onclick="toggleNotation()">
                <span id="notationIcon">üéµ</span>
                <span id="notationText">C#, Eb</span>
            </button>
            <h1 id="headerTitle">üéπ Piano Chord Helper</h1>
            <button class="language-toggle" onclick="toggleLanguage()" id="languageBtn">üá™üá∏</button>
            <button class="help-btn" onclick="showHelp()" id="helpBtn">‚ùì Help</button>
        </div>
        
        <div class="content">
            <div class="chord-input-section">
                <h2 id="chordInputTitle">Enter a Chord Name</h2>
                <div class="chord-input">
                    <input type="text" id="chordInput" placeholder="e.g., Cmaj7, F#dim, Am" />
                    <button onclick="findChord()" id="showChordBtn">Show Chord</button>
                </div>
            </div>

            <div class="piano-container">
                <h2 id="pianoTitle">Click the Keys</h2>
                <div class="piano" id="piano"></div>
            </div>

            <div class="chord-info" id="chordInfo">
                <div class="chord-name" id="chordName">Select notes or enter a chord name</div>
                <div class="chord-notes" id="chordNotes">Click piano keys above or type a chord name</div>
                <div class="chord-type" id="chordType">Ready to help you identify chords!</div>
            </div>

            <div class="controls">
                <button class="clear-btn" onclick="clearAll()" id="clearBtn">Clear All</button>
                <button class="insights-btn active" id="insightsBtn" onclick="showChordInfo()">Chord Info</button>
                <button class="other-chords-btn" id="otherChordsBtn" onclick="showOtherChords()">Otros Acordes</button>
            </div>
        </div>
    </div>

    <!-- Modal for Help -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <!-- Content will be generated dynamically by updateHelpModal() -->
        </div>
    </div>

    <!-- Modal for Chord Information -->
    <div id="insightsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalChordName">Chord Information</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Getting AI insights for this chord...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Other Chords -->
    <div id="otherChordsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="otherChordsModalTitle">Otros Acordes</h2>
                <button class="close" onclick="closeOtherChordsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="otherChordsListContainer" class="chord-list"></div>
            </div>
        </div>
    </div>

    <script>
        const selectedNotes = new Set();
        
        // Language system
        let currentLanguage = 'es'; // 'en' or 'es'
        
        const translations = {
            en: {
                headerTitle: 'Piano Chords',
                helpBtn: 'Help',
                chordInputTitle: 'Enter a Chord Name',
                showChordBtn: 'Show Chord',
                pianoTitle: 'Click the Keys',
                clearBtn: 'Clear All',
                insightsBtn: 'Chord Info',
                otherChordsBtn: 'Other Chords',
                otherChordsWithRoot: 'Chords with {note} as root',
                otherChordsContaining: 'Chords containing: {notes}',
                noChordsFound: 'No chords found containing these three notes.',
                defaultChordName: 'Select notes or enter a chord name',
                defaultChordNotes: 'Click piano keys above or type a chord name',
                defaultChordType: 'Ready to help you identify chords!',
                placeholderAnglo: 'e.g., Cmaj7, F#dim, Am',
                placeholderItalian: 'e.g., Domaj7, Fa#dim, Lam',
                singleNote: 'Single note. click "Other Chords" to see all chords with this note as root.',
                addMoreNotes: 'Add more notes to form a chord',
                unknownChord: 'Unknown Chord',
                notes: 'Notes',
                noMatch: "This combination doesn't match a common chord pattern",
                invalidChord: 'Invalid Chord',
                isNotRecognized: 'is not recognized',
                tryFormats: 'Try formats like: C, Cm, C7, Cmaj7, F#dim',
                unknownChordType: 'Unknown Chord Type',
                chordTypeNotFound: 'not found',
                tryCommonTypes: 'Try common types like maj7, m, dim, sus4',
                modalHelpTitle: 'How to Use',
                helpNotation: 'üéµ Musical Notation',
                helpNotationText: 'Click the "üéµ Do#, Mib" or "üéµ C#, Eb" button in the top-left corner to switch between Italian notation (Do, Re, Mi, Fa, Sol, La, Si) and Anglo-Saxon notation (C, D, E, F, G, A, B). All labels, chord names, and input examples will update automatically!',
                helpIdentify: 'Identify Chords',
                helpIdentifyText: 'Click on piano keys to select notes, and the chord name will appear below automatically.',
                helpFind: 'üîç Find Chord Notes',
                helpFindText: 'Type a chord name in the input field and click "Show Chord" to see which keys to play. Examples: <strong>Cmaj7</strong>, <strong>F#dim</strong>, <strong>Am</strong> (Anglo-Saxon) or <strong>Domaj7</strong>, <strong>Fa#dim</strong>, <strong>Lam</strong> (Italian).',
                helpFormats: 'üìù Supported Formats',
                helpFormatsText: 'Major, minor, diminished, augmented, suspended, power chords, and extended chords (7th, 9th, 11th, 13th) are all supported. Works with both notation systems!',
                helpInfo: 'üìö Chord Information',
                helpInfoText: 'Click "Chord Info" button to learn about the chord\'s characteristics, usage in music, famous songs that use it, and tips for playing it on piano.',
                helpOtherChords: 'üéπ Other Chords',
                helpOtherChordsText: 'The "Other Chords" button becomes active when you select <strong>1 note</strong> or <strong>3 notes</strong>. With 1 note, it shows all chords using that note as root. With 3 notes, it shows all chords containing those notes. <strong>Click</strong> on a chord to preview it in blue on the piano. <strong>Double-click</strong> to select it.',
                helpClear: 'üóëÔ∏è Clear Selection',
                helpClearText: 'Use the "Clear All" button to deselect all keys and start over with a fresh selection.',
                modalChordInfo: 'Chord Information',
                chordStructure: 'üéπ Chord Structure',
                chordStructureNotes: 'Notes:',
                soundCharacteristics: 'üéµ Sound & Characteristics',
                keyAspects: 'üîç Key Aspects',
                commonUsage: 'üé∏ Common Usage',
                famousSongs: 'üé§ Famous Songs',
                chordProgressions: 'üéº Chord Progressions',
                pianoTips: 'üí° Piano Tips',
                learnMore: 'üîé Learn More',
                learnMoreText: 'Want to know more about',
                learnMoreResources: 'Check out these free resources:',
                infoNotAvailable: 'Information not available'
            },
            es: {
                headerTitle: 'Acordes de Piano',
                helpBtn: 'Ayuda',
                chordInputTitle: 'Introduce un Nombre de Acorde',
                showChordBtn: 'Mostrar Acorde',
                pianoTitle: 'Haz Clic en las Teclas',
                clearBtn: 'Limpiar Todo',
                insightsBtn: 'Info del Acorde',
                otherChordsBtn: 'Otros Acordes',
                otherChordsWithRoot: 'Acordes con {note} como t√≥nica',
                otherChordsContaining: 'Acordes que contienen: {notes}',
                noChordsFound: 'No se encontraron acordes que contengan estas tres notas.',
                defaultChordName: 'Selecciona notas o introduce un acorde',
                defaultChordNotes: 'Haz clic en las teclas del piano o escribe un nombre de acorde',
                defaultChordType: '¬°Listo para ayudarte a identificar acordes!',
                placeholderAnglo: 'ej., Cmaj7, F#dim, Am',
                placeholderItalian: 'ej., Domaj7, Fa#dim, Lam',
                singleNote: 'Nota individual. Pulsa "Otros Acordes" para ver todos los que tienen esta nota como t√≥nica',
                addMoreNotes: 'Agrega m√°s notas para formar un acorde.',
                unknownChord: 'Acorde Desconocido',
                notes: 'Notas',
                noMatch: 'Esta combinaci√≥n no coincide con un patr√≥n de acorde com√∫n',
                invalidChord: 'Acorde Inv√°lido',
                isNotRecognized: 'no reconocido',
                tryFormats: 'Intenta formatos como: Do, Dom, Do7, Domaj7, Fa#dim',
                unknownChordType: 'Tipo de Acorde Desconocido',
                chordTypeNotFound: 'no encontrado',
                tryCommonTypes: 'Intenta tipos comunes como maj7, m, dim, sus4',
                modalHelpTitle: 'Ayuda',
                helpNotation: 'üéµ Notaci√≥n Musical',
                helpNotationText: 'Haz clic en el bot√≥n "üéµ Do#, Mib" o "üéµ C#, Eb" en la esquina superior izquierda para cambiar entre notaci√≥n italiana (Do, Re, Mi, Fa, Sol, La, Si) y notaci√≥n anglosajona (C, D, E, F, G, A, B). ¬°Todas las etiquetas, nombres de acordes y ejemplos se actualizar√°n autom√°ticamente!',
                helpIdentify: 'Identificar Acordes',
                helpIdentifyText: 'Haz clic en las teclas del piano para seleccionar notas, y el nombre del acorde aparecer√° autom√°ticamente abajo.',
                helpFind: 'üîç Encontrar Notas del Acorde',
                helpFindText: 'Escribe el nombre de un acorde en el campo de entrada y haz clic en "Mostrar Acorde" para ver qu√© teclas tocar. Ejemplos: <strong>Cmaj7</strong>, <strong>F#dim</strong>, <strong>Am</strong> (Anglosaj√≥n) o <strong>Domaj7</strong>, <strong>Fa#dim</strong>, <strong>Lam</strong> (Italiano).',
                helpFormats: 'üìù Formatos Soportados',
                helpFormatsText: 'Se admiten acordes mayores, menores, disminuidos, aumentados, suspendidos, power chords y acordes extendidos (7¬™, 9¬™, 11¬™, 13¬™). ¬°Funciona con ambos sistemas de notaci√≥n!',
                helpInfo: 'üìö Informaci√≥n del Acorde',
                helpInfoText: 'Haz clic en el bot√≥n "Info del Acorde" para aprender sobre las caracter√≠sticas del acorde, su uso en la m√∫sica, canciones famosas que lo utilizan y consejos para tocarlo en el piano.',
                helpOtherChords: 'üéπ Otros Acordes',
                helpOtherChordsText: 'El bot√≥n "Otros Acordes" se activa cuando seleccionas <strong>1 nota</strong> o <strong>3 notas</strong>. Con 1 nota, muestra todos los acordes que usan esa nota como t√≥nica. Con 3 notas, muestra todos los acordes que contienen esas notas. Haz <strong>clic</strong> en un acorde para previsualizarlo en azul en el piano. Haz <strong>doble clic</strong> para seleccionarlo.',
                helpClear: 'üóëÔ∏è Limpiar Selecci√≥n',
                helpClearText: 'Usa el bot√≥n "Limpiar Todo" para deseleccionar todas las teclas y comenzar de nuevo con una selecci√≥n limpia.',
                modalChordInfo: 'Informaci√≥n del Acorde',
                chordStructure: 'üéπ Estructura del Acorde',
                chordStructureNotes: 'Notas:',
                soundCharacteristics: 'üéµ Sonido y Caracter√≠sticas',
                keyAspects: 'üîç Aspectos Clave',
                commonUsage: 'üé∏ Uso Com√∫n',
                famousSongs: 'üé§ Canciones Famosas',
                chordProgressions: 'üéº Progresiones de Acordes',
                pianoTips: 'üí° Consejos para Piano',
                learnMore: 'üîé Aprende M√°s',
                learnMoreText: '¬øQuieres saber m√°s sobre',
                learnMoreResources: 'Consulta estos recursos gratuitos:',
                infoNotAvailable: 'Informaci√≥n no disponible'
            }
        };
        
        // Notation systems
        const notations = {
            anglo: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'],
            italian: ['Do', 'Do#', 'Re', 'Re#', 'Mi', 'Fa', 'Fa#', 'Sol', 'Sol#', 'La', 'La#', 'Si']
        };
        
        // Mapping between notations
        const angloToItalian = {
            'C': 'Do', 'C#': 'Do#', 'Db': 'Reb',
            'D': 'Re', 'D#': 'Re#', 'Eb': 'Mib',
            'E': 'Mi',
            'F': 'Fa', 'F#': 'Fa#', 'Gb': 'Solb',
            'G': 'Sol', 'G#': 'Sol#', 'Ab': 'Lab',
            'A': 'La', 'A#': 'La#', 'Bb': 'Sib',
            'B': 'Si'
        };
        
        const italianToAnglo = {
            'Do': 'C', 'Do#': 'C#', 'Reb': 'Db',
            'Re': 'D', 'Re#': 'D#', 'Mib': 'Eb',
            'Mi': 'E',
            'Fa': 'F', 'Fa#': 'F#', 'Solb': 'Gb',
            'Sol': 'G', 'Sol#': 'G#', 'Lab': 'Ab',
            'La': 'A', 'La#': 'A#', 'Sib': 'Bb',
            'Si': 'B'
        };
        
        let currentNotation = 'italian'; // 'anglo' or 'italian'
        let noteNames = [...notations.italian];
        let currentChord = null;

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'es' : 'en';
            updateLanguage();
        }

        function updateLanguage() {
            const t = translations[currentLanguage];
            
            // Update language button
            document.getElementById('languageBtn').textContent = currentLanguage === 'en' ? 'üá™üá∏' : 'üá¨üáß';
            
            // Update header
            document.getElementById('headerTitle').textContent = t.headerTitle;
            document.getElementById('helpBtn').textContent = t.helpBtn;
            
            // Update main sections
            document.getElementById('chordInputTitle').textContent = t.chordInputTitle;
            document.getElementById('showChordBtn').textContent = t.showChordBtn;
            document.getElementById('pianoTitle').textContent = t.pianoTitle;
            document.getElementById('clearBtn').textContent = t.clearBtn;
            document.getElementById('insightsBtn').textContent = 'üìö ' + t.insightsBtn;
            document.getElementById('otherChordsBtn').textContent = 'üéπ ' + t.otherChordsBtn;
            
            // Update placeholder
            const input = document.getElementById('chordInput');
            input.placeholder = currentNotation === 'italian' ? t.placeholderItalian : t.placeholderAnglo;
            
            // Update default chord info if no chord is selected
            if (selectedNotes.size === 0) {
                updateChordInfo(t.defaultChordName, t.defaultChordNotes, t.defaultChordType);
            } else {
                // Re-identify current chord to update text
                identifyChord();
            }
            
            // Update help modal content
            updateHelpModal();
        }

        function updateHelpModal() {
            const t = translations[currentLanguage];
            const helpModal = document.getElementById('helpModal');
            const modalContent = helpModal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>${t.modalHelpTitle}</h2>
                    <button class="close" onclick="closeHelpModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="insight-section">
                        <h3>${t.helpNotation}</h3>
                        <p>${t.helpNotationText}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.helpIdentify}</h3>
                        <p>${t.helpIdentifyText}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.helpFind}</h3>
                        <p>${t.helpFindText}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.helpFormats}</h3>
                        <p>${t.helpFormatsText}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.helpInfo}</h3>
                        <p>${t.helpInfoText}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.helpOtherChords}</h3>
                        <p>${t.helpOtherChordsText}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.helpClear}</h3>
                        <p>${t.helpClearText}</p>
                    </div>
                </div>
            `;
        }

        // Comprehensive chord database
        const chordDatabase = {
            // Major chords
            'maj': [0, 4, 7],
            'M': [0, 4, 7],
            '': [0, 4, 7], // Default major
            
            // Minor chords
            'm': [0, 3, 7],
            'min': [0, 3, 7],
            '-': [0, 3, 7],
            
            // Power chords (5th chords)
            '5': [0, 7],
            'pow': [0, 7],
            
            // Dominant 7th
            '7': [0, 4, 7, 10],
            'dom7': [0, 4, 7, 10],
            
            // Major 7th
            'maj7': [0, 4, 7, 11],
            'M7': [0, 4, 7, 11],
            '‚ñ≥7': [0, 4, 7, 11],
            
            // Minor 7th
            'm7': [0, 3, 7, 10],
            'min7': [0, 3, 7, 10],
            '-7': [0, 3, 7, 10],
            
            // Diminished
            'dim': [0, 3, 6],
            '¬∞': [0, 3, 6],
            'o': [0, 3, 6],
            
            // Diminished 7th
            'dim7': [0, 3, 6, 9],
            '¬∞7': [0, 3, 6, 9],
            'o7': [0, 3, 6, 9],
            
            // Half-diminished
            'm7b5': [0, 3, 6, 10],
            '√∏7': [0, 3, 6, 10],
            
            // Augmented
            'aug': [0, 4, 8],
            '+': [0, 4, 8],
            
            // Suspended
            'sus2': [0, 2, 7],
            'sus4': [0, 5, 7],
            
            // 6th chords
            '6': [0, 4, 7, 9],
            'm6': [0, 3, 7, 9],
            
            // 9th chords
            '9': [0, 4, 7, 10, 14],
            'maj9': [0, 4, 7, 11, 14],
            'M9': [0, 4, 7, 11, 14],
            'm9': [0, 3, 7, 10, 14],
            'min9': [0, 3, 7, 10, 14],
            
            // 11th chords
            '11': [0, 4, 7, 10, 14, 17],
            'maj11': [0, 4, 7, 11, 14, 17],
            'M11': [0, 4, 7, 11, 14, 17],
            'm11': [0, 3, 7, 10, 14, 17],
            'min11': [0, 3, 7, 10, 14, 17],
            
            // 13th chords
            '13': [0, 4, 7, 10, 14, 17, 21],
            'maj13': [0, 4, 7, 11, 14, 17, 21],
            'M13': [0, 4, 7, 11, 14, 17, 21],
            'm13': [0, 3, 7, 10, 14, 17, 21],
            'min13': [0, 3, 7, 10, 14, 17, 21],
            
            // Add chords
            'add9': [0, 4, 7, 14],
            'madd9': [0, 3, 7, 14],
            'add11': [0, 4, 7, 17],
            'madd11': [0, 3, 7, 17],
            
            // Altered chords
            '7#5': [0, 4, 8, 10],
            '7b5': [0, 4, 6, 10],
            '7#9': [0, 4, 7, 10, 15],
            '7b9': [0, 4, 7, 10, 13],
            '7#11': [0, 4, 7, 10, 18],
            
            // Minor variations
            'm7#5': [0, 3, 8, 10],
            'm7b5': [0, 3, 6, 10],
            'mmaj7': [0, 3, 7, 11],
            'm(maj7)': [0, 3, 7, 11],
            
            // Sus variations
            '7sus2': [0, 2, 7, 10],
            '7sus4': [0, 5, 7, 10],
            'maj7sus2': [0, 2, 7, 11],
            'maj7sus4': [0, 5, 7, 11]
        };

        // Reverse lookup for chord identification
        const intervalPatterns = {};
        Object.keys(chordDatabase).forEach(chordType => {
            const intervals = chordDatabase[chordType];
            const key = intervals.slice().sort().join(',');
            if (!intervalPatterns[key]) {
                intervalPatterns[key] = [];
            }
            intervalPatterns[key].push(chordType);
        });

        function toggleNotation() {
            const oldNotation = currentNotation;
            
            // Convert selected notes to new notation
            const convertedNotes = new Set();
            selectedNotes.forEach(noteWithOctave => {
                // Extract note name and octave (e.g., "Sol3" -> "Sol" + "3", "Do#4" -> "Do#" + "4")
                const match = noteWithOctave.match(/^(.+?)(\d+)$/);
                if (!match) return;
                
                const noteName = match[1];
                const octave = match[2];
                
                // Find the index in current notation
                const oldNoteNames = notations[oldNotation];
                const noteIndex = oldNoteNames.indexOf(noteName);
                
                if (noteIndex !== -1) {
                    // Get the corresponding note in new notation
                    const newNotation = oldNotation === 'anglo' ? 'italian' : 'anglo';
                    const newNoteNames = notations[newNotation];
                    const newNoteName = newNoteNames[noteIndex];
                    convertedNotes.add(newNoteName + octave);
                }
            });
            
            // Clear old selection
            selectedNotes.clear();
            convertedNotes.forEach(note => selectedNotes.add(note));
            
            // Switch notation
            currentNotation = currentNotation === 'anglo' ? 'italian' : 'anglo';
            noteNames = [...notations[currentNotation]];
            
            // Update button text
            const notationText = document.getElementById('notationText');
            notationText.textContent = currentNotation === 'anglo' ? 'Do#, Mib' : 'C#, Eb';
            
            // Update placeholder
            const t = translations[currentLanguage];
            const input = document.getElementById('chordInput');
            if (currentNotation === 'italian') {
                input.placeholder = t.placeholderItalian;
            } else {
                input.placeholder = t.placeholderAnglo;
            }
            
            // Update all piano key labels and reselect keys
            updatePianoLabels();
            
            // Re-apply active class to converted notes
            document.querySelectorAll('.white-key, .black-key').forEach(key => {
                if (selectedNotes.has(key.dataset.note)) {
                    key.classList.add('active');
                } else {
                    key.classList.remove('active');
                }
            });
            
            // Update current chord display if there's one
            if (selectedNotes.size > 0) {
                identifyChord();
            } else {
                const defaultTexts = currentNotation === 'italian' 
                    ? ['Selecciona notas o introduce un acorde', 'Haz clic en las teclas del piano o escribe un nombre de acorde', '¬°Listo para ayudarte a identificar acordes!']
                    : ['Select notes or enter a chord name', 'Click piano keys above or type a chord name', 'Ready to help you identify chords!'];
                updateChordInfo(...defaultTexts);
            }
        }

        function updatePianoLabels() {
            // Update all key labels on the piano
            document.querySelectorAll('.white-key, .black-key').forEach(key => {
                const noteIndex = parseInt(key.dataset.noteIndex);
                const label = key.querySelector('.key-label');
                if (label) {
                    label.textContent = noteNames[noteIndex];
                }
                // Update the full note name in the dataset
                // Extract octave from the current note name (e.g., "Sol3" -> "3", "Do#4" -> "4")
                const match = key.dataset.note.match(/\d+$/);
                const octave = match ? match[0] : '';
                key.dataset.note = `${noteNames[noteIndex]}${octave}`;
            });
        }

        function convertNoteName(name, fromNotation, toNotation) {
            if (fromNotation === toNotation) return name;
            
            const map = fromNotation === 'anglo' ? angloToItalian : italianToAnglo;
            return map[name] || name;
        }

        function createPiano() {
            const piano = document.getElementById('piano');
            piano.innerHTML = '';
            
            // Create 3 octaves starting from C3
            for (let octave = 3; octave <= 5; octave++) {
                const octaveDiv = document.createElement('div');
                octaveDiv.className = 'octave';
                
                // White keys
                const whiteKeyPattern = [0, 2, 4, 5, 7, 9, 11]; // C, D, E, F, G, A, B
                whiteKeyPattern.forEach((noteIndex, keyIndex) => {
                    const key = document.createElement('div');
                    key.className = 'white-key';
                    const noteName = noteNames[noteIndex];
                    const fullNoteName = `${noteName}${octave}`;
                    key.dataset.note = fullNoteName;
                    key.dataset.noteIndex = noteIndex;
                    
                    const label = document.createElement('div');
                    label.className = 'key-label';
                    label.textContent = noteName;
                    key.appendChild(label);
                    
                    // Use a function that reads the current dataset.note value
                    key.addEventListener('click', function() {
                        toggleNote(this.dataset.note, this);
                    });
                    octaveDiv.appendChild(key);
                });
                
                // Black keys
                const blackKeyPattern = [1, 3, 6, 8, 10]; // C#, D#, F#, G#, A#
                // Position represents the white key whose right border we center on
                // C# after C (1), D# after D (2), F# after F (4), G# after G (5), A# after A (6)
                const blackKeyPositions = [1, 2, 4, 5, 6];
                
                blackKeyPattern.forEach((noteIndex, i) => {
                    const key = document.createElement('div');
                    key.className = 'black-key';
                    const noteName = noteNames[noteIndex];
                    const fullNoteName = `${noteName}${octave}`;
                    key.dataset.note = fullNoteName;
                    key.dataset.noteIndex = noteIndex;
                    
                    const label = document.createElement('div');
                    label.className = 'key-label';
                    label.textContent = noteName;
                    key.appendChild(label);
                    
                    // Store position data for later calculation
                    key.dataset.blackKeyPosition = blackKeyPositions[i];
                    
                    // Use a function that reads the current dataset.note value
                    key.addEventListener('click', function() {
                        toggleNote(this.dataset.note, this);
                    });
                    octaveDiv.appendChild(key);
                });
                
                piano.appendChild(octaveDiv);
            }
            
            // Position black keys after all elements are in the DOM
            requestAnimationFrame(() => {
                positionBlackKeys();
            });
        }
        
        function positionBlackKeys() {
            const whiteKeys = document.querySelectorAll('.white-key');
            const blackKeys = document.querySelectorAll('.black-key');
            
            if (whiteKeys.length === 0 || blackKeys.length === 0) return;
            
            // Get actual computed widths
            const whiteKeyWidth = whiteKeys[0].offsetWidth;
            const blackKeyWidth = blackKeys[0].offsetWidth;
            
            // Position each black key centered between white keys
            // position represents which white key border to center on (0.5 = border between 1st and 2nd key)
            blackKeys.forEach(key => {
                const position = parseFloat(key.dataset.blackKeyPosition);
                const leftPosition = (position * whiteKeyWidth) - (blackKeyWidth / 2);
                key.style.left = `${leftPosition}px`;
            });
        }
        
        // Reposition on window resize for responsive behavior
        window.addEventListener('resize', () => {
            positionBlackKeys();
        });

        function toggleNote(noteName, keyElement) {
            if (selectedNotes.has(noteName)) {
                selectedNotes.delete(noteName);
                keyElement.classList.remove('active');
            } else {
                selectedNotes.add(noteName);
                keyElement.classList.add('active');
            }
            
            identifyChord();
        }

        function identifyChord() {
            const insightsBtn = document.getElementById('insightsBtn');
            const otherChordsBtn = document.getElementById('otherChordsBtn');
            const t = translations[currentLanguage];
            
            if (selectedNotes.size === 0) {
                updateChordInfo(t.defaultChordName, t.defaultChordNotes, t.defaultChordType);
                currentChord = null;
                insightsBtn.classList.remove('active');
                otherChordsBtn.classList.remove('active');
                return;
            }

            const noteIndexes = Array.from(selectedNotes).map(note => {
                // Extract note name by removing the octave number at the end
                const noteName = note.replace(/\d+$/, '');
                return noteNames.indexOf(noteName);
            }).sort((a, b) => a - b);

            // Activate "Otros Acordes" button only when 1 or 3 notes are selected
            if (noteIndexes.length === 1 || noteIndexes.length === 3) {
                otherChordsBtn.classList.add('active');
            } else {
                otherChordsBtn.classList.remove('active');
            }

            if (noteIndexes.length < 2) {
                const noteName = noteNames[noteIndexes[0]];
                updateChordInfo(noteName, t.singleNote, t.addMoreNotes);
                currentChord = null;
                insightsBtn.classList.remove('active');
                return;
            }

            // Try each note as a potential root
            let foundChord = null;
            
            for (let i = 0; i < noteIndexes.length; i++) {
                const root = noteIndexes[i];
                const intervals = noteIndexes.map(note => (note - root + 12) % 12).sort();
                
                // Look up chord pattern
                const patternKey = intervals.join(',');
                const possibleChords = intervalPatterns[patternKey];
                
                if (possibleChords && possibleChords.length > 0) {
                    foundChord = {
                        root: root,
                        intervals: intervals,
                        chordType: possibleChords[0],
                        alternativeNames: possibleChords.slice(1) // Store alternative names
                    };
                    break; // Found a match, stop searching
                }
            }
            
            if (foundChord) {
                const rootNote = noteNames[foundChord.root];
                const chordType = foundChord.chordType;
                let chordName = rootNote + chordType;
                
                // Add alternative names in parentheses if they exist
                if (foundChord.alternativeNames && foundChord.alternativeNames.length > 0) {
                    const altNames = foundChord.alternativeNames.map(alt => rootNote + alt).join(', ');
                    chordName += ` (${altNames})`;
                }
                
                const notes = foundChord.intervals.map(interval => noteNames[(foundChord.root + interval) % 12]).join(', ');
                const description = getChordDescription(chordType);
                
                updateChordInfo(chordName, `${t.notes}: ${notes}`, description);
                
                // Store the chord with the anglo root for internal processing
                const angloNoteNames = notations.anglo;
                const angloRoot = currentNotation === 'italian' ? (italianToAnglo[rootNote] || rootNote) : rootNote;
                currentChord = { name: chordName, root: angloRoot, type: chordType };
                insightsBtn.classList.add('active');
            } else {
                const notes = noteIndexes.map(note => noteNames[note]).join(', ');
                updateChordInfo(t.unknownChord, `${t.notes}: ${notes}`, t.noMatch);
                currentChord = null;
                insightsBtn.classList.remove('active');
            }
        }

        function getChordDescription(chordType) {
            const descriptions = {
                'maj': 'Major triad',
                'M': 'Major triad',
                '': 'Major triad',
                'm': 'Minor triad',
                'min': 'Minor triad',
                '-': 'Minor triad',
                '5': 'Power chord (5th)',
                'pow': 'Power chord (5th)',
                '7': 'Dominant 7th',
                'maj7': 'Major 7th',
                'M7': 'Major 7th',
                'm7': 'Minor 7th',
                'dim': 'Diminished triad',
                'dim7': 'Diminished 7th',
                'm7b5': 'Half-diminished 7th',
                'aug': 'Augmented triad',
                'sus2': 'Suspended 2nd',
                'sus4': 'Suspended 4th',
                '6': 'Major 6th',
                'm6': 'Minor 6th',
                '9': 'Dominant 9th',
                'maj9': 'Major 9th',
                'M9': 'Major 9th',
                'm9': 'Minor 9th',
                '11': 'Dominant 11th',
                'maj11': 'Major 11th',
                'M11': 'Major 11th',
                'm11': 'Minor 11th',
                '13': 'Dominant 13th',
                'maj13': 'Major 13th',
                'M13': 'Major 13th',
                'm13': 'Minor 13th',
                'add9': 'Add 9th',
                'madd9': 'Minor add 9th',
                'add11': 'Add 11th',
                'madd11': 'Minor add 11th',
                '7#5': 'Dominant 7th sharp 5',
                '7b5': 'Dominant 7th flat 5',
                '7#9': 'Dominant 7th sharp 9',
                '7b9': 'Dominant 7th flat 9',
                '7#11': 'Dominant 7th sharp 11',
                'mmaj7': 'Minor major 7th',
                'm(maj7)': 'Minor major 7th',
                '7sus2': 'Dominant 7th sus2',
                '7sus4': 'Dominant 7th sus4'
            };
            return descriptions[chordType] || 'Complex chord';
        }

        function findChord() {
            const input = document.getElementById('chordInput').value.trim();
            const insightsBtn = document.getElementById('insightsBtn');
            const t = translations[currentLanguage];
            
            if (!input) return;

            const result = parseChordName(input);
            if (!result) {
                updateChordInfo(t.invalidChord, `"${input}" ${t.isNotRecognized}`, t.tryFormats);
                currentChord = null;
                insightsBtn.classList.remove('active');
                return;
            }

            const { root, chordType } = result;
            const intervals = chordDatabase[chordType];
            
            if (intervals) {
                // Clear previous selection
                clearSelection();
                
                // Calculate and select notes (using anglo notation internally)
                const angloNoteNames = notations.anglo;
                const rootIndex = angloNoteNames.indexOf(root);
                const chordNotesAnglo = intervals.map(interval => {
                    const noteIndex = (rootIndex + interval) % 12;
                    return angloNoteNames[noteIndex];
                });
                
                // Convert notes to current notation for display
                const chordNotesDisplay = chordNotesAnglo.map(note => 
                    currentNotation === 'italian' ? (angloToItalian[note] || note) : note
                );
                
                // Select notes on piano (looking for any octave)
                chordNotesAnglo.forEach((angloNote, idx) => {
                    const displayNote = chordNotesDisplay[idx];
                    for (let octave = 3; octave <= 5; octave++) {
                        const fullNoteName = `${displayNote}${octave}`;
                        const keyElement = document.querySelector(`[data-note="${fullNoteName}"]`);
                        if (keyElement && !selectedNotes.has(fullNoteName)) {
                            selectedNotes.add(fullNoteName);
                            keyElement.classList.add('active');
                            break; // Only select first occurrence
                        }
                    }
                });
                
                // Convert chord name to current notation
                const rootDisplay = currentNotation === 'italian' ? (angloToItalian[root] || root) : root;
                const chordName = rootDisplay + chordType;
                const description = getChordDescription(chordType);
                updateChordInfo(chordName, `${t.notes}: ${chordNotesDisplay.join(', ')}`, description);
                currentChord = { name: chordName, root: root, type: chordType };
                insightsBtn.classList.add('active');
            } else {
                updateChordInfo(t.unknownChordType, `${t.chordTypeNotFound} "${chordType}"`, t.tryCommonTypes);
                currentChord = null;
                insightsBtn.classList.remove('active');
            }
        }

        function parseChordName(chordName) {
            // Remove spaces and convert to standard format
            chordName = chordName.replace(/\s/g, '');

            let root = null;
            let chordType = '';
            
            // Try to match Italian notation first (Do, Re, Mi, Fa, Sol, La, Si)
            const italianMatch = chordName.match(/^(Do|Re|Mi|Fa|Sol|La|Si)([#b]?)/i);
            if (italianMatch) {
                const italianNote = italianMatch[1].charAt(0).toUpperCase() + italianMatch[1].slice(1).toLowerCase();
                const accidental = italianMatch[2];
                const fullItalianNote = italianNote + accidental;
                
                // Convert to Anglo notation for internal processing
                root = italianToAnglo[fullItalianNote] || italianToAnglo[italianNote];
                chordType = chordName.slice(italianMatch[0].length);
            } else {
                // Try Anglo notation (A-G)
                const angloMatch = chordName.match(/^([A-G][#b]?)/);
                if (!angloMatch) return null;
                
                root = angloMatch[1];
                chordType = chordName.slice(root.length);
            }

            if (!root) return null;

            // Convert flats to sharps for consistency
            const normalizedRoot = root.replace('Db', 'C#').replace('Eb', 'D#').replace('Gb', 'F#')
                                      .replace('Ab', 'G#').replace('Bb', 'A#');

            // Check if chord type exists
            if (chordDatabase.hasOwnProperty(chordType)) {
                return { root: normalizedRoot, chordType };
            }

            return null;
        }

        function clearAll() {
            const t = translations[currentLanguage];
            clearSelection();
            document.getElementById('chordInput').value = '';
            updateChordInfo(t.defaultChordName, t.defaultChordNotes, t.defaultChordType);
            currentChord = null;
            document.getElementById('insightsBtn').classList.remove('active');
            document.getElementById('otherChordsBtn').classList.remove('active');
        }

        function clearSelection() {
            selectedNotes.clear();
            document.querySelectorAll('.white-key, .black-key').forEach(key => {
                key.classList.remove('active');
            });
        }

        function updateChordInfo(name, notes, type) {
            const chordNameElement = document.querySelector('.chord-name');
            
            // Check if name contains alternative names in parentheses
            if (name.includes('(') && name.includes(')')) {
                // Split the name into main part and alternatives
                const mainPart = name.substring(0, name.indexOf('(')).trim();
                const altPart = name.substring(name.indexOf('('));
                // Use innerHTML to style alternatives with normal font-weight
                chordNameElement.innerHTML = `${mainPart} <span style="font-weight: normal;">${altPart}</span>`;
            } else {
                chordNameElement.textContent = name;
            }
            
            document.querySelector('.chord-notes').textContent = notes;
            document.querySelector('.chord-type').textContent = type;
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }


        function showChordInfo() {
            if (!currentChord) return;
            
            const t = translations[currentLanguage];
            const modal = document.getElementById('insightsModal');
            const modalChordName = document.getElementById('modalChordName');
            const modalBody = document.getElementById('modalBody');
            
            modalChordName.textContent = `${currentChord.name} - ${t.modalChordInfo}`;
            modal.style.display = 'block';
            
            // Get chord information from our database
            const chordInfo = getChordInfo(currentChord);

                modalBody.innerHTML = `
                    <div class="insight-section">
                    <h3>${t.chordStructure}</h3>
                    <p><strong>${t.chordStructureNotes}</strong> ${chordInfo.notes || t.infoNotAvailable}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.soundCharacteristics}</h3>
                    <p>${chordInfo.characteristics}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.keyAspects}</h3>
                    <p>${chordInfo.keyAspects}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.commonUsage}</h3>
                    <p>${chordInfo.commonUsage}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.famousSongs}</h3>
                    <p>${chordInfo.famousSongs}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.chordProgressions}</h3>
                    <p>${chordInfo.progressions}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.pianoTips}</h3>
                    <p>${chordInfo.tips}</p>
                    </div>

                    <div class="insight-section">
                    <h3>${t.learnMore}</h3>
                    <p>${t.learnMoreText} ${currentChord.name}? ${t.learnMoreResources}</p>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                        <button onclick="openChordBook('${currentChord.name}')" class="clear-btn" style="padding:8px 14px; font-size:0.95em; background: #f8f9fa; color:#333; border:1px solid #ddd;">üéπ Piano Chords</button>
                        <button onclick="openPerplexity('${currentChord.name}')" class="insights-btn active" style="padding:8px 14px; font-size:0.95em; background: #9c27b0; color: white;">ü§ñ Perplexity AI</button>
                        <button onclick="openGrok('${currentChord.name}')" class="insights-btn active" style="padding:8px 14px; font-size:0.95em; background: #00bcd4; color: white;">üß† Grok AI</button>
                        <button onclick="openWikipedia('${currentChord.name}')" class="insights-btn active" style="padding:8px 14px; font-size:0.95em;">üìñ Wikipedia</button>
                        </div>
                    </div>
                `;
        }

        // Chord information database - English
        const chordInfoDatabase_en = {
            // Major chords
            'maj': {
                notes: 'Root + 3M + 5',
                characteristics: 'Bright, stable and consonant sound that forms the foundation of most Western music. It has a sense of resolution and completeness.',
                keyAspects: 'The major third interval creates brightness and stability. Often called the "happy" chord.',
                commonUsage: 'Used as tonic chords (I) in major keys, dominant chords (V) in other keys, and as stable harmonies in pop, rock, classical, and jazz.',
                famousSongs: '"Let It Be" by The Beatles (C major), "Stairway to Heaven" by Led Zeppelin (A major), "Imagine" by John Lennon (C major).',
                progressions: 'I-IV-V-I (the most common progression), I-vi-IV-V, I-V-vi-IV, ii-V-I (jazz turnaround).',
                tips: 'Play root position first, then try first inversion (third in bass) for smoother voice leading. Add 6th for color or 9th for jazz feel.'
            },
            '': {
                notes: 'Root + 3M + 5',
                characteristics: 'Bright, stable and consonant sound that forms the foundation of most Western music. It has a sense of resolution and completeness.',
                keyAspects: 'The major third interval creates brightness and stability. Often called the "happy" chord.',
                commonUsage: 'Used as tonic chords (I) in major keys, dominant chords (V) in other keys, and as stable harmonies in pop, rock, classical, and jazz.',
                famousSongs: '"Let It Be" by The Beatles (C major), "Stairway to Heaven" by Led Zeppelin (A major), "Imagine" by John Lennon (C major).',
                progressions: 'I-IV-V-I (the most common progression), I-vi-IV-V, I-V-vi-IV, ii-V-I (jazz turnaround).',
                tips: 'Play root position first, then try first inversion (third in bass) for smoother voice leading. Add 6th for color or 9th for jazz feel.'
            },

            // Minor chords
            'm': {
                notes: 'Root + 3m + 5',
                characteristics: 'Darker, more emotional sound with a melancholic or serious quality. Less stable than major chords.',
                keyAspects: 'The minor third creates emotional depth and tension. Often called the "sad" chord.',
                commonUsage: 'Used as tonic chords (i) in minor keys, vi chords in major keys, and for emotional expression in ballads, rock, and classical.',
                famousSongs: '"Stairway to Heaven" by Led Zeppelin (Am), "Nothing Else Matters" by Metallica (Em), "Hurt" by Johnny Cash (Am).',
                progressions: 'i-IV-V-i (minor blues), i-iv-i (minor tonic), i-VI-III-VII (harmonic minor), vi-IV-I-V (pop ballad).',
                tips: 'Try different voicings - root position, first inversion, or second inversion. Add 7th for more tension or 9th for jazz minor.'
            },
            'min': {
                notes: 'Root + 3m + 5',
                characteristics: 'Darker, more emotional sound with a melancholic or serious quality. Less stable than major chords.',
                keyAspects: 'The minor third creates emotional depth and tension. Often called the "sad" chord.',
                commonUsage: 'Used as tonic chords (i) in minor keys, vi chords in major keys, and for emotional expression in ballads, rock, and classical.',
                famousSongs: '"Stairway to Heaven" by Led Zeppelin (Am), "Nothing Else Matters" by Metallica (Em), "Hurt" by Johnny Cash (Am).',
                progressions: 'i-IV-V-i (minor blues), i-iv-i (minor tonic), i-VI-III-VII (harmonic minor), vi-IV-I-V (pop ballad).',
                tips: 'Try different voicings - root position, first inversion, or second inversion. Add 7th for more tension or 9th for jazz minor.'
            },
            '-': {
                notes: 'Root + 3m + 5',
                characteristics: 'Darker, more emotional sound with a melancholic or serious quality. Less stable than major chords.',
                keyAspects: 'The minor third creates emotional depth and tension. Often called the "sad" chord.',
                commonUsage: 'Used as tonic chords (i) in minor keys, vi chords in major keys, and for emotional expression in ballads, rock, and classical.',
                famousSongs: '"Stairway to Heaven" by Led Zeppelin (Am), "Nothing Else Matters" by Metallica (Em), "Hurt" by Johnny Cash (Am).',
                progressions: 'i-IV-V-i (minor blues), i-iv-i (minor tonic), i-VI-III-VII (harmonic minor), vi-IV-I-V (pop ballad).',
                tips: 'Try different voicings - root position, first inversion, or second inversion. Add 7th for more tension or 9th for jazz minor.'
            },

            // Dominant 7th
            '7': {
                notes: 'Root + 3M + 5 + 7m',
                characteristics: 'Tense, directional sound that strongly pulls toward resolution. Has a bluesy, sophisticated quality.',
                keyAspects: 'The minor seventh creates strong tension that demands resolution, usually to the tonic.',
                commonUsage: 'Used as dominant chords (V7) in major keys, for blues progressions, and jazz harmony. Creates strong cadential movement.',
                famousSongs: '"Hit the Road Jack" by Ray Charles (C7), "Satin Doll" by Duke Ellington (Bb7), "All Blues" by Miles Davis (Bb7).',
                progressions: 'I7-IV7-V7-I7 (blues), ii7-V7-Imaj7 (jazz ii-V-I), V7-I (perfect cadence), I-VI7-II7-V7 (ragtime).',
                tips: 'Emphasize the 7th and 3rd in your voicing. Try drop-2 voicings for jazz comping. Resolve the 7th down to the 3rd of the next chord.'
            },

            // Major 7th
            'maj7': {
                notes: 'Root + 3M + 5 + 7M',
                characteristics: 'Smooth, sophisticated sound with a dreamy, suspended quality. Less tense than dominant 7th.',
                keyAspects: 'The major seventh adds color and sophistication without strong directional pull.',
                commonUsage: 'Used in jazz as tonic chords (Imaj7), pop for sophisticated harmony, and classical for added color.',
                famousSongs: '"What a Wonderful World" by Louis Armstrong (Imaj7), "Autumn Leaves" by Joseph Kosma (Amaj7), "Blue Bossa" by Kenny Dorham (Cmaj7).',
                progressions: 'Imaj7-vi7-ii7-V7 (jazz), Imaj7-IVmaj7-IImaj7-V7, I-VIImaj7-III7-VImaj7 (extended jazz).',
                tips: 'Voice the major 7th on top for brightness. Try close voicings or spread voicings. Works well as polychords over other harmonies.'
            },

            // Minor 7th
            'm7': {
                notes: 'Root + 3m + 5 + 7m',
                characteristics: 'Warm, relaxed sound with subtle tension. More sophisticated than plain minor.',
                keyAspects: 'Combines minor triad with minor seventh for smooth, jazzy quality.',
                commonUsage: 'Used as ii7 chords in major keys, i7 in minor keys, and for smooth jazz harmony.',
                famousSongs: '"Take Five" by Dave Brubeck (Em7), "So What" by Miles Davis (Dm7), "Blue in Green" by Bill Evans (Am7).',
                progressions: 'ii7-V7-Imaj7 (most common jazz progression), i7-iv7-VII7, Dm7-G7-Cmaj7 (classic ii-V-I).',
                tips: 'Try shell voicings (root, 3rd, 7th) for comping. Use as passing chords between more stable harmonies.'
            },

            // Diminished
            'dim': {
                notes: 'Root + 3m + 5b',
                characteristics: 'Unstable, tense sound with mysterious, dramatic quality. Highly dissonant.',
                keyAspects: 'Symmetrical structure allows for multiple interpretations. Strong sense of needing resolution.',
                commonUsage: 'Used as leading-tone chords (vii¬∞) toward tonic, passing chords, and for dramatic effect.',
                famousSongs: '"The Entertainer" by Scott Joplin (multiple dim chords), "Giant Steps" by John Coltrane (as passing chords), "Caravan" by Duke Ellington.',
                progressions: 'vii¬∞-I (authentic cadence in minor), I-II¬∞-III-IV¬∞-V, as passing chords between major/minor chords.',
                tips: 'Play softly and resolve quickly. Try different inversions - each has different tension levels. Great for transitions.'
            },

            // Diminished 7th
            'dim7': {
                notes: 'Root + 3m + 5b + 7bb',
                characteristics: 'Highly tense, ambiguous sound that can resolve to any chord a half-step away.',
                keyAspects: 'Symmetrical structure (minor thirds) creates maximum tension and multiple resolution possibilities.',
                commonUsage: 'Used as passing chords, for chromatic movement, and in classical and jazz for dramatic effect.',
                famousSongs: '"Misty" by Erroll Garner (as passing chord), "Cherokee" by Ray Noble (chromatic approach), "Giant Steps" by John Coltrane.',
                progressions: 'V7-#IV¬∞7-#iv¬∞7-iii7, as approach chords to any target, I7-II7-III7-IV7 (whole-tone scale).',
                tips: 'Resolve to chords a half-step above or below. Try different voicings to emphasize different notes as resolution targets.'
            },

            // Minor 7th flat 5 (half-diminished)
            'm7b5': {
                notes: 'Root + 3m + 5b + 7m',
                characteristics: 'Tense, sophisticated sound with bluesy and jazzy qualities. Less harsh than full diminished.',
                keyAspects: 'Combines minor triad with diminished fifth and minor seventh. Creates strong pull toward resolution.',
                commonUsage: 'Used as ii√∏7 in minor keys, for jazz harmony, and as passing chords.',
                famousSongs: '"Autumn Leaves" by Joseph Kosma (D√∏7), "There Will Never Be Another You" (ii√∏7-V7-i), "Stella by Starlight" (multiple √∏7 chords).',
                progressions: 'ii√∏7-V7-i (jazz minor), i-ii√∏7-V7-i, IV-VII√∏7-III7-VI7 (harmonic minor).',
                tips: 'Voice with the b5 on top for tension. Resolve 7th down to 3rd, b5 up to 5th. Essential for jazz harmony.'
            },

            // Augmented
            'aug': {
                notes: 'Root + 3M + 5#',
                characteristics: 'Bright, ambiguous sound with floating, unresolved quality. Creates tension without direction.',
                keyAspects: 'Symmetrical augmented fifth creates ambiguity - can sound like major or minor depending on context.',
                commonUsage: 'Used as passing chords, for modulation, and in impressionist classical music.',
                famousSongs: '"The Simpsons" theme (Caug as passing chord), "Giant Steps" by Coltrane (augmented approaches), "Black Narcissus" by Joe Henderson.',
                progressions: 'I+ - #IV¬∞ - bVII, as passing between major chords, III+ - vi - IV (impressionist).',
                tips: 'Use as approach chords to other harmonies. The augmented fifth can resolve up or down chromatically.'
            },

            // Suspended chords
            'sus2': {
                notes: 'Root + 2M + 5',
                characteristics: 'Open, ethereal sound with subtle tension. Less directional than sus4.',
                keyAspects: 'Replaces the third with a second, creating an open, ambiguous quality.',
                commonUsage: 'Used in pop and rock for atmospheric sounds, as approach chords, and for modern harmony.',
                famousSongs: '"Dust in the Wind" by Kansas (Gsus2), "Horse with No Name" by America (sus2 chords), "More Than Words" by Extreme.',
                progressions: 'I-sus2-I (resolution), I-IIIsus2-IV-V, sus2 as passing chords between major/minor.',
                tips: 'Resolve the 2nd up to 3rd for smooth resolution. Try adding 4th on top for 6/9 sound. Great for intros and bridges.'
            },

            'sus4': {
                notes: 'Root + 4M + 5',
                characteristics: 'Tense, anticipatory sound that strongly pulls toward resolution. More directional than sus2.',
                keyAspects: 'Replaces the third with a fourth, creating strong tension that demands resolution.',
                commonUsage: 'Used in rock, pop, and folk for rhythmic interest and as approach chords.',
                famousSongs: '"Dream On" by Aerosmith (Dsus4), "Let It Be" by The Beatles (sus4 resolutions), "Under the Bridge" by Red Hot Chili Peppers.',
                progressions: 'I-sus4-I (classic resolution), I-IV-sus4-IV-I, V-sus4-V-I, ii-sus4-ii-V.',
                tips: 'Resolve the 4th down to 3rd for strong resolution. Use on beats 2 and 4 in rhythm. Add 7th for more tension.'
            },

            // 6th chords
            '6': {
                notes: 'Root + 3M + 5 + 6M',
                characteristics: 'Bright, colorful sound with added sweetness and stability. More complex than major triad.',
                keyAspects: 'Adds the sixth for color while maintaining major quality. Less tense than 7th chords.',
                commonUsage: 'Used in classical music, jazz, and pop for added color and as tonic chords with sophistication.',
                famousSongs: '"Michelle" by The Beatles (A6), "It Had to Be You" (6th chords in bridge), "My Funny Valentine" (6th approach).',
                progressions: 'I6-IV-I, I6-ii7-V7-I, as substitute for I chord in major keys.',
                tips: 'Try first inversion (6th in bass) for smoother voice leading. Use as approach to dominant chords.'
            },

            'm6': {
                notes: 'Root + 3m + 5 + 6M',
                characteristics: 'Rich, emotional sound with bittersweet quality. More complex than minor triad.',
                keyAspects: 'Combines minor triad with major sixth for unique, melancholic color.',
                commonUsage: 'Used in classical music, jazz, and as substitute for i chords in minor keys.',
                famousSongs: '"Autumn Leaves" by Joseph Kosma (Am6), "Cry Me a River" by Arthur Hamilton, "Blackbird" by The Beatles.',
                progressions: 'i6-VI7-V7-i, i6-iv-i, as passing chords in minor keys.',
                tips: 'Voice the 6th on top for brightness. Try different inversions for color variations.'
            },

            // 9th chords
            '9': {
                notes: 'Root + 3M + 5 + 7m + 9M',
                characteristics: 'Rich, complex sound with added tension and sophistication. Highly colorful.',
                keyAspects: 'Adds the 9th (major ninth) for extended harmony. Creates lush, jazzy quality.',
                commonUsage: 'Used in jazz and sophisticated pop as dominant chords with added color.',
                famousSongs: '"Blue Bossa" by Kenny Dorham (9th chords), "So What" by Miles Davis (9ths), "Take Five" by Dave Brubeck.',
                progressions: 'ii9-V9-Imaj7, I9-IV9-I9, as colorful substitutes for 7th chords.',
                tips: 'Omit the 5th in voicings to avoid clutter. Try quartal voicings. Resolve 9th appropriately based on context.'
            },

            'm9': {
                notes: 'Root + 3m + 5 + 7m + 9M',
                characteristics: 'Smooth, sophisticated sound with subtle tension. More refined than m7.',
                keyAspects: 'Combines minor 7th with major 9th for smooth, jazzy quality.',
                commonUsage: 'Used in jazz as i9 chords, for sophisticated harmony, and as passing chords.',
                famousSongs: '"There Will Never Be Another You" (minor 9ths), "Stella by Starlight", "My Funny Valentine".',
                progressions: 'i9-iv9-VII9, ii9-V9-i9, as substitutes for ii√∏7-V7-i.',
                tips: 'Voice the 9th on top for brightness. Try shell voicings with 9th added. Great for ballads.'
            }
        };

        // Chord information database - Spanish
        const chordInfoDatabase_es = {
            // Major chords
            'maj': {
                notes: 'T√≥nica + 3M + 5',
                characteristics: 'Sonido brillante, estable y consonante que forma la base de la mayor√≠a de la m√∫sica occidental. Tiene una sensaci√≥n de resoluci√≥n y completitud.',
                keyAspects: 'El intervalo de tercera mayor crea brillo y estabilidad. A menudo llamado el acorde "feliz".',
                commonUsage: 'Usado como acordes t√≥nicos (I) en tonalidades mayores, acordes dominantes (V) en otras tonalidades, y como armon√≠as estables en pop, rock, cl√°sica y jazz.',
                famousSongs: '"Let It Be" de The Beatles (Do mayor), "Stairway to Heaven" de Led Zeppelin (La mayor), "Imagine" de John Lennon (Do mayor).',
                progressions: 'I-IV-V-I (la progresi√≥n m√°s com√∫n), I-vi-IV-V, I-V-vi-IV, ii-V-I (turnaround de jazz).',
                tips: 'Toca primero la posici√≥n fundamental, luego prueba la primera inversi√≥n (tercera en el bajo) para una conducci√≥n de voces m√°s suave. A√±ade la 6¬™ para color o la 9¬™ para un aire jazz.'
            },
            '': {
                notes: 'T√≥nica + 3M + 5',
                characteristics: 'Sonido brillante, estable y consonante que forma la base de la mayor√≠a de la m√∫sica occidental. Tiene una sensaci√≥n de resoluci√≥n y completitud.',
                keyAspects: 'El intervalo de tercera mayor crea brillo y estabilidad. A menudo llamado el acorde "feliz".',
                commonUsage: 'Usado como acordes t√≥nicos (I) en tonalidades mayores, acordes dominantes (V) en otras tonalidades, y como armon√≠as estables en pop, rock, cl√°sica y jazz.',
                famousSongs: '"Let It Be" de The Beatles (Do mayor), "Stairway to Heaven" de Led Zeppelin (La mayor), "Imagine" de John Lennon (Do mayor).',
                progressions: 'I-IV-V-I (la progresi√≥n m√°s com√∫n), I-vi-IV-V, I-V-vi-IV, ii-V-I (turnaround de jazz).',
                tips: 'Toca primero la posici√≥n fundamental, luego prueba la primera inversi√≥n (tercera en el bajo) para una conducci√≥n de voces m√°s suave. A√±ade la 6¬™ para color o la 9¬™ para un aire jazz.'
            },

            // Minor chords
            'm': {
                notes: 'T√≥nica + 3m + 5',
                characteristics: 'Sonido m√°s oscuro y emocional con una cualidad melanc√≥lica o seria. Menos estable que los acordes mayores.',
                keyAspects: 'La tercera menor crea profundidad emocional y tensi√≥n. A menudo llamado el acorde "triste".',
                commonUsage: 'Usado como acordes t√≥nicos (i) en tonalidades menores, acordes vi en tonalidades mayores, y para expresi√≥n emocional en baladas, rock y cl√°sica.',
                famousSongs: '"Stairway to Heaven" de Led Zeppelin (Lam), "Nothing Else Matters" de Metallica (Mim), "Hurt" de Johnny Cash (Lam).',
                progressions: 'i-IV-V-i (blues menor), i-iv-i (t√≥nica menor), i-VI-III-VII (menor arm√≥nico), vi-IV-I-V (balada pop).',
                tips: 'Prueba diferentes posiciones: fundamental, primera inversi√≥n o segunda inversi√≥n. A√±ade la 7¬™ para m√°s tensi√≥n o la 9¬™ para menor jazz.'
            },
            'min': {
                notes: 'T√≥nica + 3m + 5',
                characteristics: 'Sonido m√°s oscuro y emocional con una cualidad melanc√≥lica o seria. Menos estable que los acordes mayores.',
                keyAspects: 'La tercera menor crea profundidad emocional y tensi√≥n. A menudo llamado el acorde "triste".',
                commonUsage: 'Usado como acordes t√≥nicos (i) en tonalidades menores, acordes vi en tonalidades mayores, y para expresi√≥n emocional en baladas, rock y cl√°sica.',
                famousSongs: '"Stairway to Heaven" de Led Zeppelin (Lam), "Nothing Else Matters" de Metallica (Mim), "Hurt" de Johnny Cash (Lam).',
                progressions: 'i-IV-V-i (blues menor), i-iv-i (t√≥nica menor), i-VI-III-VII (menor arm√≥nico), vi-IV-I-V (balada pop).',
                tips: 'Prueba diferentes posiciones: fundamental, primera inversi√≥n o segunda inversi√≥n. A√±ade la 7¬™ para m√°s tensi√≥n o la 9¬™ para menor jazz.'
            },
            '-': {
                notes: 'T√≥nica + 3m + 5',
                characteristics: 'Sonido m√°s oscuro y emocional con una cualidad melanc√≥lica o seria. Menos estable que los acordes mayores.',
                keyAspects: 'La tercera menor crea profundidad emocional y tensi√≥n. A menudo llamado el acorde "triste".',
                commonUsage: 'Usado como acordes t√≥nicos (i) en tonalidades menores, acordes vi en tonalidades mayores, y para expresi√≥n emocional en baladas, rock y cl√°sica.',
                famousSongs: '"Stairway to Heaven" de Led Zeppelin (Lam), "Nothing Else Matters" de Metallica (Mim), "Hurt" de Johnny Cash (Lam).',
                progressions: 'i-IV-V-i (blues menor), i-iv-i (t√≥nica menor), i-VI-III-VII (menor arm√≥nico), vi-IV-I-V (balada pop).',
                tips: 'Prueba diferentes posiciones: fundamental, primera inversi√≥n o segunda inversi√≥n. A√±ade la 7¬™ para m√°s tensi√≥n o la 9¬™ para menor jazz.'
            },

            // Dominant 7th
            '7': {
                notes: 'T√≥nica + 3M + 5 + 7m',
                characteristics: 'Sonido tenso y direccional que tira fuertemente hacia la resoluci√≥n. Tiene una cualidad bluesy y sofisticada.',
                keyAspects: 'La s√©ptima menor crea una tensi√≥n fuerte que exige resoluci√≥n, usualmente hacia la t√≥nica.',
                commonUsage: 'Usado como acordes dominantes (V7) en tonalidades mayores, para progresiones de blues y armon√≠a jazz. Crea fuerte movimiento cadencial.',
                famousSongs: '"Hit the Road Jack" de Ray Charles (Do7), "Satin Doll" de Duke Ellington (Sib7), "All Blues" de Miles Davis (Sib7).',
                progressions: 'I7-IV7-V7-I7 (blues), ii7-V7-Imaj7 (ii-V-I de jazz), V7-I (cadencia perfecta), I-VI7-II7-V7 (ragtime).',
                tips: 'Enfatiza la 7¬™ y la 3¬™ en tu disposici√≥n. Prueba drop-2 para acompa√±amiento jazz. Resuelve la 7¬™ bajando a la 3¬™ del siguiente acorde.'
            },

            // Major 7th
            'maj7': {
                notes: 'T√≥nica + 3M + 5 + 7M',
                characteristics: 'Sonido suave y sofisticado con una cualidad so√±adora y suspendida. Menos tenso que la s√©ptima dominante.',
                keyAspects: 'La s√©ptima mayor a√±ade color y sofisticaci√≥n sin fuerte atracci√≥n direccional.',
                commonUsage: 'Usado en jazz como acordes t√≥nicos (Imaj7), en pop para armon√≠a sofisticada, y en cl√°sica para a√±adir color.',
                famousSongs: '"What a Wonderful World" de Louis Armstrong (Imaj7), "Autumn Leaves" de Joseph Kosma (Lamaj7), "Blue Bossa" de Kenny Dorham (Domaj7).',
                progressions: 'Imaj7-vi7-ii7-V7 (jazz), Imaj7-IVmaj7-IImaj7-V7, I-VIImaj7-III7-VImaj7 (jazz extendido).',
                tips: 'Coloca la 7¬™ mayor arriba para brillo. Prueba disposiciones cerradas o abiertas. Funciona bien como policordios sobre otras armon√≠as.'
            },

            // Minor 7th
            'm7': {
                notes: 'T√≥nica + 3m + 5 + 7m',
                characteristics: 'Sonido c√°lido y relajado con tensi√≥n sutil. M√°s sofisticado que el menor simple.',
                keyAspects: 'Combina tr√≠ada menor con s√©ptima menor para una cualidad suave y jazzy.',
                commonUsage: 'Usado como acordes ii7 en tonalidades mayores, i7 en tonalidades menores, y para armon√≠a jazz suave.',
                famousSongs: '"Take Five" de Dave Brubeck (Mim7), "So What" de Miles Davis (Rem7), "Blue in Green" de Bill Evans (Lam7).',
                progressions: 'ii7-V7-Imaj7 (progresi√≥n jazz m√°s com√∫n), i7-iv7-VII7, Rem7-Sol7-Domaj7 (ii-V-I cl√°sico).',
                tips: 'Prueba shell voicings (t√≥nica, 3¬™, 7¬™) para acompa√±amiento. Usa como acordes de paso entre armon√≠as m√°s estables.'
            },

            // Diminished
            'dim': {
                notes: 'T√≥nica + 3m + 5b',
                characteristics: 'Sonido inestable y tenso con cualidad misteriosa y dram√°tica. Altamente disonante.',
                keyAspects: 'La estructura sim√©trica permite m√∫ltiples interpretaciones. Fuerte sensaci√≥n de necesitar resoluci√≥n.',
                commonUsage: 'Usado como acordes de sensible (vii¬∞) hacia la t√≥nica, acordes de paso, y para efecto dram√°tico.',
                famousSongs: '"The Entertainer" de Scott Joplin (m√∫ltiples acordes dim), "Giant Steps" de John Coltrane (como acordes de paso), "Caravan" de Duke Ellington.',
                progressions: 'vii¬∞-I (cadencia aut√©ntica en menor), I-II¬∞-III-IV¬∞-V, como acordes de paso entre acordes mayores/menores.',
                tips: 'Toca suavemente y resuelve r√°pido. Prueba diferentes inversiones - cada una tiene diferentes niveles de tensi√≥n. Genial para transiciones.'
            },

            // Diminished 7th
            'dim7': {
                notes: 'T√≥nica + 3m + 5b + 7bb',
                characteristics: 'Sonido altamente tenso y ambiguo que puede resolver a cualquier acorde a medio tono de distancia.',
                keyAspects: 'La estructura sim√©trica (terceras menores) crea m√°xima tensi√≥n y m√∫ltiples posibilidades de resoluci√≥n.',
                commonUsage: 'Usado como acordes de paso, para movimiento crom√°tico, y en cl√°sica y jazz para efecto dram√°tico.',
                famousSongs: '"Misty" de Erroll Garner (como acorde de paso), "Cherokee" de Ray Noble (aproximaci√≥n crom√°tica), "Giant Steps" de John Coltrane.',
                progressions: 'V7-#IV¬∞7-#iv¬∞7-iii7, como acordes de aproximaci√≥n a cualquier objetivo, I7-II7-III7-IV7 (escala de tonos enteros).',
                tips: 'Resuelve a acordes a medio tono arriba o abajo. Prueba diferentes disposiciones para enfatizar diferentes notas como objetivos de resoluci√≥n.'
            },

            // Minor 7th flat 5 (half-diminished)
            'm7b5': {
                notes: 'T√≥nica + 3m + 5b + 7m',
                characteristics: 'Sonido tenso y sofisticado con cualidades bluesy y jazzy. Menos √°spero que el disminuido completo.',
                keyAspects: 'Combina tr√≠ada menor con quinta disminuida y s√©ptima menor. Crea fuerte atracci√≥n hacia la resoluci√≥n.',
                commonUsage: 'Usado como ii√∏7 en tonalidades menores, para armon√≠a jazz, y como acordes de paso.',
                famousSongs: '"Autumn Leaves" de Joseph Kosma (Re√∏7), "There Will Never Be Another You" (ii√∏7-V7-i), "Stella by Starlight" (m√∫ltiples acordes √∏7).',
                progressions: 'ii√∏7-V7-i (jazz menor), i-ii√∏7-V7-i, IV-VII√∏7-III7-VI7 (menor arm√≥nico).',
                tips: 'Coloca la 5b arriba para tensi√≥n. Resuelve la 7¬™ bajando a la 3¬™, la 5b subiendo a la 5¬™. Esencial para armon√≠a jazz.'
            },

            // Augmented
            'aug': {
                notes: 'T√≥nica + 3M + 5#',
                characteristics: 'Sonido brillante y ambiguo con cualidad flotante y no resuelta. Crea tensi√≥n sin direcci√≥n.',
                keyAspects: 'La quinta aumentada sim√©trica crea ambig√ºedad - puede sonar como mayor o menor dependiendo del contexto.',
                commonUsage: 'Usado como acordes de paso, para modulaci√≥n, y en m√∫sica cl√°sica impresionista.',
                famousSongs: 'Tema de "Los Simpson" (Doaug como acorde de paso), "Giant Steps" de Coltrane (aproximaciones aumentadas), "Black Narcissus" de Joe Henderson.',
                progressions: 'I+ - #IV¬∞ - bVII, como paso entre acordes mayores, III+ - vi - IV (impresionista).',
                tips: 'Usa como acordes de aproximaci√≥n a otras armon√≠as. La quinta aumentada puede resolver crom√°ticamente hacia arriba o abajo.'
            },

            // Suspended chords
            'sus2': {
                notes: 'T√≥nica + 2M + 5',
                characteristics: 'Sonido abierto y et√©reo con tensi√≥n sutil. Menos direccional que sus4.',
                keyAspects: 'Reemplaza la tercera con una segunda, creando una cualidad abierta y ambigua.',
                commonUsage: 'Usado en pop y rock para sonidos atmosf√©ricos, como acordes de aproximaci√≥n, y para armon√≠a moderna.',
                famousSongs: '"Dust in the Wind" de Kansas (Solsus2), "Horse with No Name" de America (acordes sus2), "More Than Words" de Extreme.',
                progressions: 'I-sus2-I (resoluci√≥n), I-IIIsus2-IV-V, sus2 como acordes de paso entre mayor/menor.',
                tips: 'Resuelve la 2¬™ subiendo a la 3¬™ para resoluci√≥n suave. Prueba a√±adir la 4¬™ arriba para sonido 6/9. Genial para intros y puentes.'
            },

            'sus4': {
                notes: 'T√≥nica + 4J + 5',
                characteristics: 'Sonido tenso y anticipatorio que tira fuertemente hacia la resoluci√≥n. M√°s direccional que sus2.',
                keyAspects: 'Reemplaza la tercera con una cuarta, creando tensi√≥n fuerte que exige resoluci√≥n.',
                commonUsage: 'Usado en rock, pop y folk para inter√©s r√≠tmico y como acordes de aproximaci√≥n.',
                famousSongs: '"Dream On" de Aerosmith (Resus4), "Let It Be" de The Beatles (resoluciones sus4), "Under the Bridge" de Red Hot Chili Peppers.',
                progressions: 'I-sus4-I (resoluci√≥n cl√°sica), I-IV-sus4-IV-I, V-sus4-V-I, ii-sus4-ii-V.',
                tips: 'Resuelve la 4¬™ bajando a la 3¬™ para resoluci√≥n fuerte. Usa en tiempos 2 y 4 del ritmo. A√±ade 7¬™ para m√°s tensi√≥n.'
            },

            // 6th chords
            '6': {
                notes: 'T√≥nica + 3M + 5 + 6M',
                characteristics: 'Sonido brillante y colorido con dulzura a√±adida y estabilidad. M√°s complejo que la tr√≠ada mayor.',
                keyAspects: 'A√±ade la sexta para color mientras mantiene la cualidad mayor. Menos tenso que los acordes de s√©ptima.',
                commonUsage: 'Usado en m√∫sica cl√°sica, jazz y pop para color a√±adido y como acordes t√≥nicos con sofisticaci√≥n.',
                famousSongs: '"Michelle" de The Beatles (La6), "It Had to Be You" (acordes de 6¬™ en el puente), "My Funny Valentine" (aproximaci√≥n de 6¬™).',
                progressions: 'I6-IV-I, I6-ii7-V7-I, como sustituto del acorde I en tonalidades mayores.',
                tips: 'Prueba primera inversi√≥n (6¬™ en el bajo) para conducci√≥n de voces m√°s suave. Usa como aproximaci√≥n a acordes dominantes.'
            },

            'm6': {
                notes: 'T√≥nica + 3m + 5 + 6M',
                characteristics: 'Sonido rico y emocional con cualidad agridulce. M√°s complejo que la tr√≠ada menor.',
                keyAspects: 'Combina tr√≠ada menor con sexta mayor para un color melanc√≥lico √∫nico.',
                commonUsage: 'Usado en m√∫sica cl√°sica, jazz, y como sustituto de acordes i en tonalidades menores.',
                famousSongs: '"Autumn Leaves" de Joseph Kosma (Lam6), "Cry Me a River" de Arthur Hamilton, "Blackbird" de The Beatles.',
                progressions: 'i6-VI7-V7-i, i6-iv-i, como acordes de paso en tonalidades menores.',
                tips: 'Coloca la 6¬™ arriba para brillo. Prueba diferentes inversiones para variaciones de color.'
            },

            // 9th chords
            '9': {
                notes: 'T√≥nica + 3M + 5 + 7m + 9M',
                characteristics: 'Sonido rico y complejo con tensi√≥n y sofisticaci√≥n a√±adidas. Altamente colorido.',
                keyAspects: 'A√±ade la 9¬™ (novena mayor) para armon√≠a extendida. Crea cualidad exuberante y jazzy.',
                commonUsage: 'Usado en jazz y pop sofisticado como acordes dominantes con color a√±adido.',
                famousSongs: '"Blue Bossa" de Kenny Dorham (acordes de 9¬™), "So What" de Miles Davis (9¬™s), "Take Five" de Dave Brubeck.',
                progressions: 'ii9-V9-Imaj7, I9-IV9-I9, como sustitutos coloridos para acordes de 7¬™.',
                tips: 'Omite la 5¬™ en las disposiciones para evitar saturaci√≥n. Prueba voicings cuartales. Resuelve la 9¬™ apropiadamente seg√∫n el contexto.'
            },

            'm9': {
                notes: 'T√≥nica + 3m + 5 + 7m + 9M',
                characteristics: 'Sonido suave y sofisticado con tensi√≥n sutil. M√°s refinado que m7.',
                keyAspects: 'Combina s√©ptima menor con novena mayor para cualidad suave y jazzy.',
                commonUsage: 'Usado en jazz como acordes i9, para armon√≠a sofisticada, y como acordes de paso.',
                famousSongs: '"There Will Never Be Another You" (novenas menores), "Stella by Starlight", "My Funny Valentine".',
                progressions: 'i9-iv9-VII9, ii9-V9-i9, como sustitutos de ii√∏7-V7-i.',
                tips: 'Coloca la 9¬™ arriba para brillo. Prueba shell voicings con 9¬™ a√±adida. Genial para baladas.'
            }
        };

        function getChordInfo(chord) {
            // Get the base chord type (remove root note)
            const chordType = chord.type || '';
            
            // Select the appropriate database based on current language
            const database = currentLanguage === 'es' ? chordInfoDatabase_es : chordInfoDatabase_en;

            // Return chord info from database, or default to major chord info
            return database[chordType] || database['maj'];
        }

        function openWikipedia(chordName) {
            // Use Wikipedia search to find articles that mention this chord
            // This will find music theory pages, song pages, or articles that reference the chord
            const searchQuery = `"${chordName}" chord OR "${chordName}" music OR "${chordName}" harmony`;
            const url = `https://en.wikipedia.org/w/index.php?search=${encodeURIComponent(searchQuery)}&title=Special%3ASearch&fulltext=1`;
            window.open(url, '_blank');
        }

        function openChordBook(chordName) {
            // Use pianochord.org to find piano chord diagrams directly
            // Note: pianochord.org uses lowercase URLs
            const url = `https://pianochord.org/${encodeURIComponent(chordName.toLowerCase())}.html`;
            window.open(url, '_blank');
        }

        function openPerplexity(chordName) {
            // Create a detailed prompt for Perplexity AI about piano chords
            const prompt = `${chordName} acorde de piano. Caracter√≠sticas principales, consejos para piano, progresiones. Incluye nombres y notaciones alternativas`;
            const url = `https://www.perplexity.ai/search?q=${encodeURIComponent(prompt)}`;
            window.open(url, '_blank');
        }

        function openGrok(chordName) {
            // Create a detailed prompt for Grok AI about piano chords
            const prompt = `${chordName} acorde de piano. Caracter√≠sticas principales, consejos para piano, progresiones. Incluye nombres y notaciones alternativas`;
            //const url = `https://x.com/i/grok?text=${encodeURIComponent(prompt)}`;
            const url = `https://grok.com/?q=${encodeURIComponent(prompt)}`;
            window.open(url, '_blank');
        }

        function closeModal() {
            document.getElementById('insightsModal').style.display = 'none';
        }

        function showOtherChords() {
            const noteIndexes = Array.from(selectedNotes).map(note => {
                const noteName = note.replace(/\d+$/, '');
                return noteNames.indexOf(noteName);
            }).sort((a, b) => a - b);

            if (noteIndexes.length === 1) {
                // Case 1: Single note - show all chords with this note as root
                showChordsWithRoot(noteIndexes[0]);
            } else if (noteIndexes.length === 3) {
                // Case 2: Three notes - show all chords containing these three notes
                showChordsContainingNotes(noteIndexes);
            }
        }

        function showChordsWithRoot(rootIndex) {
            const rootNote = noteNames[rootIndex];
            const modal = document.getElementById('otherChordsModal');
            const titleElement = document.getElementById('otherChordsModalTitle');
            const listContainer = document.getElementById('otherChordsListContainer');
            const t = translations[currentLanguage];
            
            // Set modal title
            titleElement.textContent = t.otherChordsWithRoot.replace('{note}', rootNote);
            
            // Clear previous list
            listContainer.innerHTML = '';
            
            // Use intervalPatterns to get only unique chord patterns
            // intervalPatterns already groups chord types by their intervals
            // We'll use only the first (main) name from each group
            const uniqueChords = [];
            Object.keys(intervalPatterns).forEach(patternKey => {
                const chordTypesForPattern = intervalPatterns[patternKey];
                // Use only the first (main) chord type name
                const mainChordType = chordTypesForPattern[0];
                const intervals = chordDatabase[mainChordType];
                uniqueChords.push({
                    type: mainChordType,
                    intervals: intervals
                });
            });
            
            // Create list items for each unique chord
            uniqueChords.forEach(chord => {
                const chordName = rootNote + chord.type;
                
                const item = document.createElement('div');
                item.className = 'chord-list-item';
                item.textContent = chordName;
                item.dataset.root = rootIndex;
                item.dataset.intervals = JSON.stringify(chord.intervals);
                item.dataset.chordName = chordName;
                
                // Single click - highlight additional keys and mark as selected
                item.addEventListener('click', function() {
                    // Remove selected class from all items
                    document.querySelectorAll('.chord-list-item').forEach(i => i.classList.remove('selected'));
                    // Add selected class to this item
                    this.classList.add('selected');
                    highlightChordKeys(rootIndex, chord.intervals);
                });
                
                // Double click - select chord
                item.addEventListener('dblclick', function() {
                    selectChord(rootIndex, chord.intervals);
                    closeOtherChordsModal();
                });
                
                listContainer.appendChild(item);
            });
            
            // Show modal
            modal.style.display = 'block';
        }

        function showChordsContainingNotes(selectedNoteIndexes) {
            const modal = document.getElementById('otherChordsModal');
            const titleElement = document.getElementById('otherChordsModalTitle');
            const listContainer = document.getElementById('otherChordsListContainer');
            const t = translations[currentLanguage];
            
            // Set modal title
            const noteNames_display = selectedNoteIndexes.map(i => noteNames[i]).join(', ');
            titleElement.textContent = t.otherChordsContaining.replace('{notes}', noteNames_display);
            
            // Clear previous list
            listContainer.innerHTML = '';
            
            // Find all chords that contain these three notes
            const matchingChords = [];
            const seenChords = new Set(); // To track unique chords by root+intervals
            
            // Try each note as a potential root
            for (let rootIndex = 0; rootIndex < 12; rootIndex++) {
                // Use intervalPatterns to get only unique chord patterns (no duplicates)
                Object.keys(intervalPatterns).forEach(patternKey => {
                    const chordTypesForPattern = intervalPatterns[patternKey];
                    // Use only the first (main) chord type name
                    const mainChordType = chordTypesForPattern[0];
                    const intervals = chordDatabase[mainChordType];
                    const chordNotes = intervals.map(interval => (rootIndex + interval) % 12);
                    
                    // Check if all selected notes are in this chord
                    const allNotesIncluded = selectedNoteIndexes.every(noteIdx => 
                        chordNotes.includes(noteIdx)
                    );
                    
                    if (allNotesIncluded) {
                        // Create a unique key for this chord (root + sorted intervals)
                        const chordKey = `${rootIndex}-${patternKey}`;
                        
                        if (!seenChords.has(chordKey)) {
                            seenChords.add(chordKey);
                            const chordName = noteNames[rootIndex] + mainChordType;
                            matchingChords.push({
                                name: chordName,
                                root: rootIndex,
                                intervals: intervals
                            });
                        }
                    }
                });
            }
            
            if (matchingChords.length === 0) {
                listContainer.innerHTML = `<p style="text-align: center; padding: 12px; font-size: 0.9em;">${t.noChordsFound}</p>`;
            } else {
                // Create list items for each matching chord
                matchingChords.forEach(chord => {
                    const item = document.createElement('div');
                    item.className = 'chord-list-item';
                    item.textContent = chord.name;
                    item.dataset.root = chord.root;
                    item.dataset.intervals = JSON.stringify(chord.intervals);
                    item.dataset.chordName = chord.name;
                    
                    // Single click - highlight additional keys (keys not already selected) and mark as selected
                    item.addEventListener('click', function() {
                        // Remove selected class from all items
                        document.querySelectorAll('.chord-list-item').forEach(i => i.classList.remove('selected'));
                        // Add selected class to this item
                        this.classList.add('selected');
                        highlightAdditionalChordKeys(chord.root, chord.intervals, selectedNoteIndexes);
                    });
                    
                    // Double click - select chord
                    item.addEventListener('dblclick', function() {
                        selectChord(chord.root, chord.intervals);
                        closeOtherChordsModal();
                    });
                    
                    listContainer.appendChild(item);
                });
            }
            
            // Show modal
            modal.style.display = 'block';
        }

        function highlightChordKeys(rootIndex, intervals) {
            // Remove previous blue highlights and selected state from list items
            document.querySelectorAll('.white-key, .black-key').forEach(key => {
                key.classList.remove('preview');
            });
            
            // Add blue highlight to chord keys (only one key per note - the most central one)
            intervals.forEach(interval => {
                const noteIndex = (rootIndex + interval) % 12;
                const noteName = noteNames[noteIndex];
                
                // Find all keys with this note name
                const matchingKeys = Array.from(document.querySelectorAll('.white-key, .black-key')).filter(key => {
                    const keyNoteName = key.dataset.note.replace(/\d+$/, '');
                    return keyNoteName === noteName;
                });
                
                // Choose the most central key (closest to octave 3 or 4)
                if (matchingKeys.length > 0) {
                    const centralKey = matchingKeys.reduce((closest, key) => {
                        const octave = parseInt(key.dataset.note.match(/\d+$/)[0]);
                        const closestOctave = parseInt(closest.dataset.note.match(/\d+$/)[0]);
                        const targetOctave = 3.5; // Middle of the keyboard
                        return Math.abs(octave - targetOctave) < Math.abs(closestOctave - targetOctave) ? key : closest;
                    });
                    centralKey.classList.add('preview');
                }
            });
        }

        function highlightAdditionalChordKeys(rootIndex, intervals, alreadySelectedIndexes) {
            // Remove previous blue highlights (but keep red active ones)
            document.querySelectorAll('.white-key, .black-key').forEach(key => {
                key.classList.remove('preview');
            });
            
            // Add blue highlight only to additional keys (not already selected)
            intervals.forEach(interval => {
                const noteIndex = (rootIndex + interval) % 12;
                const noteName = noteNames[noteIndex];
                
                // Only highlight if this note is NOT in the already selected notes
                if (!alreadySelectedIndexes.includes(noteIndex)) {
                    // Find all keys with this note name
                    const matchingKeys = Array.from(document.querySelectorAll('.white-key, .black-key')).filter(key => {
                        const keyNoteName = key.dataset.note.replace(/\d+$/, '');
                        return keyNoteName === noteName;
                    });
                    
                    // Choose the most central key (closest to octave 3 or 4)
                    if (matchingKeys.length > 0) {
                        const centralKey = matchingKeys.reduce((closest, key) => {
                            const octave = parseInt(key.dataset.note.match(/\d+$/)[0]);
                            const closestOctave = parseInt(closest.dataset.note.match(/\d+$/)[0]);
                            const targetOctave = 3.5; // Middle of the keyboard
                            return Math.abs(octave - targetOctave) < Math.abs(closestOctave - targetOctave) ? key : closest;
                        });
                        centralKey.classList.add('preview');
                    }
                }
            });
        }

        function selectChord(rootIndex, intervals) {
            // Get current selection size before clearing
            const currentSelectionSize = selectedNotes.size;
            
            // If there's only 1 note selected (case when coming from single note),
            // keep it and only add the additional notes
            if (currentSelectionSize === 1) {
                // Just remove preview class, keep active notes
                document.querySelectorAll('.white-key, .black-key').forEach(key => {
                    key.classList.remove('preview');
                });
                
                // Add missing notes from the chord
                intervals.forEach(interval => {
                    const noteIndex = (rootIndex + interval) % 12;
                    const noteName = noteNames[noteIndex];
                    
                    // Check if this note is already selected
                    const alreadySelected = Array.from(selectedNotes).some(selected => {
                        const selectedNoteName = selected.replace(/\d+$/, '');
                        return noteNames.indexOf(selectedNoteName) === noteIndex;
                    });
                    
                    // Only add if not already selected
                    if (!alreadySelected) {
                        // Find the most central key with this note and select it
                        const matchingKeys = Array.from(document.querySelectorAll('.white-key, .black-key')).filter(key => {
                            const keyNoteName = key.dataset.note.replace(/\d+$/, '');
                            return keyNoteName === noteName;
                        });
                        
                        if (matchingKeys.length > 0) {
                            const centralKey = matchingKeys.reduce((closest, key) => {
                                const octave = parseInt(key.dataset.note.match(/\d+$/)[0]);
                                const closestOctave = parseInt(closest.dataset.note.match(/\d+$/)[0]);
                                const targetOctave = 3.5;
                                return Math.abs(octave - targetOctave) < Math.abs(closestOctave - targetOctave) ? key : closest;
                            });
                            selectedNotes.add(centralKey.dataset.note);
                            centralKey.classList.add('active');
                        }
                    }
                });
            } else {
                // For 3 notes or other cases, clear and select all notes in chord
                selectedNotes.clear();
                document.querySelectorAll('.white-key, .black-key').forEach(key => {
                    key.classList.remove('active');
                    key.classList.remove('preview');
                });
                
                // Select all notes in the chord
                intervals.forEach(interval => {
                    const noteIndex = (rootIndex + interval) % 12;
                    const noteName = noteNames[noteIndex];
                    
                    // Find the most central key with this note and select it
                    const matchingKeys = Array.from(document.querySelectorAll('.white-key, .black-key')).filter(key => {
                        const keyNoteName = key.dataset.note.replace(/\d+$/, '');
                        return keyNoteName === noteName;
                    });
                    
                    if (matchingKeys.length > 0) {
                        const centralKey = matchingKeys.reduce((closest, key) => {
                            const octave = parseInt(key.dataset.note.match(/\d+$/)[0]);
                            const closestOctave = parseInt(closest.dataset.note.match(/\d+$/)[0]);
                            const targetOctave = 3.5;
                            return Math.abs(octave - targetOctave) < Math.abs(closestOctave - targetOctave) ? key : closest;
                        });
                        selectedNotes.add(centralKey.dataset.note);
                        centralKey.classList.add('active');
                    }
                });
            }
            
            // Update chord info
            identifyChord();
        }

        function closeOtherChordsModal() {
            // Remove blue highlights
            document.querySelectorAll('.white-key, .black-key').forEach(key => {
                key.classList.remove('preview');
            });
            
            // Remove selected state from list items
            document.querySelectorAll('.chord-list-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            document.getElementById('otherChordsModal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('otherChordsModal');
            if (event.target === modal) {
                closeOtherChordsModal();
            }
        });

        function showHelp() {
            document.getElementById('helpModal').style.display = 'block';
        }

        function closeHelpModal() {
            document.getElementById('helpModal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const insightsModal = document.getElementById('insightsModal');
            const helpModal = document.getElementById('helpModal');
            
            if (event.target === insightsModal) {
                closeModal();
            }
            if (event.target === helpModal) {
                closeHelpModal();
            }
        }

        // Handle Enter key in chord input
        document.getElementById('chordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                findChord();
            }
        });

        // Initialize piano and language
        createPiano();
        updateLanguage();
    </script>
</body>
</html>
