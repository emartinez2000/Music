<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Forte</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png?v=2">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png?v=2">
    <link rel="icon" type="image/png" sizes="64x64" href="favicon-64.png?v=2">
    <link rel="shortcut icon" type="image/png" href="favicon-32.png?v=2">
    <link rel="apple-touch-icon" href="favicon-64.png?v=2">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            .modal-content {
                margin: 10% auto;
                width: 95%;
                max-height: 70vh;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .modal-header {
                padding: 20px;
            }
            
            .modal-header h2 {
                font-size: 1.5em;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .help-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            padding: 10px 20px;
            font-size: 1em;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .help-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .language-toggle {
            position: absolute;
            top: 20px;
            right: 140px;
            padding: 8px 15px;
            font-size: 1.5em;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            line-height: 1;
        }

        .language-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .notation-toggle {
            position: absolute;
            top: 20px;
            left: 30px;
            padding: 10px 20px;
            font-size: 1em;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notation-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Tabs System */
        .tabs-container {
            background: white;
            border-bottom: 2px solid #e0e0e0;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 0;
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .tab {
            flex: 1;
            max-width: 300px;
            padding: 15px 30px;
            background: #f5f5f5;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            text-align: center;
        }

        .tab:hover {
            background: #e8e8e8;
            color: #333;
        }

        .tab.active {
            background: white;
            color: #2c3e50;
            border-bottom-color: #3498db;
        }

        .tab-content {
            display: none;
            padding: 40px;
            position: relative;
        }

        .tab-content.active {
            display: block;
        }

        .content {
            padding: 40px;
            position: relative;
        }

        .chord-input-section {
            margin-bottom: 40px;
            text-align: center;
        }

        .chord-input-section h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-weight: 400;
        }

        .chord-input {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .chord-input input {
            padding: 15px 20px;
            font-size: 1.2em;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            min-width: 200px;
            transition: all 0.3s ease;
        }

        .chord-input input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
        }

        .chord-input button {
            padding: 15px 30px;
            font-size: 1.2em;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chord-input button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .piano-container {
            margin: 40px 0;
            text-align: center;
        }

        .piano-container h2 {
            margin-bottom: 30px;
            color: #2c3e50;
            font-weight: 400;
        }

        .piano-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }

        .piano-header h2 {
            margin-bottom: 0;
            flex: 0 1 auto;
        }

        .piano {
            display: inline-block;
            background: #333;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            overflow-x: auto;
        }

        .octave {
            display: inline-block;
            position: relative;
            margin-right: 2px;
        }

        .white-key {
            width: 37.5px;
            height: 200px;
            background: #fff;
            border: 2px solid #ddd;
            display: inline-block;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            border-radius: 0 0 8px 8px;
            user-select: none;
        }

        .white-key:hover {
            background: #f0f0f0;
            transform: translateY(2px);
        }

        .white-key.active {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            transform: translateY(3px);
            box-shadow: inset 0 3px 10px rgba(0,0,0,0.3);
        }

        .black-key {
            width: 26.25px;
            height: 130px;
            background: #222;
            position: absolute;
            top: 0;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 0 0 5px 5px;
            z-index: 2;
            user-select: none;
        }

        .black-key:hover {
            background: #444;
            transform: translateY(2px);
        }

        .black-key.active {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            transform: translateY(3px);
            box-shadow: inset 0 3px 10px rgba(0,0,0,0.5);
        }

        .white-key.preview {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .black-key.preview {
            background: linear-gradient(45deg, #3498db, #2980b9);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.6);
        }

        .key-label {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            font-weight: bold;
        }

        .black-key .key-label {
            color: white;
            bottom: 15px;
            font-size: 0.7em;
        }

        /* Staff (Pentagrama) Styles */
        .staff-container {
            margin: 0;
            text-align: center;
            background: #f8f9fa;
            padding: 0 30px 30px 30px;
            border-radius: 15px;
        }
        
        /* Remove top margin from chord-input-section inside staff-container */
        .staff-container .chord-input-section {
            margin-top: 0;
            margin-bottom: 40px;
        }

        /* Two-column layout for staff */
        .staff-main-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .staff-left {
            flex: 1;
            min-width: 0;
            overflow: visible;
            width: 0; /* Force flex to calculate correctly */
        }

        .staff-right {
            flex: 0 0 250px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 250px;
        }

        .staff-svg-container {
            position: relative;
        }
        
        .practice-anchor-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        
        .anchor-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid #333;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .anchor-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
        }
        
        .anchor-btn.active {
            box-shadow: 0 0 0 3px rgba(0,0,0,0.3);
        }
        
        .anchor-btn-do {
            background: #87ceeb; /* Celeste */
        }
        
        .anchor-btn-fa {
            background: #00ff00; /* Verde */
        }
        
        .anchor-btn-sol {
            background: #ffff00; /* Amarillo */
        }
        
        .anchor-btn .anchor-emoji {
            font-size: 20px;
        }

        .go-btn {
            padding: 8px 30px;
            font-size: 1.2em;
            font-weight: bold;
            background: linear-gradient(45deg, #27ae60, #229954);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            margin-left: 0;
        }

        .go-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .go-btn:active {
            transform: translateY(0);
        }

        .go-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        /* Exercise counter - 2 columns, 3 rows */
        .exercise-counter {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .counter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .counter-col {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .counter-col select {
            width: 100%;
            padding: 10px;
            font-size: 0.85em;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .counter-col select:hover {
            border-color: #3498db;
        }

        .counter-col select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        .counter-col label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
            text-align: center;
        }

        .counter-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
            padding: 12px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            min-height: 50px;
            min-width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Responsive: stack columns on small screens */
        @media (max-width: 768px) {
            .staff-main-layout {
                flex-direction: column;
            }

            .staff-right {
                width: 100%;
                min-width: 0;
            }
        }

        /* Piano container inside staff should be identical to chords tab */
        /* Only piano-header needs special styling for the GO button */
        .staff-container .piano-header {
            margin-bottom: 20px;
        }
        
        /* Piano container is now outside the two-column layout, so it can use full width */
        .staff-container .piano-container {
            margin-left: -30px;
            margin-right: -30px;
            width: calc(100% + 60px);
        }

        .staff-svg {
            width: 100%;
            max-width: 800px;
            height: 300px;
            margin: 20px auto;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
        }

        .staff-line {
            stroke: #000;
            stroke-width: 2;
        }

        .staff-note {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .staff-note:hover {
            opacity: 0.7;
        }

        .staff-note.active {
            fill: #e74c3c;
        }

        .staff-controls {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .staff-controls button {
            padding: 12px 24px;
            font-size: 1em;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .staff-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .staff-feedback {
            font-size: 1.2em;
            margin: 20px auto;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            max-width: 600px;
        }

        .staff-feedback.correct {
            background: #d4edda;
            color: #155724;
        }

        .staff-feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
        }

        .chord-info {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            text-align: center;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .chord-name {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .chord-notes {
            font-size: 1.3em;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .chord-type {
            font-size: 1.1em;
            color: #95a5a6;
            font-style: italic;
        }

        .controls {
            text-align: center;
            margin: 30px 0;
        }

        .clear-btn {
            padding: 12px 25px;
            font-size: 1.1em;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .instructions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            text-align: left;
        }

        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .instructions ul {
            color: #7f8c8d;
            line-height: 1.6;
        }

        .insights-btn {
            padding: 12px 25px;
            font-size: 1.1em;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
            opacity: 0.7;
            pointer-events: none;
        }

        .insights-btn.active {
            opacity: 1;
            pointer-events: all;
        }

        .insights-btn:hover.active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .other-chords-btn {
            padding: 12px 25px;
            font-size: 1.1em;
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
            opacity: 0.7;
            pointer-events: none;
        }

        .other-chords-btn.active {
            opacity: 1;
            pointer-events: all;
        }

        .other-chords-btn:hover.active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }

        .chord-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 6px;
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .chord-list::-webkit-scrollbar {
            width: 5px;
        }
        
        .chord-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }
        
        .chord-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }
        
        .chord-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .chord-list-item {
            padding: 8px;
            background: linear-gradient(45deg, #ecf0f1, #bdc3c7);
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
            font-size: 0.85em;
        }

        .chord-list-item:hover {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .chord-list-item.highlighted {
            border-color: #3498db;
            background: linear-gradient(45deg, #e8f4f8, #d4e9f5);
        }

        .chord-list-item.selected {
            border-color: #27ae60;
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            font-weight: 600;
        }

        #otherChordsModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.3);
        }

        #otherChordsModal .modal-content {
            background-color: white;
            margin: 1% auto;
            padding: 0;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            width: 35%;
            max-width: 400px;
            max-height: 45vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #otherChordsModal .modal-body {
            overflow-y: auto;
            flex: 1;
            padding: 0;
        }

        #otherChordsModal .modal-header {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            padding: 12px 18px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #otherChordsModal .modal-header h2 {
            margin: 0;
            font-size: 1em;
            font-weight: 400;
        }

        #otherChordsModal .close {
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 3px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        #otherChordsModal .close:hover {
            background-color: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 300;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close:hover {
            background-color: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
            line-height: 1.6;
            color: #2c3e50;
        }

        .insight-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #9b59b6;
        }

        .insight-section h3 {
            color: #8e44ad;
            margin-bottom: 12px;
            font-size: 1.2em;
        }

        .insight-section p {
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #9b59b6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .header {
                padding: 50px 20px 20px;
            }
            
            .header h1 {
                font-size: 1.5em;
                margin-top: 10px;
            }
            
            .notation-toggle {
                top: 10px;
                left: 10px;
                padding: 8px 12px;
                font-size: 0.85em;
            }
            
            .help-btn {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 0.85em;
            }
            
            .language-toggle {
                top: 10px;
                right: 80px;
                padding: 6px 10px;
                font-size: 1.2em;
            }
            
            .chord-input {
                flex-direction: column;
                align-items: center;
            }
            
            .chord-input input {
                min-width: 250px;
            }
            
            .white-key {
                width: 40px;
                height: 160px;
            }
            
            .black-key {
                width: 28px;
                height: 110px;
            }
            
            .chord-name {
                font-size: 2em;
            }

            #otherChordsModal .modal-content {
                width: 85%;
                max-width: 85%;
                max-height: 50vh;
            }

            .chord-list {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                gap: 4px;
                padding: 8px;
            }

            .chord-list-item {
                padding: 6px;
                font-size: 0.75em;
            }
            
        }

        .footer-credit {
            position: absolute;
            bottom: 10px;
            right: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            z-index: 10;
            padding: 15px;
        }

        .footer-credit img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        .footer-credit p {
            margin: 0;
            font-size: 0.85em;
            color: #7f8c8d;
            font-style: italic;
            font-weight: normal;
        }

        @media (max-width: 768px) {
            .footer-credit {
                bottom: 10px;
                right: 10px;
                padding: 10px;
            }

            .footer-credit img {
                width: 48px;
                height: 48px;
            }

            .footer-credit p {
                font-size: 0.75em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="notation-toggle" onclick="toggleNotation()">
                <span id="notationIcon">üéµ</span>
                <span id="notationText">C#, Eb</span>
            </button>
            <h1 id="headerTitle">üéπ Piano Forte</h1>
            <button class="language-toggle" onclick="toggleLanguage()" id="languageBtn">üá™üá∏</button>
            <button class="help-btn" onclick="showHelp()" id="helpBtn">‚ùì Help</button>
        </div>
        
        <!-- Tabs Navigation -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('chords')" id="tabChords">
                    <span id="tabChordsText">üéπ Acordes</span>
                </button>
                <button class="tab" onclick="switchTab('staff')" id="tabStaff">
                    <span id="tabStaffText">üéº Pentagrama</span>
                </button>
            </div>
        </div>

        <!-- Tab Content: Chords -->
        <div class="tab-content active" id="tabContentChords">
            <div class="chord-input-section">
                <h2 id="chordInputTitle">Enter a Chord Name...</h2>
                <div class="chord-input">
                    <input type="text" id="chordInput" placeholder="e.g., Cmaj7, F#dim, Am" />
                    <button onclick="findChord()" id="showChordBtn">Show Chord</button>
                </div>
            </div>

            <div class="piano-container">
                <h2 id="pianoTitle">...or Click the Keys</h2>
                <div class="piano" id="piano"></div>
            </div>

            <div class="chord-info" id="chordInfo">
                <div class="chord-name" id="chordName">Select notes or enter a chord name</div>
                <div class="chord-notes" id="chordNotes">Click piano keys above or type a chord name</div>
                <div class="chord-type" id="chordType">Ready to help you identify chords!</div>
            </div>

            <div class="controls">
                <button class="clear-btn" onclick="clearAll()" id="clearBtn">Clear All</button>
                <button class="insights-btn active" id="insightsBtn" onclick="showChordInfo()">Chord Info</button>
                <button class="other-chords-btn" id="otherChordsBtn" onclick="showOtherChords()">Otros Acordes</button>
            </div>

            <!-- Footer Credit -->
            <div class="footer-credit">
                <img src="favicon-64.png?v=2" alt="Piano Forte Icon">
                <p id="footerBy">By Betoven de Garicochea</p>
            </div>
        </div>
        <!-- End Tab Content: Chords -->

        <!-- Tab Content: Staff (Pentagrama) -->
        <div class="tab-content" id="tabContentStaff">
            <div class="staff-container">
                <div class="chord-input-section">
                    <h2 id="staffTitle">Leer el pentagrama. Introduccion</h2>
                </div>
                
                <div class="staff-main-layout">
                    <!-- Left side: Staff drawing and logic (3/4) -->
                    <div class="staff-left">
                        <div class="staff-feedback" id="staffFeedback" style="display: none;"></div>

                        <div class="staff-svg-container">
                            <svg class="staff-svg" id="staffSvg" viewBox="0 0 800 300" xmlns="http://www.w3.org/2000/svg">
                                <!-- Staff lines will be drawn here -->
                            </svg>
                            
                            <!-- Practice mode anchor buttons (only visible in Practicar level) -->
                            <div id="practiceAnchorButtons" class="practice-anchor-buttons" style="display: none;">
                                <button class="anchor-btn anchor-btn-do" onclick="togglePracticeAnchor('DO')" title="DO">
                                    <span class="anchor-emoji">‚öì</span>
                                </button>
                                <button class="anchor-btn anchor-btn-fa" onclick="togglePracticeAnchor('FA')" title="FA">
                                    <span class="anchor-emoji">‚öì</span>
                                </button>
                                <button class="anchor-btn anchor-btn-sol" onclick="togglePracticeAnchor('SOL')" title="SOL">
                                    <span class="anchor-emoji">‚öì</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Right side: Level selector and counter (1/4) -->
                    <div class="staff-right">
                        <div class="exercise-counter">
                            <!-- Row 1: Level and Exercise dropdowns -->
                            <div class="counter-row">
                                <div class="counter-col">
                                    <select id="levelSelect" onchange="changeLevel()">
                                        <option value="Practicar">Practicar</option>
                                        <option value="1">Nivel 1</option>
                                        <option value="2">Nivel 2</option>
                                        <option value="3">Nivel 3</option>
                                        <option value="4">Nivel 4</option>
                                        <option value="5">Nivel 5</option>
                                    </select>
                                </div>
                                <div class="counter-col">
                                    <select id="exerciseSelect" onchange="changeExercise()">
                                        <option value="1">Round 1</option>
                                        <option value="2">Round 2</option>
                                        <option value="3">Round 3</option>
                                        <option value="4">Round 4</option>
                                        <option value="5">Round 5</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Row 2: Attempts and Time -->
                            <div class="counter-row">
                                <div class="counter-col">
                                    <label id="attemptsLabel">Intentos</label>
                                    <div class="counter-value" id="attemptsNumber">-</div>
                                </div>
                                <div class="counter-col">
                                    <label id="timeLabel">Tiempo</label>
                                    <div class="counter-value" id="timeNumber">-</div>
                                </div>
                            </div>
                            <!-- Row 3: Correct and Wrong -->
                            <div class="counter-row">
                                <div class="counter-col">
                                    <label id="correctLabel">Aciertos</label>
                                    <div class="counter-value" id="correctNumber">0</div>
                                </div>
                                <div class="counter-col">
                                    <label id="wrongLabel">Fallos</label>
                                    <div class="counter-value" id="wrongNumber">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Piano container - full width below the two-column layout -->
                <div class="piano-container">
                    <div class="piano-header">
                        <h2 id="staffPianoTitle">Selecciona la nota en el teclado</h2>
                        <button onclick="startExercise()" id="goBtn" class="go-btn">GO!</button>
                    </div>
                    <div class="piano" id="staffPiano"></div>
                </div>

                <div class="staff-controls">
                    <button onclick="generateNewNote()" id="newNoteBtn">Nueva Nota</button>
                    <button onclick="checkAnswer()" id="checkBtn">Verificar</button>
                    <button onclick="clearStaffSelection()" id="clearStaffBtn">Limpiar</button>
                </div>
            </div>

            <!-- Footer Credit -->
            <div class="footer-credit">
                <img src="favicon-64.png?v=2" alt="Piano Forte Icon">
                <p id="footerByStaff">By Betoven de Garicochea</p>
            </div>
        </div>
        <!-- End Tab Content: Staff -->
    </div>

    <!-- Modal for Help -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <!-- Content will be generated dynamically by updateHelpModal() -->
        </div>
    </div>

    <!-- Modal for Chord Information -->
    <div id="insightsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalChordName">Chord Information</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Getting AI insights for this chord...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Other Chords -->
    <div id="otherChordsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="otherChordsModalTitle">Otros Acordes</h2>
                <button class="close" onclick="closeOtherChordsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="otherChordsListContainer" class="chord-list"></div>
            </div>
        </div>
    </div>

    <script>
        const selectedNotes = new Set();
        
        // Language system
        let currentLanguage = 'es'; // 'en' or 'es'
        
        const translations = {
            en: {
                headerTitle: 'Piano Chords',
                helpBtn: 'Help',
                chordInputTitle: 'Enter a Chord Name...',
                showChordBtn: 'Show Chord',
                pianoTitle: '...or Click the Keys',
                clearBtn: 'Clear All',
                insightsBtn: 'Chord Info',
                otherChordsBtn: 'Other Chords',
                otherChordsWithRoot: 'Chords with {note} as root',
                otherChordsContaining: 'Chords containing: {notes}',
                noChordsFound: 'No chords found containing these three notes.',
                defaultChordName: 'Select notes or enter a chord name',
                defaultChordNotes: 'Click piano keys above or type a chord name',
                defaultChordType: 'Ready to help you identify chords!',
                placeholderAnglo: 'e.g., Cmaj7, F#dim, Am',
                placeholderItalian: 'e.g., Domaj7, Fa#dim, Lam',
                singleNote: 'Single note. click "Other Chords" to see all chords with this note as root.',
                addMoreNotes: 'Add more notes to form a chord',
                unknownChord: 'Unknown Chord',
                notes: 'Notes',
                noMatch: "This combination doesn't match a common chord pattern",
                invalidChord: 'Invalid Chord',
                isNotRecognized: 'is not recognized',
                tryFormats: 'Try formats like: C, Cm, C7, Cmaj7, F#dim',
                unknownChordType: 'Unknown Chord Type',
                chordTypeNotFound: 'not found',
                tryCommonTypes: 'Try common types like maj7, m, dim, sus4',
                modalHelpTitle: 'How to Use',
                helpWhatIsThis: '‚ùì What is this?',
                helpWhatIsThisText: 'This is an App to play with piano chords. Find rare chords or identify a chord that appears in a sheet music. It doesn\'t sound yet. But it will-. Any error or improvement suggestion, to the "Betoven de garicochea".',
                helpNotation: 'üéµ Musical Notation',
                helpNotationText: 'Click the "üéµ Do#, Mib" or "üéµ C#, Eb" button in the top-left corner to switch between Italian notation (Do, Re, Mi, Fa, Sol, La, Si) and Anglo-Saxon notation (C, D, E, F, G, A, B). All labels, chord names, and input examples will update automatically!',
                helpIdentify: 'Identify Chords',
                helpIdentifyText: 'Click on piano keys to select notes, and the chord name will appear below automatically.',
                helpFind: 'üîç Find Chord Notes',
                helpFindText: 'Type a chord name in the input field and click "Show Chord" to see which keys to play. Examples: <strong>Cmaj7</strong>, <strong>F#dim</strong>, <strong>Am</strong> (Anglo-Saxon) or <strong>Domaj7</strong>, <strong>Fa#dim</strong>, <strong>Lam</strong> (Italian).',
                helpFormats: 'üìù Supported Formats',
                helpFormatsText: 'Major, minor, diminished, augmented, suspended, power chords, and extended chords (7th, 9th, 11th, 13th) are all supported. Works with both notation systems!',
                helpInfo: 'üìö Chord Information',
                helpInfoText: 'Click "Chord Info" button to learn about the chord\'s characteristics, usage in music, famous songs that use it, and tips for playing it on piano.',
                helpOtherChords: 'üéπ Other Chords',
                helpOtherChordsText: 'The "Other Chords" button becomes active when you select <strong>1 note</strong> or <strong>3 or more notes</strong>. With 1 note, it shows all chords using that note as root. With 3 or more notes, it shows all chords containing those notes, grouped by the total number of notes in each chord. <strong>Click</strong> on a chord to preview it in blue on the piano. <strong>Double-click</strong> to select it.',
                helpClear: 'üóëÔ∏è Clear Selection',
                helpClearText: 'Use the "Clear All" button to deselect all keys and start over with a fresh selection.',
                modalChordInfo: 'Chord Information',
                chordStructure: 'üéπ Chord Structure',
                chordStructureNotes: 'Notes:',
                soundCharacteristics: 'üéµ Sound & Characteristics',
                keyAspects: 'üîç Key Aspects',
                commonUsage: 'üé∏ Common Usage',
                famousSongs: 'üé§ Famous Songs',
                chordProgressions: 'üéº Chord Progressions',
                pianoTips: 'üí° Piano Tips',
                learnMore: 'üîé Learn More',
                learnMoreText: 'Want to know more about',
                learnMoreResources: 'Check out these free resources:',
                infoNotAvailable: 'Information not available',
                footerBy: 'by el Betoven de Garicochea',
                tabChords: 'üéπ Chords',
                tabStaff: 'üéº Staff',
                staffTitle: 'Read the Staff. Introduction',
                staffPianoTitle: 'Select the note on the keyboard',
                newNoteBtn: 'New Note',
                checkBtn: 'Check',
                clearStaffBtn: 'Clear',
                correctAnswer: 'Correct! üéâ',
                incorrectAnswer: 'Incorrect. Try again!',
                levelLabel: 'Level:',
                exerciseLabel: 'Exercise#',
                attemptsLabel: 'Attempts',
                timeLabel: 'Time',
                correctLabel: 'Correct',
                wrongLabel: 'Wrong'
            },
            es: {
                headerTitle: 'Acordes de Piano',
                helpBtn: 'Ayuda',
                chordInputTitle: 'Introduce un nombre de acorde...',
                showChordBtn: 'Mostrar Acorde',
                pianoTitle: '...o haz clic en las teclas',
                clearBtn: 'Limpiar Todo',
                insightsBtn: 'Info del Acorde',
                otherChordsBtn: 'Otros Acordes',
                otherChordsWithRoot: 'Acordes con {note} como t√≥nica',
                otherChordsContaining: 'Acordes que contienen: {notes}',
                noChordsFound: 'No se encontraron acordes que contengan estas tres notas.',
                defaultChordName: 'Selecciona notas o introduce un acorde',
                defaultChordNotes: 'Haz clic en las teclas del piano o escribe un nombre de acorde',
                defaultChordType: '¬°Listo para ayudarte a identificar acordes!',
                placeholderAnglo: 'ej., Cmaj7, F#dim, Am',
                placeholderItalian: 'ej., Domaj7, Fa#dim, Lam',
                singleNote: 'Nota individual. Pulsa "Otros Acordes" para ver todos los que tienen esta nota como t√≥nica',
                addMoreNotes: 'Agrega m√°s notas para formar un acorde.',
                unknownChord: 'Acorde Desconocido',
                notes: 'Notas',
                noMatch: 'Esta combinaci√≥n no coincide con un patr√≥n de acorde com√∫n',
                invalidChord: 'Acorde Inv√°lido',
                isNotRecognized: 'no reconocido',
                tryFormats: 'Intenta formatos como: Do, Dom, Do7, Domaj7, Fa#dim',
                unknownChordType: 'Tipo de Acorde Desconocido',
                chordTypeNotFound: 'no encontrado',
                tryCommonTypes: 'Intenta tipos comunes como maj7, m, dim, sus4',
                modalHelpTitle: 'Ayuda',
                helpWhatIsThis: '‚ùì ¬øQu√© es esto?',
                helpWhatIsThisText: 'Esto es una App para jugar con los acordes de piano. Encontrar acordes raros o identificar un acorde que nos salga en una partitura. A√∫n no suena. Pero sonar√°-. Cualquier error o sugerencia de mejora, a el "Betoven de garicochea".',
                helpNotation: 'üéµ Notaci√≥n Musical',
                helpNotationText: 'Haz clic en el bot√≥n "üéµ Do#, Mib" o "üéµ C#, Eb" en la esquina superior izquierda para cambiar entre notaci√≥n italiana (Do, Re, Mi, Fa, Sol, La, Si) y notaci√≥n anglosajona (C, D, E, F, G, A, B). ¬°Todas las etiquetas, nombres de acordes y ejemplos se actualizar√°n autom√°ticamente!',
                helpIdentify: 'Identificar Acordes',
                helpIdentifyText: 'Haz clic en las teclas del piano para seleccionar notas, y el nombre del acorde aparecer√° autom√°ticamente abajo.',
                helpFind: 'üîç Encontrar Notas del Acorde',
                helpFindText: 'Escribe el nombre de un acorde en el campo de entrada y haz clic en "Mostrar Acorde" para ver qu√© teclas tocar. Ejemplos: <strong>Cmaj7</strong>, <strong>F#dim</strong>, <strong>Am</strong> (Anglosaj√≥n) o <strong>Domaj7</strong>, <strong>Fa#dim</strong>, <strong>Lam</strong> (Italiano).',
                helpFormats: 'üìù Formatos Soportados',
                helpFormatsText: 'Se admiten acordes mayores, menores, disminuidos, aumentados, suspendidos, power chords y acordes extendidos (7¬™, 9¬™, 11¬™, 13¬™). ¬°Funciona con ambos sistemas de notaci√≥n!',
                helpInfo: 'üìö Informaci√≥n del Acorde',
                helpInfoText: 'Haz clic en el bot√≥n "Info del Acorde" para aprender sobre las caracter√≠sticas del acorde, su uso en la m√∫sica, canciones famosas que lo utilizan y consejos para tocarlo en el piano.',
                helpOtherChords: 'üéπ Otros Acordes',
                helpOtherChordsText: 'El bot√≥n "Otros Acordes" se activa cuando seleccionas <strong>1 nota</strong> o <strong>3 o m√°s notas</strong>. Con 1 nota, muestra todos los acordes que usan esa nota como t√≥nica. Con 3 o m√°s notas, muestra todos los acordes que contienen esas notas, agrupados por el n√∫mero total de notas de cada acorde. Haz <strong>clic</strong> en un acorde para previsualizarlo en azul en el piano. Haz <strong>doble clic</strong> para seleccionarlo.',
                helpClear: 'üóëÔ∏è Limpiar Selecci√≥n',
                helpClearText: 'Usa el bot√≥n "Limpiar Todo" para deseleccionar todas las teclas y comenzar de nuevo con una selecci√≥n limpia.',
                modalChordInfo: 'Informaci√≥n del Acorde',
                chordStructure: 'üéπ Estructura del Acorde',
                chordStructureNotes: 'Notas:',
                soundCharacteristics: 'üéµ Sonido y Caracter√≠sticas',
                keyAspects: 'üîç Aspectos Clave',
                commonUsage: 'üé∏ Uso Com√∫n',
                famousSongs: 'üé§ Canciones Famosas',
                chordProgressions: 'üéº Progresiones de Acordes',
                pianoTips: 'üí° Consejos para Piano',
                learnMore: 'üîé Aprende M√°s',
                learnMoreText: '¬øQuieres saber m√°s sobre',
                learnMoreResources: 'Consulta estos recursos gratuitos:',
                infoNotAvailable: 'Informaci√≥n no disponible',
                footerBy: 'by el Betoven de Garicochea',
                tabChords: 'üéπ Acordes',
                tabStaff: 'üéº Pentagrama',
                staffTitle: 'Leer el pentagrama. Introduccion',
                staffPianoTitle: 'Selecciona la nota en el teclado',
                newNoteBtn: 'Nueva Nota',
                checkBtn: 'Verificar',
                clearStaffBtn: 'Limpiar',
                correctAnswer: '¬°Correcto! üéâ',
                incorrectAnswer: 'Incorrecto. ¬°Int√©ntalo de nuevo!',
                levelLabel: 'Nivel:',
                exerciseLabel: 'Ejercicio#',
                attemptsLabel: 'Intentos',
                timeLabel: 'Tiempo',
                correctLabel: 'Aciertos',
                wrongLabel: 'Fallos'
            }
        };
        
        // Notation systems
        const notations = {
            anglo: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'],
            italian: ['Do', 'Do#', 'Re', 'Re#', 'Mi', 'Fa', 'Fa#', 'Sol', 'Sol#', 'La', 'La#', 'Si']
        };
        
        // Mapping between notations
        const angloToItalian = {
            'C': 'Do', 'C#': 'Do#', 'Db': 'Reb',
            'D': 'Re', 'D#': 'Re#', 'Eb': 'Mib',
            'E': 'Mi',
            'F': 'Fa', 'F#': 'Fa#', 'Gb': 'Solb',
            'G': 'Sol', 'G#': 'Sol#', 'Ab': 'Lab',
            'A': 'La', 'A#': 'La#', 'Bb': 'Sib',
            'B': 'Si'
        };
        
        const italianToAnglo = {
            'Do': 'C', 'Do#': 'C#', 'Reb': 'Db',
            'Re': 'D', 'Re#': 'D#', 'Mib': 'Eb',
            'Mi': 'E',
            'Fa': 'F', 'Fa#': 'F#', 'Solb': 'Gb',
            'Sol': 'G', 'Sol#': 'G#', 'Lab': 'Ab',
            'La': 'A', 'La#': 'A#', 'Sib': 'Bb',
            'Si': 'B'
        };
        
        let currentNotation = 'italian'; // 'anglo' or 'italian'
        let noteNames = [...notations.italian];
        let currentChord = null;

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'es' : 'en';
            updateLanguage();
        }

        function updateLanguage() {
            const t = translations[currentLanguage];
            
            // Update language button
            document.getElementById('languageBtn').textContent = currentLanguage === 'en' ? 'üá™üá∏' : 'üá¨üáß';
            
            // Update header
            document.getElementById('headerTitle').textContent = t.headerTitle;
            document.getElementById('helpBtn').textContent = t.helpBtn;
            
            // Update main sections
            document.getElementById('chordInputTitle').textContent = t.chordInputTitle;
            document.getElementById('showChordBtn').textContent = t.showChordBtn;
            document.getElementById('pianoTitle').textContent = t.pianoTitle;
            document.getElementById('clearBtn').textContent = t.clearBtn;
            document.getElementById('insightsBtn').textContent = 'üìö ' + t.insightsBtn;
            document.getElementById('otherChordsBtn').textContent = 'üéπ ' + t.otherChordsBtn;
            
            // Update placeholder
            const input = document.getElementById('chordInput');
            input.placeholder = currentNotation === 'italian' ? t.placeholderItalian : t.placeholderAnglo;
            
            // Update default chord info if no chord is selected
            if (selectedNotes.size === 0) {
                updateChordInfo(t.defaultChordName, t.defaultChordNotes, t.defaultChordType);
            } else {
                // Re-identify current chord to update text
                identifyChord();
            }
            
            // Update footer
            const footerBy = document.getElementById('footerBy');
            if (footerBy) {
                footerBy.textContent = t.footerBy;
            }
            
            // Update footer in staff tab
            const footerByStaff = document.getElementById('footerByStaff');
            if (footerByStaff) {
                footerByStaff.textContent = t.footerBy;
            }
            
            // Update tabs
            const tabChordsText = document.getElementById('tabChordsText');
            const tabStaffText = document.getElementById('tabStaffText');
            if (tabChordsText) tabChordsText.textContent = t.tabChords;
            if (tabStaffText) tabStaffText.textContent = t.tabStaff;
            
            // Update staff tab content if visible
            if (document.getElementById('tabContentStaff').classList.contains('active')) {
                updateStaffLanguage();
            }
            
            // Update help modal content
            updateHelpModal();
        }

        // Tab switching system
        let currentTab = 'chords'; // 'chords' or 'staff'

        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (tabName === 'chords') {
                document.getElementById('tabChords').classList.add('active');
                document.getElementById('tabContentChords').classList.add('active');
                document.getElementById('tabContentStaff').classList.remove('active');
            } else {
                document.getElementById('tabStaff').classList.add('active');
                document.getElementById('tabContentStaff').classList.add('active');
                document.getElementById('tabContentChords').classList.remove('active');
                
                // Initialize staff if not already done
                if (!window.staffInitialized) {
                    initializeStaff();
                    window.staffInitialized = true;
                }
            }
        }

        function updateStaffLanguage() {
            const t = translations[currentLanguage];
            const staffTitle = document.getElementById('staffTitle');
            const staffPianoTitle = document.getElementById('staffPianoTitle');
            const newNoteBtn = document.getElementById('newNoteBtn');
            const checkBtn = document.getElementById('checkBtn');
            const clearStaffBtn = document.getElementById('clearStaffBtn');
            const levelSelectLabel = document.getElementById('levelSelectLabel');
            const exerciseLabel = document.getElementById('exerciseLabel');
            const attemptsLabel = document.getElementById('attemptsLabel');
            const timeLabel = document.getElementById('timeLabel');
            
            if (staffTitle) staffTitle.textContent = t.staffTitle;
            if (staffPianoTitle) staffPianoTitle.textContent = t.staffPianoTitle;
            if (newNoteBtn) newNoteBtn.textContent = t.newNoteBtn;
            if (checkBtn) checkBtn.textContent = t.checkBtn;
            if (clearStaffBtn) clearStaffBtn.textContent = t.clearStaffBtn;
            if (levelSelectLabel) levelSelectLabel.textContent = t.levelLabel;
            if (exerciseLabel) exerciseLabel.textContent = t.exerciseLabel;
            if (attemptsLabel) attemptsLabel.textContent = t.attemptsLabel;
            if (timeLabel) timeLabel.textContent = t.timeLabel;
            const correctLabel = document.getElementById('correctLabel');
            const wrongLabel = document.getElementById('wrongLabel');
            if (correctLabel) correctLabel.textContent = t.correctLabel;
            if (wrongLabel) wrongLabel.textContent = t.wrongLabel;
        }

        function updateHelpModal() {
            const t = translations[currentLanguage];
            const helpModal = document.getElementById('helpModal');
            const modalContent = helpModal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>${t.modalHelpTitle}</h2>
                    <button class="close" onclick="closeHelpModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="insight-section">
                        <h3>${t.helpWhatIsThis}</h3>
                        <p>${t.helpWhatIsThisText}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.helpNotation}</h3>
                        <p>${t.helpNotationText}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.helpIdentify}</h3>
                        <p>${t.helpIdentifyText}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.helpFind}</h3>
                        <p>${t.helpFindText}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.helpFormats}</h3>
                        <p>${t.helpFormatsText}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.helpInfo}</h3>
                        <p>${t.helpInfoText}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.helpOtherChords}</h3>
                        <p>${t.helpOtherChordsText}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.helpClear}</h3>
                        <p>${t.helpClearText}</p>
                    </div>
                </div>
            `;
        }

        // Comprehensive chord database
        const chordDatabase = {
            // Major chords
            'maj': [0, 4, 7],
            'M': [0, 4, 7],
            '': [0, 4, 7], // Default major
            
            // Minor chords
            'm': [0, 3, 7],
            'min': [0, 3, 7],
            '-': [0, 3, 7],
            
            // Power chords (5th chords)
            '5': [0, 7],
            'pow': [0, 7],
            
            // Dominant 7th
            '7': [0, 4, 7, 10],
            'dom7': [0, 4, 7, 10],
            
            // Major 7th
            'maj7': [0, 4, 7, 11],
            'M7': [0, 4, 7, 11],
            '‚ñ≥7': [0, 4, 7, 11],
            
            // Minor 7th
            'm7': [0, 3, 7, 10],
            'min7': [0, 3, 7, 10],
            '-7': [0, 3, 7, 10],
            
            // Diminished
            'dim': [0, 3, 6],
            '¬∞': [0, 3, 6],
            'o': [0, 3, 6],
            
            // Diminished 7th
            'dim7': [0, 3, 6, 9],
            '¬∞7': [0, 3, 6, 9],
            'o7': [0, 3, 6, 9],
            
            // Half-diminished
            'm7b5': [0, 3, 6, 10],
            '√∏7': [0, 3, 6, 10],
            
            // Augmented
            'aug': [0, 4, 8],
            '+': [0, 4, 8],
            
            // Suspended
            'sus2': [0, 2, 7],
            'sus4': [0, 5, 7],
            
            // 6th chords
            '6': [0, 4, 7, 9],
            'm6': [0, 3, 7, 9],
            
            // 9th chords
            '9': [0, 4, 7, 10, 14],
            'maj9': [0, 4, 7, 11, 14],
            'M9': [0, 4, 7, 11, 14],
            'm9': [0, 3, 7, 10, 14],
            'min9': [0, 3, 7, 10, 14],
            
            // 11th chords
            '11': [0, 4, 7, 10, 14, 17],
            'maj11': [0, 4, 7, 11, 14, 17],
            'M11': [0, 4, 7, 11, 14, 17],
            'm11': [0, 3, 7, 10, 14, 17],
            'min11': [0, 3, 7, 10, 14, 17],
            
            // 13th chords
            '13': [0, 4, 7, 10, 14, 17, 21],
            'maj13': [0, 4, 7, 11, 14, 17, 21],
            'M13': [0, 4, 7, 11, 14, 17, 21],
            'm13': [0, 3, 7, 10, 14, 17, 21],
            'min13': [0, 3, 7, 10, 14, 17, 21],
            
            // Add chords
            'add9': [0, 4, 7, 14],
            'madd9': [0, 3, 7, 14],
            'add11': [0, 4, 7, 17],
            'madd11': [0, 3, 7, 17],
            
            // Altered chords
            '7#5': [0, 4, 8, 10],
            '7b5': [0, 4, 6, 10],
            '7#9': [0, 4, 7, 10, 15],
            '7b9': [0, 4, 7, 10, 13],
            '7#11': [0, 4, 7, 10, 18],
            
            // Minor variations
            'm7#5': [0, 3, 8, 10],
            'm7b5': [0, 3, 6, 10],
            'mmaj7': [0, 3, 7, 11],
            'm(maj7)': [0, 3, 7, 11],
            
            // Sus variations
            '7sus2': [0, 2, 7, 10],
            '7sus4': [0, 5, 7, 10],
            'maj7sus2': [0, 2, 7, 11],
            'maj7sus4': [0, 5, 7, 11]
        };

        // Reverse lookup for chord identification
        const intervalPatterns = {};
        Object.keys(chordDatabase).forEach(chordType => {
            const intervals = chordDatabase[chordType];
            const key = intervals.slice().sort().join(',');
            if (!intervalPatterns[key]) {
                intervalPatterns[key] = [];
            }
            intervalPatterns[key].push(chordType);
        });

        function toggleNotation() {
            const oldNotation = currentNotation;
            
            // Convert selected notes to new notation
            const convertedNotes = new Set();
            selectedNotes.forEach(noteWithOctave => {
                // Extract note name and octave (e.g., "Sol3" -> "Sol" + "3", "Do#4" -> "Do#" + "4")
                const match = noteWithOctave.match(/^(.+?)(\d+)$/);
                if (!match) return;
                
                const noteName = match[1];
                const octave = match[2];
                
                // Find the index in current notation
                const oldNoteNames = notations[oldNotation];
                const noteIndex = oldNoteNames.indexOf(noteName);
                
                if (noteIndex !== -1) {
                    // Get the corresponding note in new notation
                    const newNotation = oldNotation === 'anglo' ? 'italian' : 'anglo';
                    const newNoteNames = notations[newNotation];
                    const newNoteName = newNoteNames[noteIndex];
                    convertedNotes.add(newNoteName + octave);
                }
            });
            
            // Clear old selection
            selectedNotes.clear();
            convertedNotes.forEach(note => selectedNotes.add(note));
            
            // Switch notation
            currentNotation = currentNotation === 'anglo' ? 'italian' : 'anglo';
            noteNames = [...notations[currentNotation]];
            
            // Update button text
            const notationText = document.getElementById('notationText');
            notationText.textContent = currentNotation === 'anglo' ? 'Do#, Mib' : 'C#, Eb';
            
            // Update placeholder
            const t = translations[currentLanguage];
            const input = document.getElementById('chordInput');
            if (currentNotation === 'italian') {
                input.placeholder = t.placeholderItalian;
            } else {
                input.placeholder = t.placeholderAnglo;
            }
            
            // Update all piano key labels and reselect keys
            updatePianoLabels();
            
            // Re-apply active class to converted notes
            document.querySelectorAll('.white-key, .black-key').forEach(key => {
                if (selectedNotes.has(key.dataset.note)) {
                    key.classList.add('active');
                } else {
                    key.classList.remove('active');
                }
            });
            
            // Update current chord display if there's one
            if (selectedNotes.size > 0) {
                identifyChord();
            } else {
                const defaultTexts = currentNotation === 'italian' 
                    ? ['Selecciona notas o introduce un acorde', 'Haz clic en las teclas del piano o escribe un nombre de acorde', '¬°Listo para ayudarte a identificar acordes!']
                    : ['Select notes or enter a chord name', 'Click piano keys above or type a chord name', 'Ready to help you identify chords!'];
                updateChordInfo(...defaultTexts);
            }
        }

        function updatePianoLabels() {
            // Update all key labels on both pianos
            document.querySelectorAll('#piano .white-key, #piano .black-key, #staffPiano .white-key, #staffPiano .black-key').forEach(key => {
                const noteIndex = parseInt(key.dataset.noteIndex);
                const label = key.querySelector('.key-label');
                if (label) {
                    label.textContent = noteNames[noteIndex];
                }
                // Update the full note name in the dataset
                // Extract octave from the current note name (e.g., "Sol3" -> "3", "Do#4" -> "4")
                const match = key.dataset.note.match(/\d+$/);
                const octave = match ? match[0] : '';
                key.dataset.note = `${noteNames[noteIndex]}${octave}`;
            });
        }

        function convertNoteName(name, fromNotation, toNotation) {
            if (fromNotation === toNotation) return name;
            
            const map = fromNotation === 'anglo' ? angloToItalian : italianToAnglo;
            return map[name] || name;
        }

        function getNumberOfOctaves() {
            // Calculate how many octaves fit based on screen width
            // Each octave is approximately 262.5px (7 white keys √ó 37.5px each)
            // Account for container padding and margins
            const screenWidth = window.innerWidth;
            const octaveWidth = 262.5; // Approximate width of one octave
            
            // Account for container padding (40px each side) and content padding
            const availableWidth = screenWidth - 200; // Rough estimate for margins and padding
            
            // Since we start at octave 2, we need one more octave to maintain the same upper range
            // Previously: 3 octaves (3, 4, 5), now: 4 octaves (2, 3, 4, 5)
            if (availableWidth < octaveWidth * 1.5) {
                // Mobile: 2 octaves fit (screen width < ~725px) - was 1, now 2
                return 2;
            } else if (availableWidth < octaveWidth * 2.5) {
                // Tablet: 3 octaves fit (screen width < ~1075px) - was 2, now 3
                return 3;
            } else {
                // Desktop: 4 octaves fit (screen width >= ~1075px) - was 3, now 4
                return 4;
            }
        }

        function createPiano(pianoId = 'piano') {
            const piano = document.getElementById(pianoId);
            if (!piano) return;
            piano.innerHTML = '';
            
            // Calculate number of octaves based on screen size
            const numOctaves = getNumberOfOctaves();
            const startOctave = 2;
            const endOctave = startOctave + numOctaves - 1;
            
            // Create octaves starting from C2
            for (let octave = startOctave; octave <= endOctave; octave++) {
                const octaveDiv = document.createElement('div');
                octaveDiv.className = 'octave';
                
                // White keys
                const whiteKeyPattern = [0, 2, 4, 5, 7, 9, 11]; // C, D, E, F, G, A, B
                whiteKeyPattern.forEach((noteIndex, keyIndex) => {
                    const key = document.createElement('div');
                    key.className = 'white-key';
                    const noteName = noteNames[noteIndex];
                    const fullNoteName = `${noteName}${octave}`;
                    key.dataset.note = fullNoteName;
                    key.dataset.noteIndex = noteIndex;
                    
                    const label = document.createElement('div');
                    label.className = 'key-label';
                    label.textContent = noteName;
                    key.appendChild(label);
                    
                    // Use a function that reads the current dataset.note value
                    key.addEventListener('click', function() {
                        toggleNote(this.dataset.note, this);
                    });
                    octaveDiv.appendChild(key);
                });
                
                // Black keys
                const blackKeyPattern = [1, 3, 6, 8, 10]; // C#, D#, F#, G#, A#
                // Position represents the white key whose right border we center on
                // C# after C (1), D# after D (2), F# after F (4), G# after G (5), A# after A (6)
                const blackKeyPositions = [1, 2, 4, 5, 6];
                
                blackKeyPattern.forEach((noteIndex, i) => {
                    const key = document.createElement('div');
                    key.className = 'black-key';
                    const noteName = noteNames[noteIndex];
                    const fullNoteName = `${noteName}${octave}`;
                    key.dataset.note = fullNoteName;
                    key.dataset.noteIndex = noteIndex;
                    
                    const label = document.createElement('div');
                    label.className = 'key-label';
                    label.textContent = noteName;
                    key.appendChild(label);
                    
                    // Store position data for later calculation
                    key.dataset.blackKeyPosition = blackKeyPositions[i];
                    
                    // Use a function that reads the current dataset.note value
                    key.addEventListener('click', function() {
                        toggleNote(this.dataset.note, this);
                    });
                    octaveDiv.appendChild(key);
                });
                
                piano.appendChild(octaveDiv);
            }
            
            // Position black keys after all elements are in the DOM
            requestAnimationFrame(() => {
                positionBlackKeys(pianoId);
            });
        }
        
        function positionBlackKeys(pianoId = null) {
            // If pianoId is specified, only work with that piano's keys
            const selector = pianoId ? `#${pianoId} ` : '';
            const whiteKeys = document.querySelectorAll(`${selector}.white-key`);
            const blackKeys = document.querySelectorAll(`${selector}.black-key`);
            
            if (whiteKeys.length === 0 || blackKeys.length === 0) return;
            
            // Get actual computed widths
            const whiteKeyWidth = whiteKeys[0].offsetWidth;
            const blackKeyWidth = blackKeys[0].offsetWidth;
            
            // Group keys by octave
            const octaves = {};
            whiteKeys.forEach(key => {
                const octaveDiv = key.closest('.octave');
                if (octaveDiv) {
                    if (!octaves[octaveDiv]) {
                        octaves[octaveDiv] = { whiteKeys: [], blackKeys: [] };
                    }
                    octaves[octaveDiv].whiteKeys.push(key);
                }
            });
            
            blackKeys.forEach(key => {
                const octaveDiv = key.closest('.octave');
                if (octaveDiv && octaves[octaveDiv]) {
                    octaves[octaveDiv].blackKeys.push(key);
                }
            });
            
            // Position black keys within each octave
            Object.values(octaves).forEach(octave => {
                octave.blackKeys.forEach(key => {
                    const position = parseFloat(key.dataset.blackKeyPosition);
                    const leftPosition = (position * whiteKeyWidth) - (blackKeyWidth / 2);
                    key.style.left = `${leftPosition}px`;
                });
            });
        }
        
        // Reposition on window resize for responsive behavior
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                // Recreate both pianos with appropriate number of octaves
                const currentSelectedNotes = new Set(selectedNotes);
                
                // Recreate main piano
                createPiano('piano');
                
                // Recreate staff piano if it exists
                if (document.getElementById('staffPiano')) {
                    createPiano('staffPiano');
                }
                
                // Restore selected notes if they exist in the new octave range
                currentSelectedNotes.forEach(note => {
                    const key = document.querySelector(`[data-note="${note}"]`);
                    if (key) {
                        selectedNotes.add(note);
                        key.classList.add('active');
                    }
                });
            }, 250); // Debounce resize events
        });

        function toggleNote(noteName, keyElement) {
            // Different behavior based on active tab
            if (currentTab === 'staff') {
                // Practice mode: draw note on staff
                if (currentLevel === 'Practicar') {
                    // Get note index and octave from key element
                    const noteIndex = parseInt(keyElement.dataset.noteIndex);
                    // Extract octave from note name (e.g., "Do4" -> 4, "Sol3" -> 3)
                    const octaveMatch = noteName.match(/\d+$/);
                    if (!octaveMatch) return; // Invalid note name
                    const octave = parseInt(octaveMatch[0]);
                    
                    // Calculate X position: start at 150, add 30 for each note
                    const startX = 150;
                    const spacing = 30;
                    const xPosition = startX + (practiceNotes.length * spacing);
                    const maxX = 750; // Don't go beyond the staff end
                    
                    // Stop if we would exceed the staff width
                    if (xPosition > maxX) return;
                    
                    // Add note to practice notes array
                    practiceNotes.push({
                        noteIndex: noteIndex,
                        octave: octave,
                        x: xPosition,
                        noteName: noteName
                    });
                    
                    // Draw the note on the staff
                    drawPracticeNoteOnStaff(noteIndex, octave, xPosition, noteName);
                    
                    // Visual feedback: highlight key briefly
                    keyElement.classList.add('active');
                    setTimeout(() => {
                        keyElement.classList.remove('active');
                    }, 300);
                    
                    return;
                }
                
                // Normal staff tab behavior for other levels
                // Clear previous selection
                document.querySelectorAll('#staffPiano .white-key.active, #staffPiano .black-key.active').forEach(key => {
                    key.classList.remove('active');
                });
                
                // Select new note
                selectedNotes.clear();
                selectedNotes.add(noteName);
                keyElement.classList.add('active');
                
                // If exercise is active, automatically check answer
                if (exerciseActive && window.currentStaffNote) {
                    checkAnswer();
                }
            } else {
                // In chords tab: original behavior (multiple notes)
                if (selectedNotes.has(noteName)) {
                    selectedNotes.delete(noteName);
                    keyElement.classList.remove('active');
                } else {
                    selectedNotes.add(noteName);
                    keyElement.classList.add('active');
                }
                
                identifyChord();
            }
        }

        function identifyChord() {
            const insightsBtn = document.getElementById('insightsBtn');
            const otherChordsBtn = document.getElementById('otherChordsBtn');
            const t = translations[currentLanguage];
            
            if (selectedNotes.size === 0) {
                updateChordInfo(t.defaultChordName, t.defaultChordNotes, t.defaultChordType);
                currentChord = null;
                insightsBtn.classList.remove('active');
                otherChordsBtn.classList.remove('active');
                return;
            }

            const noteIndexes = Array.from(selectedNotes).map(note => {
                // Extract note name by removing the octave number at the end
                const noteName = note.replace(/\d+$/, '');
                return noteNames.indexOf(noteName);
            }).sort((a, b) => a - b);

            // Activate "Otros Acordes" button only when 1 or 3+ notes are selected
            if (noteIndexes.length === 1 || noteIndexes.length >= 3) {
                otherChordsBtn.classList.add('active');
            } else {
                otherChordsBtn.classList.remove('active');
            }

            if (noteIndexes.length < 2) {
                const noteName = noteNames[noteIndexes[0]];
                updateChordInfo(noteName, t.singleNote, t.addMoreNotes);
                currentChord = null;
                insightsBtn.classList.remove('active');
                return;
            }

            // Try each note as a potential root
            let foundChord = null;
            
            for (let i = 0; i < noteIndexes.length; i++) {
                const root = noteIndexes[i];
                const intervals = noteIndexes.map(note => (note - root + 12) % 12).sort();
                
                // Look up chord pattern
                const patternKey = intervals.join(',');
                const possibleChords = intervalPatterns[patternKey];
                
                if (possibleChords && possibleChords.length > 0) {
                    foundChord = {
                        root: root,
                        intervals: intervals,
                        chordType: possibleChords[0],
                        alternativeNames: possibleChords.slice(1) // Store alternative names
                    };
                    break; // Found a match, stop searching
                }
            }
            
            if (foundChord) {
                const rootNote = noteNames[foundChord.root];
                const chordType = foundChord.chordType;
                let chordName = rootNote + chordType;
                
                // Add alternative names in parentheses if they exist
                if (foundChord.alternativeNames && foundChord.alternativeNames.length > 0) {
                    const altNames = foundChord.alternativeNames.map(alt => rootNote + alt).join(', ');
                    chordName += ` (${altNames})`;
                }
                
                const notes = foundChord.intervals.map(interval => noteNames[(foundChord.root + interval) % 12]).join(', ');
                const description = getChordDescription(chordType);
                
                updateChordInfo(chordName, `${t.notes}: ${notes}`, description);
                
                // Store the chord with the anglo root for internal processing
                const angloNoteNames = notations.anglo;
                const angloRoot = currentNotation === 'italian' ? (italianToAnglo[rootNote] || rootNote) : rootNote;
                currentChord = { name: chordName, root: angloRoot, type: chordType };
                insightsBtn.classList.add('active');
            } else {
                const notes = noteIndexes.map(note => noteNames[note]).join(', ');
                updateChordInfo(t.unknownChord, `${t.notes}: ${notes}`, t.noMatch);
                currentChord = null;
                insightsBtn.classList.remove('active');
            }
        }

        function getChordDescription(chordType) {
            const descriptions = {
                'maj': 'Major triad',
                'M': 'Major triad',
                '': 'Major triad',
                'm': 'Minor triad',
                'min': 'Minor triad',
                '-': 'Minor triad',
                '5': 'Power chord (5th)',
                'pow': 'Power chord (5th)',
                '7': 'Dominant 7th',
                'maj7': 'Major 7th',
                'M7': 'Major 7th',
                'm7': 'Minor 7th',
                'dim': 'Diminished triad',
                'dim7': 'Diminished 7th',
                'm7b5': 'Half-diminished 7th',
                'aug': 'Augmented triad',
                'sus2': 'Suspended 2nd',
                'sus4': 'Suspended 4th',
                '6': 'Major 6th',
                'm6': 'Minor 6th',
                '9': 'Dominant 9th',
                'maj9': 'Major 9th',
                'M9': 'Major 9th',
                'm9': 'Minor 9th',
                '11': 'Dominant 11th',
                'maj11': 'Major 11th',
                'M11': 'Major 11th',
                'm11': 'Minor 11th',
                '13': 'Dominant 13th',
                'maj13': 'Major 13th',
                'M13': 'Major 13th',
                'm13': 'Minor 13th',
                'add9': 'Add 9th',
                'madd9': 'Minor add 9th',
                'add11': 'Add 11th',
                'madd11': 'Minor add 11th',
                '7#5': 'Dominant 7th sharp 5',
                '7b5': 'Dominant 7th flat 5',
                '7#9': 'Dominant 7th sharp 9',
                '7b9': 'Dominant 7th flat 9',
                '7#11': 'Dominant 7th sharp 11',
                'mmaj7': 'Minor major 7th',
                'm(maj7)': 'Minor major 7th',
                '7sus2': 'Dominant 7th sus2',
                '7sus4': 'Dominant 7th sus4'
            };
            return descriptions[chordType] || 'Complex chord';
        }

        function findChord() {
            const input = document.getElementById('chordInput').value.trim();
            const insightsBtn = document.getElementById('insightsBtn');
            const t = translations[currentLanguage];
            
            if (!input) return;

            const result = parseChordName(input);
            if (!result) {
                updateChordInfo(t.invalidChord, `"${input}" ${t.isNotRecognized}`, t.tryFormats);
                currentChord = null;
                insightsBtn.classList.remove('active');
                return;
            }

            const { root, chordType } = result;
            const intervals = chordDatabase[chordType];
            
            if (intervals) {
                // Clear previous selection
                clearSelection();
                
                // Calculate and select notes (using anglo notation internally)
                const angloNoteNames = notations.anglo;
                const rootIndex = angloNoteNames.indexOf(root);
                const chordNotesAnglo = intervals.map(interval => {
                    const noteIndex = (rootIndex + interval) % 12;
                    return angloNoteNames[noteIndex];
                });
                
                // Convert notes to current notation for display
                const chordNotesDisplay = chordNotesAnglo.map(note => 
                    currentNotation === 'italian' ? (angloToItalian[note] || note) : note
                );
                
                // Select notes on piano (looking for any octave in available range)
                const numOctaves = getNumberOfOctaves();
                const startOctave = 2;
                const endOctave = startOctave + numOctaves - 1;
                
                chordNotesAnglo.forEach((angloNote, idx) => {
                    const displayNote = chordNotesDisplay[idx];
                    for (let octave = startOctave; octave <= endOctave; octave++) {
                        const fullNoteName = `${displayNote}${octave}`;
                        const keyElement = document.querySelector(`[data-note="${fullNoteName}"]`);
                        if (keyElement && !selectedNotes.has(fullNoteName)) {
                            selectedNotes.add(fullNoteName);
                            keyElement.classList.add('active');
                            break; // Only select first occurrence
                        }
                    }
                });
                
                // Convert chord name to current notation
                const rootDisplay = currentNotation === 'italian' ? (angloToItalian[root] || root) : root;
                const chordName = rootDisplay + chordType;
                const description = getChordDescription(chordType);
                updateChordInfo(chordName, `${t.notes}: ${chordNotesDisplay.join(', ')}`, description);
                currentChord = { name: chordName, root: root, type: chordType };
                insightsBtn.classList.add('active');
            } else {
                updateChordInfo(t.unknownChordType, `${t.chordTypeNotFound} "${chordType}"`, t.tryCommonTypes);
                currentChord = null;
                insightsBtn.classList.remove('active');
            }
        }

        function parseChordName(chordName) {
            // Remove spaces and convert to standard format
            chordName = chordName.replace(/\s/g, '');

            let root = null;
            let chordType = '';
            
            // Try to match Italian notation first (Do, Re, Mi, Fa, Sol, La, Si)
            const italianMatch = chordName.match(/^(Do|Re|Mi|Fa|Sol|La|Si)([#b]?)/i);
            if (italianMatch) {
                const italianNote = italianMatch[1].charAt(0).toUpperCase() + italianMatch[1].slice(1).toLowerCase();
                const accidental = italianMatch[2];
                const fullItalianNote = italianNote + accidental;
                
                // Convert to Anglo notation for internal processing
                root = italianToAnglo[fullItalianNote] || italianToAnglo[italianNote];
                chordType = chordName.slice(italianMatch[0].length);
            } else {
                // Try Anglo notation (A-G)
                const angloMatch = chordName.match(/^([A-G][#b]?)/);
                if (!angloMatch) return null;
                
                root = angloMatch[1];
                chordType = chordName.slice(root.length);
            }

            if (!root) return null;

            // Convert flats to sharps for consistency
            const normalizedRoot = root.replace('Db', 'C#').replace('Eb', 'D#').replace('Gb', 'F#')
                                      .replace('Ab', 'G#').replace('Bb', 'A#');

            // Check if chord type exists
            if (chordDatabase.hasOwnProperty(chordType)) {
                return { root: normalizedRoot, chordType };
            }

            return null;
        }

        function clearAll() {
            const t = translations[currentLanguage];
            clearSelection();
            document.getElementById('chordInput').value = '';
            updateChordInfo(t.defaultChordName, t.defaultChordNotes, t.defaultChordType);
            currentChord = null;
            document.getElementById('insightsBtn').classList.remove('active');
            document.getElementById('otherChordsBtn').classList.remove('active');
        }

        function clearSelection() {
            selectedNotes.clear();
            document.querySelectorAll('.white-key, .black-key').forEach(key => {
                key.classList.remove('active');
            });
        }

        function updateChordInfo(name, notes, type) {
            const chordNameElement = document.querySelector('.chord-name');
            
            // Check if name contains alternative names in parentheses
            if (name.includes('(') && name.includes(')')) {
                // Split the name into main part and alternatives
                const mainPart = name.substring(0, name.indexOf('(')).trim();
                const altPart = name.substring(name.indexOf('('));
                // Use innerHTML to style alternatives with normal font-weight
                chordNameElement.innerHTML = `${mainPart} <span style="font-weight: normal;">${altPart}</span>`;
            } else {
                chordNameElement.textContent = name;
            }
            
            document.querySelector('.chord-notes').textContent = notes;
            document.querySelector('.chord-type').textContent = type;
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }


        function showChordInfo() {
            if (!currentChord) return;
            
            const t = translations[currentLanguage];
            const modal = document.getElementById('insightsModal');
            const modalChordName = document.getElementById('modalChordName');
            const modalBody = document.getElementById('modalBody');
            
            modalChordName.textContent = `${currentChord.name} - ${t.modalChordInfo}`;
            modal.style.display = 'block';
            
            // Get chord information from our database
            const chordInfo = getChordInfo(currentChord);

                modalBody.innerHTML = `
                    <div class="insight-section">
                    <h3>${t.chordStructure}</h3>
                    <p><strong>${t.chordStructureNotes}</strong> ${chordInfo.notes || t.infoNotAvailable}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.soundCharacteristics}</h3>
                    <p>${chordInfo.characteristics}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.keyAspects}</h3>
                    <p>${chordInfo.keyAspects}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.commonUsage}</h3>
                    <p>${chordInfo.commonUsage}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.famousSongs}</h3>
                    <p>${chordInfo.famousSongs}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.chordProgressions}</h3>
                    <p>${chordInfo.progressions}</p>
                    </div>
                    
                    <div class="insight-section">
                        <h3>${t.pianoTips}</h3>
                    <p>${chordInfo.tips}</p>
                    </div>

                    <div class="insight-section">
                    <h3>${t.learnMore}</h3>
                    <p>${t.learnMoreText} ${currentChord.name}? ${t.learnMoreResources}</p>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                        <button onclick="openGrok('${currentChord.name}')" class="insights-btn active" style="padding:8px 14px; font-size:0.95em; background: #00bcd4; color: white;">üß† Grok AI</button>
                        <button onclick="openPerplexity('${currentChord.name}')" class="insights-btn active" style="padding:8px 14px; font-size:0.95em; background: #9c27b0; color: white;">ü§ñ Perplexity AI</button>
                        <button onclick="openChordBook('${currentChord.name}')" class="clear-btn" style="padding:8px 14px; font-size:0.95em; background: #f8f9fa; color:#333; border:1px solid #ddd;">üéπ Piano Chords</button>
                        </div>
                    </div>
                `;
        }

        // Chord information database - English
        const chordInfoDatabase_en = {
            // Major chords
            'maj': {
                notes: 'Root + 3M + 5',
                characteristics: 'Bright, stable and consonant sound that forms the foundation of most Western music. It has a sense of resolution and completeness.',
                keyAspects: 'The major third interval creates brightness and stability. Often called the "happy" chord.',
                commonUsage: 'Used as tonic chords (I) in major keys, dominant chords (V) in other keys, and as stable harmonies in pop, rock, classical, and jazz.',
                famousSongs: '"Let It Be" by The Beatles (C major), "Stairway to Heaven" by Led Zeppelin (A major), "Imagine" by John Lennon (C major).',
                progressions: 'I-IV-V-I (the most common progression), I-vi-IV-V, I-V-vi-IV, ii-V-I (jazz turnaround).',
                tips: 'Play root position first, then try first inversion (third in bass) for smoother voice leading. Add 6th for color or 9th for jazz feel.'
            },
            '': {
                notes: 'Root + 3M + 5',
                characteristics: 'Bright, stable and consonant sound that forms the foundation of most Western music. It has a sense of resolution and completeness.',
                keyAspects: 'The major third interval creates brightness and stability. Often called the "happy" chord.',
                commonUsage: 'Used as tonic chords (I) in major keys, dominant chords (V) in other keys, and as stable harmonies in pop, rock, classical, and jazz.',
                famousSongs: '"Let It Be" by The Beatles (C major), "Stairway to Heaven" by Led Zeppelin (A major), "Imagine" by John Lennon (C major).',
                progressions: 'I-IV-V-I (the most common progression), I-vi-IV-V, I-V-vi-IV, ii-V-I (jazz turnaround).',
                tips: 'Play root position first, then try first inversion (third in bass) for smoother voice leading. Add 6th for color or 9th for jazz feel.'
            },

            // Minor chords
            'm': {
                notes: 'Root + 3m + 5',
                characteristics: 'Darker, more emotional sound with a melancholic or serious quality. Less stable than major chords.',
                keyAspects: 'The minor third creates emotional depth and tension. Often called the "sad" chord.',
                commonUsage: 'Used as tonic chords (i) in minor keys, vi chords in major keys, and for emotional expression in ballads, rock, and classical.',
                famousSongs: '"Stairway to Heaven" by Led Zeppelin (Am), "Nothing Else Matters" by Metallica (Em), "Hurt" by Johnny Cash (Am).',
                progressions: 'i-IV-V-i (minor blues), i-iv-i (minor tonic), i-VI-III-VII (harmonic minor), vi-IV-I-V (pop ballad).',
                tips: 'Try different voicings - root position, first inversion, or second inversion. Add 7th for more tension or 9th for jazz minor.'
            },
            'min': {
                notes: 'Root + 3m + 5',
                characteristics: 'Darker, more emotional sound with a melancholic or serious quality. Less stable than major chords.',
                keyAspects: 'The minor third creates emotional depth and tension. Often called the "sad" chord.',
                commonUsage: 'Used as tonic chords (i) in minor keys, vi chords in major keys, and for emotional expression in ballads, rock, and classical.',
                famousSongs: '"Stairway to Heaven" by Led Zeppelin (Am), "Nothing Else Matters" by Metallica (Em), "Hurt" by Johnny Cash (Am).',
                progressions: 'i-IV-V-i (minor blues), i-iv-i (minor tonic), i-VI-III-VII (harmonic minor), vi-IV-I-V (pop ballad).',
                tips: 'Try different voicings - root position, first inversion, or second inversion. Add 7th for more tension or 9th for jazz minor.'
            },
            '-': {
                notes: 'Root + 3m + 5',
                characteristics: 'Darker, more emotional sound with a melancholic or serious quality. Less stable than major chords.',
                keyAspects: 'The minor third creates emotional depth and tension. Often called the "sad" chord.',
                commonUsage: 'Used as tonic chords (i) in minor keys, vi chords in major keys, and for emotional expression in ballads, rock, and classical.',
                famousSongs: '"Stairway to Heaven" by Led Zeppelin (Am), "Nothing Else Matters" by Metallica (Em), "Hurt" by Johnny Cash (Am).',
                progressions: 'i-IV-V-i (minor blues), i-iv-i (minor tonic), i-VI-III-VII (harmonic minor), vi-IV-I-V (pop ballad).',
                tips: 'Try different voicings - root position, first inversion, or second inversion. Add 7th for more tension or 9th for jazz minor.'
            },

            // Dominant 7th
            '7': {
                notes: 'Root + 3M + 5 + 7m',
                characteristics: 'Tense, directional sound that strongly pulls toward resolution. Has a bluesy, sophisticated quality.',
                keyAspects: 'The minor seventh creates strong tension that demands resolution, usually to the tonic.',
                commonUsage: 'Used as dominant chords (V7) in major keys, for blues progressions, and jazz harmony. Creates strong cadential movement.',
                famousSongs: '"Hit the Road Jack" by Ray Charles (C7), "Satin Doll" by Duke Ellington (Bb7), "All Blues" by Miles Davis (Bb7).',
                progressions: 'I7-IV7-V7-I7 (blues), ii7-V7-Imaj7 (jazz ii-V-I), V7-I (perfect cadence), I-VI7-II7-V7 (ragtime).',
                tips: 'Emphasize the 7th and 3rd in your voicing. Try drop-2 voicings for jazz comping. Resolve the 7th down to the 3rd of the next chord.'
            },

            // Major 7th
            'maj7': {
                notes: 'Root + 3M + 5 + 7M',
                characteristics: 'Smooth, sophisticated sound with a dreamy, suspended quality. Less tense than dominant 7th.',
                keyAspects: 'The major seventh adds color and sophistication without strong directional pull.',
                commonUsage: 'Used in jazz as tonic chords (Imaj7), pop for sophisticated harmony, and classical for added color.',
                famousSongs: '"What a Wonderful World" by Louis Armstrong (Imaj7), "Autumn Leaves" by Joseph Kosma (Amaj7), "Blue Bossa" by Kenny Dorham (Cmaj7).',
                progressions: 'Imaj7-vi7-ii7-V7 (jazz), Imaj7-IVmaj7-IImaj7-V7, I-VIImaj7-III7-VImaj7 (extended jazz).',
                tips: 'Voice the major 7th on top for brightness. Try close voicings or spread voicings. Works well as polychords over other harmonies.'
            },

            // Minor 7th
            'm7': {
                notes: 'Root + 3m + 5 + 7m',
                characteristics: 'Warm, relaxed sound with subtle tension. More sophisticated than plain minor.',
                keyAspects: 'Combines minor triad with minor seventh for smooth, jazzy quality.',
                commonUsage: 'Used as ii7 chords in major keys, i7 in minor keys, and for smooth jazz harmony.',
                famousSongs: '"Take Five" by Dave Brubeck (Em7), "So What" by Miles Davis (Dm7), "Blue in Green" by Bill Evans (Am7).',
                progressions: 'ii7-V7-Imaj7 (most common jazz progression), i7-iv7-VII7, Dm7-G7-Cmaj7 (classic ii-V-I).',
                tips: 'Try shell voicings (root, 3rd, 7th) for comping. Use as passing chords between more stable harmonies.'
            },

            // Diminished
            'dim': {
                notes: 'Root + 3m + 5b',
                characteristics: 'Unstable, tense sound with mysterious, dramatic quality. Highly dissonant.',
                keyAspects: 'Symmetrical structure allows for multiple interpretations. Strong sense of needing resolution.',
                commonUsage: 'Used as leading-tone chords (vii¬∞) toward tonic, passing chords, and for dramatic effect.',
                famousSongs: '"The Entertainer" by Scott Joplin (multiple dim chords), "Giant Steps" by John Coltrane (as passing chords), "Caravan" by Duke Ellington.',
                progressions: 'vii¬∞-I (authentic cadence in minor), I-II¬∞-III-IV¬∞-V, as passing chords between major/minor chords.',
                tips: 'Play softly and resolve quickly. Try different inversions - each has different tension levels. Great for transitions.'
            },

            // Diminished 7th
            'dim7': {
                notes: 'Root + 3m + 5b + 7bb',
                characteristics: 'Highly tense, ambiguous sound that can resolve to any chord a half-step away.',
                keyAspects: 'Symmetrical structure (minor thirds) creates maximum tension and multiple resolution possibilities.',
                commonUsage: 'Used as passing chords, for chromatic movement, and in classical and jazz for dramatic effect.',
                famousSongs: '"Misty" by Erroll Garner (as passing chord), "Cherokee" by Ray Noble (chromatic approach), "Giant Steps" by John Coltrane.',
                progressions: 'V7-#IV¬∞7-#iv¬∞7-iii7, as approach chords to any target, I7-II7-III7-IV7 (whole-tone scale).',
                tips: 'Resolve to chords a half-step above or below. Try different voicings to emphasize different notes as resolution targets.'
            },

            // Minor 7th flat 5 (half-diminished)
            'm7b5': {
                notes: 'Root + 3m + 5b + 7m',
                characteristics: 'Tense, sophisticated sound with bluesy and jazzy qualities. Less harsh than full diminished.',
                keyAspects: 'Combines minor triad with diminished fifth and minor seventh. Creates strong pull toward resolution.',
                commonUsage: 'Used as ii√∏7 in minor keys, for jazz harmony, and as passing chords.',
                famousSongs: '"Autumn Leaves" by Joseph Kosma (D√∏7), "There Will Never Be Another You" (ii√∏7-V7-i), "Stella by Starlight" (multiple √∏7 chords).',
                progressions: 'ii√∏7-V7-i (jazz minor), i-ii√∏7-V7-i, IV-VII√∏7-III7-VI7 (harmonic minor).',
                tips: 'Voice with the b5 on top for tension. Resolve 7th down to 3rd, b5 up to 5th. Essential for jazz harmony.'
            },

            // Augmented
            'aug': {
                notes: 'Root + 3M + 5#',
                characteristics: 'Bright, ambiguous sound with floating, unresolved quality. Creates tension without direction.',
                keyAspects: 'Symmetrical augmented fifth creates ambiguity - can sound like major or minor depending on context.',
                commonUsage: 'Used as passing chords, for modulation, and in impressionist classical music.',
                famousSongs: '"The Simpsons" theme (Caug as passing chord), "Giant Steps" by Coltrane (augmented approaches), "Black Narcissus" by Joe Henderson.',
                progressions: 'I+ - #IV¬∞ - bVII, as passing between major chords, III+ - vi - IV (impressionist).',
                tips: 'Use as approach chords to other harmonies. The augmented fifth can resolve up or down chromatically.'
            },

            // Suspended chords
            'sus2': {
                notes: 'Root + 2M + 5',
                characteristics: 'Open, ethereal sound with subtle tension. Less directional than sus4.',
                keyAspects: 'Replaces the third with a second, creating an open, ambiguous quality.',
                commonUsage: 'Used in pop and rock for atmospheric sounds, as approach chords, and for modern harmony.',
                famousSongs: '"Dust in the Wind" by Kansas (Gsus2), "Horse with No Name" by America (sus2 chords), "More Than Words" by Extreme.',
                progressions: 'I-sus2-I (resolution), I-IIIsus2-IV-V, sus2 as passing chords between major/minor.',
                tips: 'Resolve the 2nd up to 3rd for smooth resolution. Try adding 4th on top for 6/9 sound. Great for intros and bridges.'
            },

            'sus4': {
                notes: 'Root + 4M + 5',
                characteristics: 'Tense, anticipatory sound that strongly pulls toward resolution. More directional than sus2.',
                keyAspects: 'Replaces the third with a fourth, creating strong tension that demands resolution.',
                commonUsage: 'Used in rock, pop, and folk for rhythmic interest and as approach chords.',
                famousSongs: '"Dream On" by Aerosmith (Dsus4), "Let It Be" by The Beatles (sus4 resolutions), "Under the Bridge" by Red Hot Chili Peppers.',
                progressions: 'I-sus4-I (classic resolution), I-IV-sus4-IV-I, V-sus4-V-I, ii-sus4-ii-V.',
                tips: 'Resolve the 4th down to 3rd for strong resolution. Use on beats 2 and 4 in rhythm. Add 7th for more tension.'
            },

            // 6th chords
            '6': {
                notes: 'Root + 3M + 5 + 6M',
                characteristics: 'Bright, colorful sound with added sweetness and stability. More complex than major triad.',
                keyAspects: 'Adds the sixth for color while maintaining major quality. Less tense than 7th chords.',
                commonUsage: 'Used in classical music, jazz, and pop for added color and as tonic chords with sophistication.',
                famousSongs: '"Michelle" by The Beatles (A6), "It Had to Be You" (6th chords in bridge), "My Funny Valentine" (6th approach).',
                progressions: 'I6-IV-I, I6-ii7-V7-I, as substitute for I chord in major keys.',
                tips: 'Try first inversion (6th in bass) for smoother voice leading. Use as approach to dominant chords.'
            },

            'm6': {
                notes: 'Root + 3m + 5 + 6M',
                characteristics: 'Rich, emotional sound with bittersweet quality. More complex than minor triad.',
                keyAspects: 'Combines minor triad with major sixth for unique, melancholic color.',
                commonUsage: 'Used in classical music, jazz, and as substitute for i chords in minor keys.',
                famousSongs: '"Autumn Leaves" by Joseph Kosma (Am6), "Cry Me a River" by Arthur Hamilton, "Blackbird" by The Beatles.',
                progressions: 'i6-VI7-V7-i, i6-iv-i, as passing chords in minor keys.',
                tips: 'Voice the 6th on top for brightness. Try different inversions for color variations.'
            },

            // 9th chords
            '9': {
                notes: 'Root + 3M + 5 + 7m + 9M',
                characteristics: 'Rich, complex sound with added tension and sophistication. Highly colorful.',
                keyAspects: 'Adds the 9th (major ninth) for extended harmony. Creates lush, jazzy quality.',
                commonUsage: 'Used in jazz and sophisticated pop as dominant chords with added color.',
                famousSongs: '"Blue Bossa" by Kenny Dorham (9th chords), "So What" by Miles Davis (9ths), "Take Five" by Dave Brubeck.',
                progressions: 'ii9-V9-Imaj7, I9-IV9-I9, as colorful substitutes for 7th chords.',
                tips: 'Omit the 5th in voicings to avoid clutter. Try quartal voicings. Resolve 9th appropriately based on context.'
            },

            'm9': {
                notes: 'Root + 3m + 5 + 7m + 9M',
                characteristics: 'Smooth, sophisticated sound with subtle tension. More refined than m7.',
                keyAspects: 'Combines minor 7th with major 9th for smooth, jazzy quality.',
                commonUsage: 'Used in jazz as i9 chords, for sophisticated harmony, and as passing chords.',
                famousSongs: '"There Will Never Be Another You" (minor 9ths), "Stella by Starlight", "My Funny Valentine".',
                progressions: 'i9-iv9-VII9, ii9-V9-i9, as substitutes for ii√∏7-V7-i.',
                tips: 'Voice the 9th on top for brightness. Try shell voicings with 9th added. Great for ballads.'
            }
        };

        // Chord information database - Spanish
        const chordInfoDatabase_es = {
            // Major chords
            'maj': {
                notes: 'T√≥nica + 3M + 5',
                characteristics: 'Sonido brillante, estable y consonante que forma la base de la mayor√≠a de la m√∫sica occidental. Tiene una sensaci√≥n de resoluci√≥n y completitud.',
                keyAspects: 'El intervalo de tercera mayor crea brillo y estabilidad. A menudo llamado el acorde "feliz".',
                commonUsage: 'Usado como acordes t√≥nicos (I) en tonalidades mayores, acordes dominantes (V) en otras tonalidades, y como armon√≠as estables en pop, rock, cl√°sica y jazz.',
                famousSongs: '"Let It Be" de The Beatles (Do mayor), "Stairway to Heaven" de Led Zeppelin (La mayor), "Imagine" de John Lennon (Do mayor).',
                progressions: 'I-IV-V-I (la progresi√≥n m√°s com√∫n), I-vi-IV-V, I-V-vi-IV, ii-V-I (turnaround de jazz).',
                tips: 'Toca primero la posici√≥n fundamental, luego prueba la primera inversi√≥n (tercera en el bajo) para una conducci√≥n de voces m√°s suave. A√±ade la 6¬™ para color o la 9¬™ para un aire jazz.'
            },
            '': {
                notes: 'T√≥nica + 3M + 5',
                characteristics: 'Sonido brillante, estable y consonante que forma la base de la mayor√≠a de la m√∫sica occidental. Tiene una sensaci√≥n de resoluci√≥n y completitud.',
                keyAspects: 'El intervalo de tercera mayor crea brillo y estabilidad. A menudo llamado el acorde "feliz".',
                commonUsage: 'Usado como acordes t√≥nicos (I) en tonalidades mayores, acordes dominantes (V) en otras tonalidades, y como armon√≠as estables en pop, rock, cl√°sica y jazz.',
                famousSongs: '"Let It Be" de The Beatles (Do mayor), "Stairway to Heaven" de Led Zeppelin (La mayor), "Imagine" de John Lennon (Do mayor).',
                progressions: 'I-IV-V-I (la progresi√≥n m√°s com√∫n), I-vi-IV-V, I-V-vi-IV, ii-V-I (turnaround de jazz).',
                tips: 'Toca primero la posici√≥n fundamental, luego prueba la primera inversi√≥n (tercera en el bajo) para una conducci√≥n de voces m√°s suave. A√±ade la 6¬™ para color o la 9¬™ para un aire jazz.'
            },

            // Minor chords
            'm': {
                notes: 'T√≥nica + 3m + 5',
                characteristics: 'Sonido m√°s oscuro y emocional con una cualidad melanc√≥lica o seria. Menos estable que los acordes mayores.',
                keyAspects: 'La tercera menor crea profundidad emocional y tensi√≥n. A menudo llamado el acorde "triste".',
                commonUsage: 'Usado como acordes t√≥nicos (i) en tonalidades menores, acordes vi en tonalidades mayores, y para expresi√≥n emocional en baladas, rock y cl√°sica.',
                famousSongs: '"Stairway to Heaven" de Led Zeppelin (Lam), "Nothing Else Matters" de Metallica (Mim), "Hurt" de Johnny Cash (Lam).',
                progressions: 'i-IV-V-i (blues menor), i-iv-i (t√≥nica menor), i-VI-III-VII (menor arm√≥nico), vi-IV-I-V (balada pop).',
                tips: 'Prueba diferentes posiciones: fundamental, primera inversi√≥n o segunda inversi√≥n. A√±ade la 7¬™ para m√°s tensi√≥n o la 9¬™ para menor jazz.'
            },
            'min': {
                notes: 'T√≥nica + 3m + 5',
                characteristics: 'Sonido m√°s oscuro y emocional con una cualidad melanc√≥lica o seria. Menos estable que los acordes mayores.',
                keyAspects: 'La tercera menor crea profundidad emocional y tensi√≥n. A menudo llamado el acorde "triste".',
                commonUsage: 'Usado como acordes t√≥nicos (i) en tonalidades menores, acordes vi en tonalidades mayores, y para expresi√≥n emocional en baladas, rock y cl√°sica.',
                famousSongs: '"Stairway to Heaven" de Led Zeppelin (Lam), "Nothing Else Matters" de Metallica (Mim), "Hurt" de Johnny Cash (Lam).',
                progressions: 'i-IV-V-i (blues menor), i-iv-i (t√≥nica menor), i-VI-III-VII (menor arm√≥nico), vi-IV-I-V (balada pop).',
                tips: 'Prueba diferentes posiciones: fundamental, primera inversi√≥n o segunda inversi√≥n. A√±ade la 7¬™ para m√°s tensi√≥n o la 9¬™ para menor jazz.'
            },
            '-': {
                notes: 'T√≥nica + 3m + 5',
                characteristics: 'Sonido m√°s oscuro y emocional con una cualidad melanc√≥lica o seria. Menos estable que los acordes mayores.',
                keyAspects: 'La tercera menor crea profundidad emocional y tensi√≥n. A menudo llamado el acorde "triste".',
                commonUsage: 'Usado como acordes t√≥nicos (i) en tonalidades menores, acordes vi en tonalidades mayores, y para expresi√≥n emocional en baladas, rock y cl√°sica.',
                famousSongs: '"Stairway to Heaven" de Led Zeppelin (Lam), "Nothing Else Matters" de Metallica (Mim), "Hurt" de Johnny Cash (Lam).',
                progressions: 'i-IV-V-i (blues menor), i-iv-i (t√≥nica menor), i-VI-III-VII (menor arm√≥nico), vi-IV-I-V (balada pop).',
                tips: 'Prueba diferentes posiciones: fundamental, primera inversi√≥n o segunda inversi√≥n. A√±ade la 7¬™ para m√°s tensi√≥n o la 9¬™ para menor jazz.'
            },

            // Dominant 7th
            '7': {
                notes: 'T√≥nica + 3M + 5 + 7m',
                characteristics: 'Sonido tenso y direccional que tira fuertemente hacia la resoluci√≥n. Tiene una cualidad bluesy y sofisticada.',
                keyAspects: 'La s√©ptima menor crea una tensi√≥n fuerte que exige resoluci√≥n, usualmente hacia la t√≥nica.',
                commonUsage: 'Usado como acordes dominantes (V7) en tonalidades mayores, para progresiones de blues y armon√≠a jazz. Crea fuerte movimiento cadencial.',
                famousSongs: '"Hit the Road Jack" de Ray Charles (Do7), "Satin Doll" de Duke Ellington (Sib7), "All Blues" de Miles Davis (Sib7).',
                progressions: 'I7-IV7-V7-I7 (blues), ii7-V7-Imaj7 (ii-V-I de jazz), V7-I (cadencia perfecta), I-VI7-II7-V7 (ragtime).',
                tips: 'Enfatiza la 7¬™ y la 3¬™ en tu disposici√≥n. Prueba drop-2 para acompa√±amiento jazz. Resuelve la 7¬™ bajando a la 3¬™ del siguiente acorde.'
            },

            // Major 7th
            'maj7': {
                notes: 'T√≥nica + 3M + 5 + 7M',
                characteristics: 'Sonido suave y sofisticado con una cualidad so√±adora y suspendida. Menos tenso que la s√©ptima dominante.',
                keyAspects: 'La s√©ptima mayor a√±ade color y sofisticaci√≥n sin fuerte atracci√≥n direccional.',
                commonUsage: 'Usado en jazz como acordes t√≥nicos (Imaj7), en pop para armon√≠a sofisticada, y en cl√°sica para a√±adir color.',
                famousSongs: '"What a Wonderful World" de Louis Armstrong (Imaj7), "Autumn Leaves" de Joseph Kosma (Lamaj7), "Blue Bossa" de Kenny Dorham (Domaj7).',
                progressions: 'Imaj7-vi7-ii7-V7 (jazz), Imaj7-IVmaj7-IImaj7-V7, I-VIImaj7-III7-VImaj7 (jazz extendido).',
                tips: 'Coloca la 7¬™ mayor arriba para brillo. Prueba disposiciones cerradas o abiertas. Funciona bien como policordios sobre otras armon√≠as.'
            },

            // Minor 7th
            'm7': {
                notes: 'T√≥nica + 3m + 5 + 7m',
                characteristics: 'Sonido c√°lido y relajado con tensi√≥n sutil. M√°s sofisticado que el menor simple.',
                keyAspects: 'Combina tr√≠ada menor con s√©ptima menor para una cualidad suave y jazzy.',
                commonUsage: 'Usado como acordes ii7 en tonalidades mayores, i7 en tonalidades menores, y para armon√≠a jazz suave.',
                famousSongs: '"Take Five" de Dave Brubeck (Mim7), "So What" de Miles Davis (Rem7), "Blue in Green" de Bill Evans (Lam7).',
                progressions: 'ii7-V7-Imaj7 (progresi√≥n jazz m√°s com√∫n), i7-iv7-VII7, Rem7-Sol7-Domaj7 (ii-V-I cl√°sico).',
                tips: 'Prueba shell voicings (t√≥nica, 3¬™, 7¬™) para acompa√±amiento. Usa como acordes de paso entre armon√≠as m√°s estables.'
            },

            // Diminished
            'dim': {
                notes: 'T√≥nica + 3m + 5b',
                characteristics: 'Sonido inestable y tenso con cualidad misteriosa y dram√°tica. Altamente disonante.',
                keyAspects: 'La estructura sim√©trica permite m√∫ltiples interpretaciones. Fuerte sensaci√≥n de necesitar resoluci√≥n.',
                commonUsage: 'Usado como acordes de sensible (vii¬∞) hacia la t√≥nica, acordes de paso, y para efecto dram√°tico.',
                famousSongs: '"The Entertainer" de Scott Joplin (m√∫ltiples acordes dim), "Giant Steps" de John Coltrane (como acordes de paso), "Caravan" de Duke Ellington.',
                progressions: 'vii¬∞-I (cadencia aut√©ntica en menor), I-II¬∞-III-IV¬∞-V, como acordes de paso entre acordes mayores/menores.',
                tips: 'Toca suavemente y resuelve r√°pido. Prueba diferentes inversiones - cada una tiene diferentes niveles de tensi√≥n. Genial para transiciones.'
            },

            // Diminished 7th
            'dim7': {
                notes: 'T√≥nica + 3m + 5b + 7bb',
                characteristics: 'Sonido altamente tenso y ambiguo que puede resolver a cualquier acorde a medio tono de distancia.',
                keyAspects: 'La estructura sim√©trica (terceras menores) crea m√°xima tensi√≥n y m√∫ltiples posibilidades de resoluci√≥n.',
                commonUsage: 'Usado como acordes de paso, para movimiento crom√°tico, y en cl√°sica y jazz para efecto dram√°tico.',
                famousSongs: '"Misty" de Erroll Garner (como acorde de paso), "Cherokee" de Ray Noble (aproximaci√≥n crom√°tica), "Giant Steps" de John Coltrane.',
                progressions: 'V7-#IV¬∞7-#iv¬∞7-iii7, como acordes de aproximaci√≥n a cualquier objetivo, I7-II7-III7-IV7 (escala de tonos enteros).',
                tips: 'Resuelve a acordes a medio tono arriba o abajo. Prueba diferentes disposiciones para enfatizar diferentes notas como objetivos de resoluci√≥n.'
            },

            // Minor 7th flat 5 (half-diminished)
            'm7b5': {
                notes: 'T√≥nica + 3m + 5b + 7m',
                characteristics: 'Sonido tenso y sofisticado con cualidades bluesy y jazzy. Menos √°spero que el disminuido completo.',
                keyAspects: 'Combina tr√≠ada menor con quinta disminuida y s√©ptima menor. Crea fuerte atracci√≥n hacia la resoluci√≥n.',
                commonUsage: 'Usado como ii√∏7 en tonalidades menores, para armon√≠a jazz, y como acordes de paso.',
                famousSongs: '"Autumn Leaves" de Joseph Kosma (Re√∏7), "There Will Never Be Another You" (ii√∏7-V7-i), "Stella by Starlight" (m√∫ltiples acordes √∏7).',
                progressions: 'ii√∏7-V7-i (jazz menor), i-ii√∏7-V7-i, IV-VII√∏7-III7-VI7 (menor arm√≥nico).',
                tips: 'Coloca la 5b arriba para tensi√≥n. Resuelve la 7¬™ bajando a la 3¬™, la 5b subiendo a la 5¬™. Esencial para armon√≠a jazz.'
            },

            // Augmented
            'aug': {
                notes: 'T√≥nica + 3M + 5#',
                characteristics: 'Sonido brillante y ambiguo con cualidad flotante y no resuelta. Crea tensi√≥n sin direcci√≥n.',
                keyAspects: 'La quinta aumentada sim√©trica crea ambig√ºedad - puede sonar como mayor o menor dependiendo del contexto.',
                commonUsage: 'Usado como acordes de paso, para modulaci√≥n, y en m√∫sica cl√°sica impresionista.',
                famousSongs: 'Tema de "Los Simpson" (Doaug como acorde de paso), "Giant Steps" de Coltrane (aproximaciones aumentadas), "Black Narcissus" de Joe Henderson.',
                progressions: 'I+ - #IV¬∞ - bVII, como paso entre acordes mayores, III+ - vi - IV (impresionista).',
                tips: 'Usa como acordes de aproximaci√≥n a otras armon√≠as. La quinta aumentada puede resolver crom√°ticamente hacia arriba o abajo.'
            },

            // Suspended chords
            'sus2': {
                notes: 'T√≥nica + 2M + 5',
                characteristics: 'Sonido abierto y et√©reo con tensi√≥n sutil. Menos direccional que sus4.',
                keyAspects: 'Reemplaza la tercera con una segunda, creando una cualidad abierta y ambigua.',
                commonUsage: 'Usado en pop y rock para sonidos atmosf√©ricos, como acordes de aproximaci√≥n, y para armon√≠a moderna.',
                famousSongs: '"Dust in the Wind" de Kansas (Solsus2), "Horse with No Name" de America (acordes sus2), "More Than Words" de Extreme.',
                progressions: 'I-sus2-I (resoluci√≥n), I-IIIsus2-IV-V, sus2 como acordes de paso entre mayor/menor.',
                tips: 'Resuelve la 2¬™ subiendo a la 3¬™ para resoluci√≥n suave. Prueba a√±adir la 4¬™ arriba para sonido 6/9. Genial para intros y puentes.'
            },

            'sus4': {
                notes: 'T√≥nica + 4J + 5',
                characteristics: 'Sonido tenso y anticipatorio que tira fuertemente hacia la resoluci√≥n. M√°s direccional que sus2.',
                keyAspects: 'Reemplaza la tercera con una cuarta, creando tensi√≥n fuerte que exige resoluci√≥n.',
                commonUsage: 'Usado en rock, pop y folk para inter√©s r√≠tmico y como acordes de aproximaci√≥n.',
                famousSongs: '"Dream On" de Aerosmith (Resus4), "Let It Be" de The Beatles (resoluciones sus4), "Under the Bridge" de Red Hot Chili Peppers.',
                progressions: 'I-sus4-I (resoluci√≥n cl√°sica), I-IV-sus4-IV-I, V-sus4-V-I, ii-sus4-ii-V.',
                tips: 'Resuelve la 4¬™ bajando a la 3¬™ para resoluci√≥n fuerte. Usa en tiempos 2 y 4 del ritmo. A√±ade 7¬™ para m√°s tensi√≥n.'
            },

            // 6th chords
            '6': {
                notes: 'T√≥nica + 3M + 5 + 6M',
                characteristics: 'Sonido brillante y colorido con dulzura a√±adida y estabilidad. M√°s complejo que la tr√≠ada mayor.',
                keyAspects: 'A√±ade la sexta para color mientras mantiene la cualidad mayor. Menos tenso que los acordes de s√©ptima.',
                commonUsage: 'Usado en m√∫sica cl√°sica, jazz y pop para color a√±adido y como acordes t√≥nicos con sofisticaci√≥n.',
                famousSongs: '"Michelle" de The Beatles (La6), "It Had to Be You" (acordes de 6¬™ en el puente), "My Funny Valentine" (aproximaci√≥n de 6¬™).',
                progressions: 'I6-IV-I, I6-ii7-V7-I, como sustituto del acorde I en tonalidades mayores.',
                tips: 'Prueba primera inversi√≥n (6¬™ en el bajo) para conducci√≥n de voces m√°s suave. Usa como aproximaci√≥n a acordes dominantes.'
            },

            'm6': {
                notes: 'T√≥nica + 3m + 5 + 6M',
                characteristics: 'Sonido rico y emocional con cualidad agridulce. M√°s complejo que la tr√≠ada menor.',
                keyAspects: 'Combina tr√≠ada menor con sexta mayor para un color melanc√≥lico √∫nico.',
                commonUsage: 'Usado en m√∫sica cl√°sica, jazz, y como sustituto de acordes i en tonalidades menores.',
                famousSongs: '"Autumn Leaves" de Joseph Kosma (Lam6), "Cry Me a River" de Arthur Hamilton, "Blackbird" de The Beatles.',
                progressions: 'i6-VI7-V7-i, i6-iv-i, como acordes de paso en tonalidades menores.',
                tips: 'Coloca la 6¬™ arriba para brillo. Prueba diferentes inversiones para variaciones de color.'
            },

            // 9th chords
            '9': {
                notes: 'T√≥nica + 3M + 5 + 7m + 9M',
                characteristics: 'Sonido rico y complejo con tensi√≥n y sofisticaci√≥n a√±adidas. Altamente colorido.',
                keyAspects: 'A√±ade la 9¬™ (novena mayor) para armon√≠a extendida. Crea cualidad exuberante y jazzy.',
                commonUsage: 'Usado en jazz y pop sofisticado como acordes dominantes con color a√±adido.',
                famousSongs: '"Blue Bossa" de Kenny Dorham (acordes de 9¬™), "So What" de Miles Davis (9¬™s), "Take Five" de Dave Brubeck.',
                progressions: 'ii9-V9-Imaj7, I9-IV9-I9, como sustitutos coloridos para acordes de 7¬™.',
                tips: 'Omite la 5¬™ en las disposiciones para evitar saturaci√≥n. Prueba voicings cuartales. Resuelve la 9¬™ apropiadamente seg√∫n el contexto.'
            },

            'm9': {
                notes: 'T√≥nica + 3m + 5 + 7m + 9M',
                characteristics: 'Sonido suave y sofisticado con tensi√≥n sutil. M√°s refinado que m7.',
                keyAspects: 'Combina s√©ptima menor con novena mayor para cualidad suave y jazzy.',
                commonUsage: 'Usado en jazz como acordes i9, para armon√≠a sofisticada, y como acordes de paso.',
                famousSongs: '"There Will Never Be Another You" (novenas menores), "Stella by Starlight", "My Funny Valentine".',
                progressions: 'i9-iv9-VII9, ii9-V9-i9, como sustitutos de ii√∏7-V7-i.',
                tips: 'Coloca la 9¬™ arriba para brillo. Prueba shell voicings con 9¬™ a√±adida. Genial para baladas.'
            }
        };

        function getChordInfo(chord) {
            // Get the base chord type (remove root note)
            const chordType = chord.type || '';
            
            // Select the appropriate database based on current language
            const database = currentLanguage === 'es' ? chordInfoDatabase_es : chordInfoDatabase_en;

            // Return chord info from database, or default to major chord info
            return database[chordType] || database['maj'];
        }

        function openWikipedia(chordName) {
            // Use Wikipedia search to find articles that mention this chord
            // This will find music theory pages, song pages, or articles that reference the chord
            const searchQuery = `"${chordName}" chord OR "${chordName}" music OR "${chordName}" harmony`;
            const url = `https://en.wikipedia.org/w/index.php?search=${encodeURIComponent(searchQuery)}&title=Special%3ASearch&fulltext=1`;
            window.open(url, '_blank');
        }

        function openChordBook(chordName) {
            // Parse chord name to extract root note
            const result = parseChordName(chordName);
            if (!result) {
                // Fallback: try to extract root note manually
                const match = chordName.match(/^(Do|Re|Mi|Fa|Sol|La|Si|C|D|E|F|G|A|B)([#b]?)/i);
                if (match) {
                    const note = match[1].charAt(0).toUpperCase() + match[1].slice(1).toLowerCase();
                    const accidental = match[2];
                    const fullNote = note + accidental;
                    // Convert to Anglo notation if needed
                    const rootNote = italianToAnglo[fullNote] || italianToAnglo[note] || fullNote;
                    // Convert # to -sharp for URL
                    const urlNote = rootNote.toLowerCase().replace('#', '-sharp');
                    const url = `https://pianochord.org/${urlNote}.html`;
                    window.open(url, '_blank');
                } else {
                    // Last resort: use original name
                    const urlNote = chordName.toLowerCase().replace('#', '-sharp');
                    const url = `https://pianochord.org/${encodeURIComponent(urlNote)}.html`;
                    window.open(url, '_blank');
                }
                return;
            }
            
            // Extract root note (already in Anglo notation from parseChordName)
            const rootNote = result.root;
            // Use pianochord.org to find piano chord diagrams by root note
            // Note: pianochord.org uses lowercase URLs and # becomes -sharp
            const urlNote = rootNote.toLowerCase().replace('#', '-sharp');
            const url = `https://pianochord.org/${urlNote}.html`;
            window.open(url, '_blank');
        }

        function openPerplexity(chordName) {
            // Create a detailed prompt for Perplexity AI about piano chords
            const prompt = `${chordName} acorde de piano. Caracter√≠sticas principales, consejos para piano, progresiones. Incluye nombres y notaciones alternativas`;
            const url = `https://www.perplexity.ai/search?q=${encodeURIComponent(prompt)}`;
            window.open(url, '_blank');
        }

        function openGrok(chordName) {
            // Create a detailed prompt for Grok AI about piano chords
            const prompt = `${chordName} acorde de piano. Caracter√≠sticas principales, consejos para piano, progresiones. Incluye nombres y notaciones alternativas`;
            //const url = `https://x.com/i/grok?text=${encodeURIComponent(prompt)}`;
            const url = `https://grok.com/?q=${encodeURIComponent(prompt)}`;
            window.open(url, '_blank');
        }

        function closeModal() {
            document.getElementById('insightsModal').style.display = 'none';
        }

        function showOtherChords() {
            const noteIndexes = Array.from(selectedNotes).map(note => {
                const noteName = note.replace(/\d+$/, '');
                return noteNames.indexOf(noteName);
            }).sort((a, b) => a - b);

            if (noteIndexes.length === 1) {
                // Case 1: Single note - show all chords with this note as root
                showChordsWithRoot(noteIndexes[0]);
            } else if (noteIndexes.length >= 3) {
                // Case 2: Three or more notes - show all chords containing these notes
                showChordsContainingNotes(noteIndexes);
            }
        }

        function showChordsWithRoot(rootIndex) {
            const rootNote = noteNames[rootIndex];
            const modal = document.getElementById('otherChordsModal');
            const titleElement = document.getElementById('otherChordsModalTitle');
            const listContainer = document.getElementById('otherChordsListContainer');
            const t = translations[currentLanguage];
            
            // Set modal title
            titleElement.textContent = t.otherChordsWithRoot.replace('{note}', rootNote);
            
            // Clear previous list
            listContainer.innerHTML = '';
            
            // Use intervalPatterns to get only unique chord patterns
            // intervalPatterns already groups chord types by their intervals
            // We'll use only the first (main) name from each group
            const uniqueChords = [];
            Object.keys(intervalPatterns).forEach(patternKey => {
                const chordTypesForPattern = intervalPatterns[patternKey];
                // Use only the first (main) chord type name
                const mainChordType = chordTypesForPattern[0];
                const intervals = chordDatabase[mainChordType];
                uniqueChords.push({
                    type: mainChordType,
                    intervals: intervals
                });
            });
            
            // Group chords by number of notes
            const chordsByNoteCount = {};
            uniqueChords.forEach(chord => {
                const noteCount = chord.intervals.length;
                if (!chordsByNoteCount[noteCount]) {
                    chordsByNoteCount[noteCount] = [];
                }
                chordsByNoteCount[noteCount].push(chord);
            });
            
            // Sort groups by note count (ascending)
            const sortedNoteCounts = Object.keys(chordsByNoteCount).map(Number).sort((a, b) => a - b);
            
            // Create list items grouped by note count
            sortedNoteCounts.forEach(noteCount => {
                // Add group title
                const groupTitle = document.createElement('div');
                groupTitle.className = 'chord-group-title';
                groupTitle.textContent = currentLanguage === 'es' 
                    ? `${noteCount} notas` 
                    : `${noteCount} notes`;
                groupTitle.style.cssText = 'font-weight: bold; padding: 6px 8px; font-size: 0.85em; color: #555; margin-top: 8px; margin-bottom: 2px; grid-column: 1 / -1; text-align: left;';
                listContainer.appendChild(groupTitle);
                
                // Add chords in this group
                chordsByNoteCount[noteCount].forEach(chord => {
                    const chordName = rootNote + chord.type;
                    
                    const item = document.createElement('div');
                    item.className = 'chord-list-item';
                    item.textContent = chordName;
                    item.dataset.root = rootIndex;
                    item.dataset.intervals = JSON.stringify(chord.intervals);
                    item.dataset.chordName = chordName;
                    
                    // Single click - highlight additional keys and mark as selected
                    item.addEventListener('click', function() {
                        // Remove selected class from all items
                        document.querySelectorAll('.chord-list-item').forEach(i => i.classList.remove('selected'));
                        // Add selected class to this item
                        this.classList.add('selected');
                        highlightChordKeys(rootIndex, chord.intervals);
                    });
                    
                    // Double click - select chord
                    item.addEventListener('dblclick', function() {
                        selectChord(rootIndex, chord.intervals);
                        closeOtherChordsModal();
                    });
                    
                    listContainer.appendChild(item);
                });
            });
            
            // Show modal
            modal.style.display = 'block';
        }

        function showChordsContainingNotes(selectedNoteIndexes) {
            const modal = document.getElementById('otherChordsModal');
            const titleElement = document.getElementById('otherChordsModalTitle');
            const listContainer = document.getElementById('otherChordsListContainer');
            const t = translations[currentLanguage];
            
            // Set modal title
            const noteNames_display = selectedNoteIndexes.map(i => noteNames[i]).join(', ');
            titleElement.textContent = t.otherChordsContaining.replace('{notes}', noteNames_display);
            
            // Clear previous list
            listContainer.innerHTML = '';
            
            // Find all chords that contain these three notes
            const matchingChords = [];
            const seenChords = new Set(); // To track unique chords by root+intervals
            
            // Try each note as a potential root
            for (let rootIndex = 0; rootIndex < 12; rootIndex++) {
                // Use intervalPatterns to get only unique chord patterns (no duplicates)
                Object.keys(intervalPatterns).forEach(patternKey => {
                    const chordTypesForPattern = intervalPatterns[patternKey];
                    // Use only the first (main) chord type name
                    const mainChordType = chordTypesForPattern[0];
                    const intervals = chordDatabase[mainChordType];
                    const chordNotes = intervals.map(interval => (rootIndex + interval) % 12);
                    
                    // Check if all selected notes are in this chord
                    const allNotesIncluded = selectedNoteIndexes.every(noteIdx => 
                        chordNotes.includes(noteIdx)
                    );
                    
                    // Only include chords that have MORE notes than selected (additional notes)
                    const hasAdditionalNotes = chordNotes.length > selectedNoteIndexes.length;
                    
                    if (allNotesIncluded && hasAdditionalNotes) {
                        // Create a unique key for this chord (root + sorted intervals)
                        const chordKey = `${rootIndex}-${patternKey}`;
                        
                        if (!seenChords.has(chordKey)) {
                            seenChords.add(chordKey);
                            const chordName = noteNames[rootIndex] + mainChordType;
                            matchingChords.push({
                                name: chordName,
                                root: rootIndex,
                                intervals: intervals
                            });
                        }
                    }
                });
            }
            
            if (matchingChords.length === 0) {
                listContainer.innerHTML = `<p style="text-align: center; padding: 12px; font-size: 0.9em;">${t.noChordsFound}</p>`;
            } else {
                // Group chords by number of notes
                const chordsByNoteCount = {};
                matchingChords.forEach(chord => {
                    const noteCount = chord.intervals.length;
                    if (!chordsByNoteCount[noteCount]) {
                        chordsByNoteCount[noteCount] = [];
                    }
                    chordsByNoteCount[noteCount].push(chord);
                });
                
                // Sort groups by note count (ascending)
                const sortedNoteCounts = Object.keys(chordsByNoteCount).map(Number).sort((a, b) => a - b);
                
                // Create list items grouped by note count
                sortedNoteCounts.forEach(noteCount => {
                    // Add group title
                    const groupTitle = document.createElement('div');
                    groupTitle.className = 'chord-group-title';
                    groupTitle.textContent = currentLanguage === 'es' 
                        ? `${noteCount} notas` 
                        : `${noteCount} notes`;
                    groupTitle.style.cssText = 'font-weight: bold; padding: 6px 8px; font-size: 0.85em; color: #555; margin-top: 8px; margin-bottom: 2px; grid-column: 1 / -1; text-align: left;';
                    listContainer.appendChild(groupTitle);
                    
                    // Add chords in this group
                    chordsByNoteCount[noteCount].forEach(chord => {
                        const item = document.createElement('div');
                        item.className = 'chord-list-item';
                        item.textContent = chord.name;
                        item.dataset.root = chord.root;
                        item.dataset.intervals = JSON.stringify(chord.intervals);
                        item.dataset.chordName = chord.name;
                        
                        // Single click - highlight additional keys (keys not already selected) and mark as selected
                        item.addEventListener('click', function() {
                            // Remove selected class from all items
                            document.querySelectorAll('.chord-list-item').forEach(i => i.classList.remove('selected'));
                            // Add selected class to this item
                            this.classList.add('selected');
                            highlightAdditionalChordKeys(chord.root, chord.intervals, selectedNoteIndexes);
                        });
                        
                        // Double click - select chord
                        item.addEventListener('dblclick', function() {
                            selectChord(chord.root, chord.intervals);
                            closeOtherChordsModal();
                        });
                        
                        listContainer.appendChild(item);
                    });
                });
            }
            
            // Show modal
            modal.style.display = 'block';
        }

        function highlightChordKeys(rootIndex, intervals) {
            // Remove previous blue highlights and selected state from list items
            document.querySelectorAll('.white-key, .black-key').forEach(key => {
                key.classList.remove('preview');
            });
            
            // Add blue highlight to chord keys (only one key per note - the most central one)
            intervals.forEach(interval => {
                const noteIndex = (rootIndex + interval) % 12;
                const noteName = noteNames[noteIndex];
                
                // Find all keys with this note name
                const matchingKeys = Array.from(document.querySelectorAll('.white-key, .black-key')).filter(key => {
                    const keyNoteName = key.dataset.note.replace(/\d+$/, '');
                    return keyNoteName === noteName;
                });
                
                // Choose the most central key (closest to octave 3)
                if (matchingKeys.length > 0) {
                    const centralKey = matchingKeys.reduce((closest, key) => {
                        const octave = parseInt(key.dataset.note.match(/\d+$/)[0]);
                        const closestOctave = parseInt(closest.dataset.note.match(/\d+$/)[0]);
                        const targetOctave = 3; // Middle of the keyboard (octaves 2-4)
                        return Math.abs(octave - targetOctave) < Math.abs(closestOctave - targetOctave) ? key : closest;
                    });
                    centralKey.classList.add('preview');
                }
            });
        }

        function highlightAdditionalChordKeys(rootIndex, intervals, alreadySelectedIndexes) {
            // Remove previous blue highlights (but keep red active ones)
            document.querySelectorAll('.white-key, .black-key').forEach(key => {
                key.classList.remove('preview');
            });
            
            // Add blue highlight only to additional keys (not already selected)
            intervals.forEach(interval => {
                const noteIndex = (rootIndex + interval) % 12;
                const noteName = noteNames[noteIndex];
                
                // Only highlight if this note is NOT in the already selected notes
                if (!alreadySelectedIndexes.includes(noteIndex)) {
                    // Find all keys with this note name
                    const matchingKeys = Array.from(document.querySelectorAll('.white-key, .black-key')).filter(key => {
                        const keyNoteName = key.dataset.note.replace(/\d+$/, '');
                        return keyNoteName === noteName;
                    });
                    
                    // Choose the most central key (closest to octave 3)
                    if (matchingKeys.length > 0) {
                        const centralKey = matchingKeys.reduce((closest, key) => {
                            const octave = parseInt(key.dataset.note.match(/\d+$/)[0]);
                            const closestOctave = parseInt(closest.dataset.note.match(/\d+$/)[0]);
                            const targetOctave = 3; // Middle of the keyboard (octaves 2-4)
                            return Math.abs(octave - targetOctave) < Math.abs(closestOctave - targetOctave) ? key : closest;
                        });
                        centralKey.classList.add('preview');
                    }
                }
            });
        }

        function selectChord(rootIndex, intervals) {
            // Get current selection size before clearing
            const currentSelectionSize = selectedNotes.size;
            
            // If there's only 1 note selected (case when coming from single note),
            // keep it and only add the additional notes
            if (currentSelectionSize === 1) {
                // Just remove preview class, keep active notes
                document.querySelectorAll('.white-key, .black-key').forEach(key => {
                    key.classList.remove('preview');
                });
                
                // Add missing notes from the chord
                intervals.forEach(interval => {
                    const noteIndex = (rootIndex + interval) % 12;
                    const noteName = noteNames[noteIndex];
                    
                    // Check if this note is already selected
                    const alreadySelected = Array.from(selectedNotes).some(selected => {
                        const selectedNoteName = selected.replace(/\d+$/, '');
                        return noteNames.indexOf(selectedNoteName) === noteIndex;
                    });
                    
                    // Only add if not already selected
                    if (!alreadySelected) {
                        // Find the most central key with this note and select it
                        const matchingKeys = Array.from(document.querySelectorAll('.white-key, .black-key')).filter(key => {
                            const keyNoteName = key.dataset.note.replace(/\d+$/, '');
                            return keyNoteName === noteName;
                        });
                        
                        if (matchingKeys.length > 0) {
                            const centralKey = matchingKeys.reduce((closest, key) => {
                                const octave = parseInt(key.dataset.note.match(/\d+$/)[0]);
                                const closestOctave = parseInt(closest.dataset.note.match(/\d+$/)[0]);
                                const targetOctave = 3; // Middle of the keyboard (octaves 2-4)
                                return Math.abs(octave - targetOctave) < Math.abs(closestOctave - targetOctave) ? key : closest;
                            });
                            selectedNotes.add(centralKey.dataset.note);
                            centralKey.classList.add('active');
                        }
                    }
                });
            } else {
                // For 3 notes or other cases, clear and select all notes in chord
                selectedNotes.clear();
                document.querySelectorAll('.white-key, .black-key').forEach(key => {
                    key.classList.remove('active');
                    key.classList.remove('preview');
                });
                
                // Select all notes in the chord
                intervals.forEach(interval => {
                    const noteIndex = (rootIndex + interval) % 12;
                    const noteName = noteNames[noteIndex];
                    
                    // Find the most central key with this note and select it
                    const matchingKeys = Array.from(document.querySelectorAll('.white-key, .black-key')).filter(key => {
                        const keyNoteName = key.dataset.note.replace(/\d+$/, '');
                        return keyNoteName === noteName;
                    });
                    
                    if (matchingKeys.length > 0) {
                        const centralKey = matchingKeys.reduce((closest, key) => {
                            const octave = parseInt(key.dataset.note.match(/\d+$/)[0]);
                            const closestOctave = parseInt(closest.dataset.note.match(/\d+$/)[0]);
                            const targetOctave = 3; // Middle of the keyboard (octaves 2-4)
                            return Math.abs(octave - targetOctave) < Math.abs(closestOctave - targetOctave) ? key : closest;
                        });
                        selectedNotes.add(centralKey.dataset.note);
                        centralKey.classList.add('active');
                    }
                });
            }
            
            // Update chord info
            identifyChord();
        }

        function closeOtherChordsModal() {
            // Remove blue highlights
            document.querySelectorAll('.white-key, .black-key').forEach(key => {
                key.classList.remove('preview');
            });
            
            // Remove selected state from list items
            document.querySelectorAll('.chord-list-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            document.getElementById('otherChordsModal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('otherChordsModal');
            if (event.target === modal) {
                closeOtherChordsModal();
            }
        });

        function showHelp() {
            document.getElementById('helpModal').style.display = 'block';
        }

        function closeHelpModal() {
            document.getElementById('helpModal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const insightsModal = document.getElementById('insightsModal');
            const helpModal = document.getElementById('helpModal');
            
            if (event.target === insightsModal) {
                closeModal();
            }
            if (event.target === helpModal) {
                closeHelpModal();
            }
        }

        // Handle Enter key in chord input
        document.getElementById('chordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                findChord();
            }
        });

        // Staff (Pentagrama) Functions
        window.currentStaffNote = null;
        window.staffInitialized = false;
        
        // Level and exercise state
        let currentLevel = 'Practicar';
        let currentExercise = '1';
        // Track notes for practice mode
        let practiceNotes = [];
        // Track active anchor states for practice mode
        let practiceAnchors = {
            DO: false,
            FA: false,
            SOL: false
        };
        // Store practice anchor elements for removal
        let practiceAnchorElements = [];
        let maxAttempts = 0;
        let maxTime = 0;
        let remainingAttempts = 0;
        let timeRemaining = 0;
        let timeInterval = null;
        let exerciseActive = false;
        let notesCompleted = 0;
        let correctCount = 0;
        let wrongCount = 0;
        
        // Exercise configuration: [attempts, timeInSeconds]
        const exerciseConfig = {
            1: [5, 10],  // Exercise 1: 5 attempts, 10 seconds
            2: [4, 8],   // Exercise 2: 4 attempts, 8 seconds
            3: [3, 6],   // Exercise 3: 3 attempts, 6 seconds
            4: [2, 4],   // Exercise 4: 2 attempts, 4 seconds
            5: [1, 3]    // Exercise 5: 1 attempt, 3 seconds
        };
        
        function changeLevel() {
            const levelSelect = document.getElementById('levelSelect');
            currentLevel = levelSelect.value;
            
            // Clear practice notes when changing levels
            practiceNotes = [];
            // Clear practice anchors
            practiceAnchors = { DO: false, FA: false, SOL: false };
            practiceAnchorElements = [];
            
            // Hide anchor buttons if not in practice mode
            const anchorButtons = document.getElementById('practiceAnchorButtons');
            if (anchorButtons) {
                if (currentLevel === 'Practicar') {
                    anchorButtons.style.display = 'flex';
                } else {
                    anchorButtons.style.display = 'none';
                }
            }
            
            // Update button active states - reset when changing levels
            if (anchorButtons) {
                anchorButtons.querySelectorAll('.anchor-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            }
            
            // Redraw staff for new level
            drawStaff();
            
            // Special handling for "Practicar" level
            if (currentLevel === 'Practicar') {
                // Disable GO button
                const goBtn = document.getElementById('goBtn');
                if (goBtn) goBtn.disabled = true;
                
                // Set counters to null/empty
                updateCountersForPractice();
            } else {
                // Reset exercise state for other levels
                resetExerciseState();
                updateCounters();
            }
        }
        
        function updateCountersForPractice() {
            const attemptsNumber = document.getElementById('attemptsNumber');
            const timeNumber = document.getElementById('timeNumber');
            const correctNumber = document.getElementById('correctNumber');
            const wrongNumber = document.getElementById('wrongNumber');
            
            if (attemptsNumber) attemptsNumber.textContent = '-';
            if (timeNumber) timeNumber.textContent = '-';
            if (correctNumber) correctNumber.textContent = '-';
            if (wrongNumber) wrongNumber.textContent = '-';
        }
        
        function changeExercise() {
            const exerciseSelect = document.getElementById('exerciseSelect');
            currentExercise = exerciseSelect.value;
            
            // Reset exercise state
            resetExerciseState();
            updateCounters();
        }
        
        function resetExerciseState() {
            // Stop any ongoing exercise
            if (timeInterval) {
                clearInterval(timeInterval);
                timeInterval = null;
            }
            
            exerciseActive = false;
            notesCompleted = 0;
            correctCount = 0;
            wrongCount = 0;
            
            // Skip exercise config for practice mode
            if (currentLevel === 'Practicar') {
                return;
            }
            
            // Get configuration for current exercise
            const config = exerciseConfig[parseInt(currentExercise)];
            maxAttempts = config[0];
            maxTime = config[1];
            remainingAttempts = maxAttempts;
            timeRemaining = maxTime;
            
            // Clear staff and selection
            clearStaffSelection();
            const svg = document.getElementById('staffSvg');
            if (svg) {
                // Remove note but keep staff lines
                const note = svg.querySelector('.staff-note');
                if (note) note.remove();
                const stem = svg.querySelector('line[stroke-width="2"]:not(.staff-line)');
                if (stem) stem.remove();
            }
            
            // Enable GO button (unless in practice mode)
            if (currentLevel !== 'Practicar') {
                const goBtn = document.getElementById('goBtn');
                if (goBtn) goBtn.disabled = false;
            }
        }
        
        function startExercise() {
            if (exerciseActive) return;
            
            exerciseActive = true;
            notesCompleted = 0;
            correctCount = 0;
            wrongCount = 0;
            
            // Reset counters to max
            remainingAttempts = maxAttempts;
            timeRemaining = maxTime;
            updateCounters();
            
            // Disable GO button
            const goBtn = document.getElementById('goBtn');
            if (goBtn) goBtn.disabled = true;
            
            // Generate first note
            generateNewNote();
            
            // Start timer
            startTimer();
        }
        
        function updateCounters() {
            const attemptsNumber = document.getElementById('attemptsNumber');
            const timeNumber = document.getElementById('timeNumber');
            const correctNumber = document.getElementById('correctNumber');
            const wrongNumber = document.getElementById('wrongNumber');
            
            if (attemptsNumber) attemptsNumber.textContent = remainingAttempts;
            if (timeNumber) timeNumber.textContent = timeRemaining;
            if (correctNumber) correctNumber.textContent = correctCount;
            if (wrongNumber) wrongNumber.textContent = wrongCount;
        }
        
        function startTimer() {
            // Clear any existing timer
            if (timeInterval) {
                clearInterval(timeInterval);
            }
            
            // Start countdown
            timeInterval = setInterval(() => {
                timeRemaining--;
                updateCounters();
                
                if (timeRemaining <= 0) {
                    clearInterval(timeInterval);
                    timeInterval = null;
                    // Time's up - handle timeout
                    handleTimeOut();
                }
            }, 1000);
        }
        
        function handleTimeOut() {
            // Time's up without correct answer - count as failure
            wrongCount++;
            updateCounters();
            
            // Move to next note
            nextNote();
        }
        
        function nextNote() {
            notesCompleted++;
            
            if (notesCompleted >= 15) {
                // Exercise completed
                completeExercise();
            } else {
                // Generate next note
                generateNewNote();
                // Reset attempts and time for new note
                remainingAttempts = maxAttempts;
                timeRemaining = maxTime;
                updateCounters();
                // Restart timer
                startTimer();
            }
        }
        
        function completeExercise() {
            // Stop timer
            if (timeInterval) {
                clearInterval(timeInterval);
                timeInterval = null;
            }
            
            exerciseActive = false;
            
            // Check if passed (wrongCount < 3)
            if (wrongCount < 3) {
                // Passed - can move to next exercise
                alert(`¬°Ejercicio completado! Aciertos: ${correctCount}, Fallos: ${wrongCount}. Puedes pasar al siguiente ejercicio.`);
            } else {
                // Failed
                alert(`Ejercicio completado. Fallos: ${wrongCount}. Necesitas menos de 3 fallos para pasar al siguiente ejercicio.`);
            }
            
            // Enable GO button
            const goBtn = document.getElementById('goBtn');
            if (goBtn) goBtn.disabled = false;
        }

        function initializeStaff() {
            // Create piano for staff tab
            createPiano('staffPiano');
            
            // Draw the staff
            drawStaff();
            
            // Initialize exercise state
            resetExerciseState();
            
            // If in practice mode, disable GO button and set counters to null
            if (currentLevel === 'Practicar') {
                const goBtn = document.getElementById('goBtn');
                if (goBtn) goBtn.disabled = true;
                updateCountersForPractice();
            }
        }

        function drawStaff() {
            const svg = document.getElementById('staffSvg');
            if (!svg) return;
            
            svg.innerHTML = ''; // Clear previous content
            
            const width = 800;
            const height = 300;
            
            // Practicar level: Simple black staves, no colors, no anchors
            if (currentLevel === 'Practicar') {
                const staffHeight = 80;
                const lineSpacing = staffHeight / 4;
                const trebleStaffTop = 40;
                const bassStaffTop = 180;
                
                // Draw treble clef staff (top) - 5 lines, all black
                for (let i = 0; i < 5; i++) {
                    const y = trebleStaffTop + (i * lineSpacing);
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', '50');
                    line.setAttribute('y1', y);
                    line.setAttribute('x2', width - 50);
                    line.setAttribute('y2', y);
                    line.setAttribute('class', 'staff-line');
                    line.setAttribute('stroke', '#000000');
                    line.setAttribute('stroke-width', '2');
                    svg.appendChild(line);
                }
                
                // Draw bass clef staff (bottom) - 5 lines, all black
                for (let i = 0; i < 5; i++) {
                    const y = bassStaffTop + (i * lineSpacing);
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', '50');
                    line.setAttribute('y1', y);
                    line.setAttribute('x2', width - 50);
                    line.setAttribute('y2', y);
                    line.setAttribute('class', 'staff-line');
                    line.setAttribute('stroke', '#000000');
                    line.setAttribute('stroke-width', '2');
                    svg.appendChild(line);
                }
                
                // Draw treble clef (clave de sol)
                const trebleClef = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                trebleClef.setAttribute('x', '60');
                const trebleStaffCenter = trebleStaffTop + (2 * lineSpacing);
                trebleClef.setAttribute('y', trebleStaffCenter + (lineSpacing * 1.0) + 20);
                trebleClef.setAttribute('font-size', '90');
                trebleClef.setAttribute('font-family', 'serif');
                trebleClef.textContent = 'ùÑû';
                svg.appendChild(trebleClef);
                
                // Draw bass clef (clave de fa)
                const bassClef = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                bassClef.setAttribute('x', '60');
                const bassStaffCenter = bassStaffTop + (2 * lineSpacing);
                bassClef.setAttribute('y', bassStaffCenter - (lineSpacing * 0.25) + 20);
                bassClef.setAttribute('font-size', '75');
                bassClef.setAttribute('font-family', 'serif');
                bassClef.textContent = 'ùÑ¢';
                svg.appendChild(bassClef);
                
                // Redraw all practice notes
                practiceNotes.forEach(note => {
                    drawPracticeNoteOnStaff(note.noteIndex, note.octave, note.x, note.noteName);
                });
                
                // Show anchor buttons for practice mode
                const anchorButtons = document.getElementById('practiceAnchorButtons');
                if (anchorButtons) {
                    anchorButtons.style.display = 'flex';
                }
                
                // Redraw active anchors if any are active
                Object.keys(practiceAnchors).forEach(noteName => {
                    if (practiceAnchors[noteName]) {
                        drawPracticeAnchors(noteName);
                    }
                });
            }
            // Level 1: Piano staves (treble and bass) with reduced spacing
            else if (currentLevel === '1') {
                const staffHeight = 80; // Reduced from 200 to 80 (40% of original)
                const lineSpacing = staffHeight / 4; // 20 instead of 50
                const trebleStaffTop = 40;
                const bassStaffTop = 180; // Increased gap between staves (was 140, now 180)
                
                // Calculate positions for highlights and badges (needed later)
                const y1 = trebleStaffTop + (0 * lineSpacing); // Line 1 (green) - treble
                const y4 = trebleStaffTop + (3 * lineSpacing); // Line 4 (yellow) - treble
                const spaceTreble = trebleStaffTop + (1.5 * lineSpacing); // Second space from top (celeste) - treble
                const y2 = bassStaffTop + (1 * lineSpacing); // Line 2 (green) - bass
                const y5 = bassStaffTop + (4 * lineSpacing); // Line 5 (yellow) - bass
                const spaceBass = bassStaffTop + (2.5 * lineSpacing); // Second space from bottom (celeste) - bass
                const trebleStaffBottom = trebleStaffTop + (4 * lineSpacing); // Bottom of treble staff
                const middleY = (trebleStaffBottom + bassStaffTop) / 2; // Middle line between staves (celeste)
                
                // Draw treble clef staff (top) - 5 lines
                // All lines black and same thickness
                for (let i = 0; i < 5; i++) {
                    const y = trebleStaffTop + (i * lineSpacing);
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', '50');
                    line.setAttribute('y1', y);
                    line.setAttribute('x2', width - 50);
                    line.setAttribute('y2', y);
                    line.setAttribute('class', 'staff-line');
                    line.setAttribute('stroke', '#000000');
                    line.setAttribute('stroke-width', '2');
                    svg.appendChild(line);
                }
                
                // Draw bass clef staff (bottom) - 5 lines
                // All lines black and same thickness
                for (let i = 0; i < 5; i++) {
                    const y = bassStaffTop + (i * lineSpacing);
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', '50');
                    line.setAttribute('y1', y);
                    line.setAttribute('x2', width - 50);
                    line.setAttribute('y2', y);
                    line.setAttribute('class', 'staff-line');
                    line.setAttribute('stroke', '#000000');
                    line.setAttribute('stroke-width', '2');
                    svg.appendChild(line);
                }
                
                // Level 1: Add transparent highlight overlay on special lines (like a marker)
                if (currentLevel === '1') {
                    // Treble clef: Line 1 (green highlight)
                    const highlight1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    highlight1.setAttribute('x1', '50');
                    highlight1.setAttribute('y1', y1);
                    highlight1.setAttribute('x2', width - 50);
                    highlight1.setAttribute('y2', y1);
                    highlight1.setAttribute('stroke', '#00ff00'); // Green
                    highlight1.setAttribute('stroke-width', '8');
                    highlight1.setAttribute('opacity', '0.5'); // Transparent overlay
                    highlight1.setAttribute('stroke-linecap', 'round');
                    svg.appendChild(highlight1);
                    
                    // Treble clef: Line 4 (yellow highlight)
                    const highlight4 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    highlight4.setAttribute('x1', '50');
                    highlight4.setAttribute('y1', y4);
                    highlight4.setAttribute('x2', width - 50);
                    highlight4.setAttribute('y2', y4);
                    highlight4.setAttribute('stroke', '#ffff00'); // Yellow
                    highlight4.setAttribute('stroke-width', '8');
                    highlight4.setAttribute('opacity', '0.5'); // Transparent overlay
                    highlight4.setAttribute('stroke-linecap', 'round');
                    svg.appendChild(highlight4);
                    
                    // Bass clef: Line 2 (green highlight)
                    const highlight2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    highlight2.setAttribute('x1', '50');
                    highlight2.setAttribute('y1', y2);
                    highlight2.setAttribute('x2', width - 50);
                    highlight2.setAttribute('y2', y2);
                    highlight2.setAttribute('stroke', '#00ff00'); // Green
                    highlight2.setAttribute('stroke-width', '8');
                    highlight2.setAttribute('opacity', '0.5'); // Transparent overlay
                    highlight2.setAttribute('stroke-linecap', 'round');
                    svg.appendChild(highlight2);
                    
                    // Bass clef: Line 5 (yellow highlight)
                    const highlight5 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    highlight5.setAttribute('x1', '50');
                    highlight5.setAttribute('y1', y5);
                    highlight5.setAttribute('x2', width - 50);
                    highlight5.setAttribute('y2', y5);
                    highlight5.setAttribute('stroke', '#ffff00'); // Yellow
                    highlight5.setAttribute('stroke-width', '8');
                    highlight5.setAttribute('opacity', '0.5'); // Transparent overlay
                    highlight5.setAttribute('stroke-linecap', 'round');
                    svg.appendChild(highlight5);
                    
                    // Treble clef: Second space from top (blue highlight)
                    const highlightSpaceTreble = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    highlightSpaceTreble.setAttribute('x1', '50');
                    highlightSpaceTreble.setAttribute('y1', spaceTreble);
                    highlightSpaceTreble.setAttribute('x2', width - 50);
                    highlightSpaceTreble.setAttribute('y2', spaceTreble);
                    highlightSpaceTreble.setAttribute('stroke', '#87ceeb'); // Sky blue (celeste)
                    highlightSpaceTreble.setAttribute('stroke-width', '10');
                    highlightSpaceTreble.setAttribute('opacity', '0.5'); // Transparent overlay
                    highlightSpaceTreble.setAttribute('stroke-linecap', 'round');
                    svg.appendChild(highlightSpaceTreble);
                    
                    // Bass clef: Second space from bottom (blue highlight)
                    const highlightSpaceBass = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    highlightSpaceBass.setAttribute('x1', '50');
                    highlightSpaceBass.setAttribute('y1', spaceBass);
                    highlightSpaceBass.setAttribute('x2', width - 50);
                    highlightSpaceBass.setAttribute('y2', spaceBass);
                    highlightSpaceBass.setAttribute('stroke', '#87ceeb'); // Sky blue (celeste)
                    highlightSpaceBass.setAttribute('stroke-width', '10');
                    highlightSpaceBass.setAttribute('opacity', '0.5'); // Transparent overlay
                    highlightSpaceBass.setAttribute('stroke-linecap', 'round');
                    svg.appendChild(highlightSpaceBass);
                    
                    // Line between the two staves (middle of treble and bass clefs)
                    const middleLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    middleLine.setAttribute('x1', '50');
                    middleLine.setAttribute('y1', middleY);
                    middleLine.setAttribute('x2', width - 50);
                    middleLine.setAttribute('y2', middleY);
                    middleLine.setAttribute('stroke', '#87ceeb'); // Sky blue (celeste)
                    middleLine.setAttribute('stroke-width', '6');
                    middleLine.setAttribute('opacity', '0.5'); // Transparent overlay
                    middleLine.setAttribute('stroke-linecap', 'round');
                    svg.appendChild(middleLine);
                }
                
                // Draw treble clef (clave de sol) - positioned lower, medio espacio from center
                const trebleClef = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                trebleClef.setAttribute('x', '60');
                // Center of staff is trebleStaffTop + 2*lineSpacing, move medio espacio down
                const trebleStaffCenter = trebleStaffTop + (2 * lineSpacing);
                trebleClef.setAttribute('y', trebleStaffCenter + (lineSpacing * 1.0) + 20);
                trebleClef.setAttribute('font-size', '90'); // Larger size for treble clef
                trebleClef.setAttribute('font-family', 'serif');
                trebleClef.textContent = 'ùÑû';
                svg.appendChild(trebleClef);
                
                // Draw bass clef (clave de fa) - positioned un cuarto de espacio m√°s baja
                const bassClef = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                bassClef.setAttribute('x', '60');
                // Center of staff is bassStaffTop + 2*lineSpacing, move un cuarto de espacio down
                const bassStaffCenter = bassStaffTop + (2 * lineSpacing);
                bassClef.setAttribute('y', bassStaffCenter - (lineSpacing * 0.25) + 20);
                bassClef.setAttribute('font-size', '75'); // Keep bass clef size
                bassClef.setAttribute('font-family', 'serif');
                bassClef.textContent = 'ùÑ¢';
                svg.appendChild(bassClef);
                
                // Draw badges with anchor and note names (only for level 1)
                // Badge size matches note size (radius 10)
                const badgeRadius = 10;
                const startX = 50;
                const endX = width - 50;
                
                // Helper function to create a badge
                function createBadge(x, y, color, noteText, showText = true) {
                    const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    
                    // Anchor emoji in corresponding color
                    const anchorEmoji = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    anchorEmoji.setAttribute('x', x);
                    anchorEmoji.setAttribute('y', y + 6); // Positioned below where text will be
                    anchorEmoji.setAttribute('text-anchor', 'middle');
                    anchorEmoji.setAttribute('font-size', '20'); // Size 20
                    anchorEmoji.setAttribute('fill', color); // Color corresponding to the note
                    anchorEmoji.setAttribute('font-family', 'Arial, sans-serif');
                    anchorEmoji.textContent = '‚öì';
                    group.appendChild(anchorEmoji);
                    
                    // Note name to the left of the anchor (in black)
                    if (showText && noteText) {
                        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        text.setAttribute('x', x - 12); // Positioned to the left of the anchor
                        text.setAttribute('y', y + 6); // Same vertical position as anchor
                        text.setAttribute('text-anchor', 'end'); // Right-aligned so it ends just before the anchor
                        text.setAttribute('font-size', '10');
                        text.setAttribute('font-weight', 'bold');
                        text.setAttribute('fill', '#000'); // Black text
                        text.setAttribute('font-family', 'Arial, sans-serif');
                        text.textContent = noteText;
                        group.appendChild(text);
                    }
                    
                    return group;
                }
                
                // Badge 1: DO (celeste) - at start and end of celeste space (treble)
                svg.appendChild(createBadge(startX, spaceTreble, '#87ceeb', 'DO'));
                svg.appendChild(createBadge(endX, spaceTreble, '#87ceeb', 'DO'));
                
                // Badge 2: FA (verde) - at start and end of green line (treble)
                svg.appendChild(createBadge(startX, y1, '#00ff00', 'FA'));
                svg.appendChild(createBadge(endX, y1, '#00ff00', 'FA'));
                
                // Badge 3: SOL (amarillo) - at start and end of yellow line (treble)
                svg.appendChild(createBadge(startX, y4, '#ffff00', 'SOL'));
                svg.appendChild(createBadge(endX, y4, '#ffff00', 'SOL'));
                
                // Badge 4: FA (verde) - at start and end of green line (bass)
                svg.appendChild(createBadge(startX, y2, '#00ff00', 'FA'));
                svg.appendChild(createBadge(endX, y2, '#00ff00', 'FA'));
                
                // Badge 5: SOL (amarillo) - at start and end of yellow line (bass)
                svg.appendChild(createBadge(startX, y5, '#ffff00', 'SOL'));
                svg.appendChild(createBadge(endX, y5, '#ffff00', 'SOL'));
                
                // Badge 6: DO (celeste) - at start and end of celeste space (bass)
                svg.appendChild(createBadge(startX, spaceBass, '#87ceeb', 'DO'));
                svg.appendChild(createBadge(endX, spaceBass, '#87ceeb', 'DO'));
                
                // Badge 7: DO (celeste) - at start and end of middle line
                svg.appendChild(createBadge(startX, middleY, '#87ceeb', 'DO'));
                svg.appendChild(createBadge(endX, middleY, '#87ceeb', 'DO'));
            } else {
                // Levels 2 and 3: two staves (treble and bass) all in black
                const staffHeight = 80; // Same size as level 1
                const lineSpacing = staffHeight / 4; // 20 instead of 50
                const trebleStaffTop = 40;
                const bassStaffTop = 180; // Same spacing as level 1
                
                // Calculate positions for badges (same as level 1)
                const y1 = trebleStaffTop + (0 * lineSpacing); // Line 1 (green) - treble
                const y4 = trebleStaffTop + (3 * lineSpacing); // Line 4 (yellow) - treble
                const spaceTreble = trebleStaffTop + (1.5 * lineSpacing); // Second space from top (celeste) - treble
                const y2 = bassStaffTop + (1 * lineSpacing); // Line 2 (green) - bass
                const y5 = bassStaffTop + (4 * lineSpacing); // Line 5 (yellow) - bass
                const spaceBass = bassStaffTop + (2.5 * lineSpacing); // Second space from bottom (celeste) - bass
                const trebleStaffBottom = trebleStaffTop + (4 * lineSpacing); // Bottom of treble staff
                const middleY = (trebleStaffBottom + bassStaffTop) / 2; // Middle line between staves (celeste)
                
                // Draw treble clef staff (top) - 5 lines, all black
                for (let i = 0; i < 5; i++) {
                    const y = trebleStaffTop + (i * lineSpacing);
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', '50');
                    line.setAttribute('y1', y);
                    line.setAttribute('x2', width - 50);
                    line.setAttribute('y2', y);
                    line.setAttribute('class', 'staff-line');
                    line.setAttribute('stroke', '#000000');
                    line.setAttribute('stroke-width', '2');
                    svg.appendChild(line);
                }
                
                // Draw bass clef staff (bottom) - 5 lines, all black
                for (let i = 0; i < 5; i++) {
                    const y = bassStaffTop + (i * lineSpacing);
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', '50');
                    line.setAttribute('y1', y);
                    line.setAttribute('x2', width - 50);
                    line.setAttribute('y2', y);
                    line.setAttribute('class', 'staff-line');
                    line.setAttribute('stroke', '#000000');
                    line.setAttribute('stroke-width', '2');
                    svg.appendChild(line);
                }
                
                // Draw treble clef (clave de sol)
                const trebleClef = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                trebleClef.setAttribute('x', '60');
                const trebleStaffCenter = trebleStaffTop + (2 * lineSpacing);
                trebleClef.setAttribute('y', trebleStaffCenter + (lineSpacing * 1.0) + 20);
                trebleClef.setAttribute('font-size', '90');
                trebleClef.setAttribute('font-family', 'serif');
                trebleClef.textContent = 'ùÑû';
                svg.appendChild(trebleClef);
                
                // Draw bass clef (clave de fa)
                const bassClef = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                bassClef.setAttribute('x', '60');
                const bassStaffCenter = bassStaffTop + (2 * lineSpacing);
                bassClef.setAttribute('y', bassStaffCenter - (lineSpacing * 0.25) + 20);
                bassClef.setAttribute('font-size', '75');
                bassClef.setAttribute('font-family', 'serif');
                bassClef.textContent = 'ùÑ¢';
                svg.appendChild(bassClef);
                
                // Level 2: Add colored highlights and badges without note names
                if (currentLevel === '2') {
                    // Add colored highlights on special lines (same as level 1 but no text on badges)
                    // Treble clef: Line 1 (green highlight)
                    const highlight1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    highlight1.setAttribute('x1', '50');
                    highlight1.setAttribute('y1', y1);
                    highlight1.setAttribute('x2', width - 50);
                    highlight1.setAttribute('y2', y1);
                    highlight1.setAttribute('stroke', '#00ff00'); // Green
                    highlight1.setAttribute('stroke-width', '8');
                    highlight1.setAttribute('opacity', '0.5');
                    highlight1.setAttribute('stroke-linecap', 'round');
                    svg.appendChild(highlight1);
                    
                    // Treble clef: Line 4 (yellow highlight)
                    const highlight4 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    highlight4.setAttribute('x1', '50');
                    highlight4.setAttribute('y1', y4);
                    highlight4.setAttribute('x2', width - 50);
                    highlight4.setAttribute('y2', y4);
                    highlight4.setAttribute('stroke', '#ffff00'); // Yellow
                    highlight4.setAttribute('stroke-width', '8');
                    highlight4.setAttribute('opacity', '0.5');
                    highlight4.setAttribute('stroke-linecap', 'round');
                    svg.appendChild(highlight4);
                    
                    // Bass clef: Line 2 (green highlight)
                    const highlight2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    highlight2.setAttribute('x1', '50');
                    highlight2.setAttribute('y1', y2);
                    highlight2.setAttribute('x2', width - 50);
                    highlight2.setAttribute('y2', y2);
                    highlight2.setAttribute('stroke', '#00ff00'); // Green
                    highlight2.setAttribute('stroke-width', '8');
                    highlight2.setAttribute('opacity', '0.5');
                    highlight2.setAttribute('stroke-linecap', 'round');
                    svg.appendChild(highlight2);
                    
                    // Bass clef: Line 5 (yellow highlight)
                    const highlight5 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    highlight5.setAttribute('x1', '50');
                    highlight5.setAttribute('y1', y5);
                    highlight5.setAttribute('x2', width - 50);
                    highlight5.setAttribute('y2', y5);
                    highlight5.setAttribute('stroke', '#ffff00'); // Yellow
                    highlight5.setAttribute('stroke-width', '8');
                    highlight5.setAttribute('opacity', '0.5');
                    highlight5.setAttribute('stroke-linecap', 'round');
                    svg.appendChild(highlight5);
                    
                    // Treble clef: Second space from top (celeste highlight)
                    const highlightSpaceTreble = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    highlightSpaceTreble.setAttribute('x1', '50');
                    highlightSpaceTreble.setAttribute('y1', spaceTreble);
                    highlightSpaceTreble.setAttribute('x2', width - 50);
                    highlightSpaceTreble.setAttribute('y2', spaceTreble);
                    highlightSpaceTreble.setAttribute('stroke', '#87ceeb'); // Sky blue (celeste)
                    highlightSpaceTreble.setAttribute('stroke-width', '10');
                    highlightSpaceTreble.setAttribute('opacity', '0.5');
                    highlightSpaceTreble.setAttribute('stroke-linecap', 'round');
                    svg.appendChild(highlightSpaceTreble);
                    
                    // Bass clef: Second space from bottom (celeste highlight)
                    const highlightSpaceBass = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    highlightSpaceBass.setAttribute('x1', '50');
                    highlightSpaceBass.setAttribute('y1', spaceBass);
                    highlightSpaceBass.setAttribute('x2', width - 50);
                    highlightSpaceBass.setAttribute('y2', spaceBass);
                    highlightSpaceBass.setAttribute('stroke', '#87ceeb'); // Sky blue (celeste)
                    highlightSpaceBass.setAttribute('stroke-width', '10');
                    highlightSpaceBass.setAttribute('opacity', '0.5');
                    highlightSpaceBass.setAttribute('stroke-linecap', 'round');
                    svg.appendChild(highlightSpaceBass);
                    
                    // Line between the two staves (middle line - celeste)
                    const middleLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    middleLine.setAttribute('x1', '50');
                    middleLine.setAttribute('y1', middleY);
                    middleLine.setAttribute('x2', width - 50);
                    middleLine.setAttribute('y2', middleY);
                    middleLine.setAttribute('stroke', '#87ceeb'); // Sky blue (celeste)
                    middleLine.setAttribute('stroke-width', '6');
                    middleLine.setAttribute('opacity', '0.5');
                    middleLine.setAttribute('stroke-linecap', 'round');
                    svg.appendChild(middleLine);
                    
                    // Now add badges without note names
                    const badgeRadius = 10;
                    const startX = 50;
                    const endX = width - 50;
                    
                    // Helper function to create a badge (reuse from level 1)
                    function createBadge(x, y, color, noteText, showText = true) {
                        const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                        
                        // Anchor emoji in corresponding color
                        const anchorEmoji = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        anchorEmoji.setAttribute('x', x);
                        anchorEmoji.setAttribute('y', y + 6); // Positioned below where text will be
                        anchorEmoji.setAttribute('text-anchor', 'middle');
                        anchorEmoji.setAttribute('font-size', '20'); // Size 20
                        anchorEmoji.setAttribute('fill', color); // Color corresponding to the note
                        anchorEmoji.setAttribute('font-family', 'Arial, sans-serif');
                        anchorEmoji.textContent = '‚öì';
                        group.appendChild(anchorEmoji);
                        
                        // Note name to the left of the anchor (in black) - only if showText is true
                        if (showText && noteText) {
                            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            text.setAttribute('x', x - 12); // Positioned to the left of the anchor
                            text.setAttribute('y', y + 6); // Same vertical position as anchor
                            text.setAttribute('text-anchor', 'end'); // Right-aligned so it ends just before the anchor
                            text.setAttribute('font-size', '10');
                            text.setAttribute('font-weight', 'bold');
                            text.setAttribute('fill', '#000'); // Black text
                            text.setAttribute('font-family', 'Arial, sans-serif');
                            text.textContent = noteText;
                            group.appendChild(text);
                        }
                        
                        return group;
                    }
                    
                    // Badge 1: DO (celeste) - at start and end of celeste space (treble) - NO TEXT
                    svg.appendChild(createBadge(startX, spaceTreble, '#87ceeb', 'DO', false));
                    svg.appendChild(createBadge(endX, spaceTreble, '#87ceeb', 'DO', false));
                    
                    // Badge 2: FA (verde) - at start and end of green line (treble) - NO TEXT
                    svg.appendChild(createBadge(startX, y1, '#00ff00', 'FA', false));
                    svg.appendChild(createBadge(endX, y1, '#00ff00', 'FA', false));
                    
                    // Badge 3: SOL (amarillo) - at start and end of yellow line (treble) - NO TEXT
                    svg.appendChild(createBadge(startX, y4, '#ffff00', 'SOL', false));
                    svg.appendChild(createBadge(endX, y4, '#ffff00', 'SOL', false));
                    
                    // Badge 4: FA (verde) - at start and end of green line (bass) - NO TEXT
                    svg.appendChild(createBadge(startX, y2, '#00ff00', 'FA', false));
                    svg.appendChild(createBadge(endX, y2, '#00ff00', 'FA', false));
                    
                    // Badge 5: SOL (amarillo) - at start and end of yellow line (bass) - NO TEXT
                    svg.appendChild(createBadge(startX, y5, '#ffff00', 'SOL', false));
                    svg.appendChild(createBadge(endX, y5, '#ffff00', 'SOL', false));
                    
                    // Badge 6: DO (celeste) - at start and end of celeste space (bass) - NO TEXT
                    svg.appendChild(createBadge(startX, spaceBass, '#87ceeb', 'DO', false));
                    svg.appendChild(createBadge(endX, spaceBass, '#87ceeb', 'DO', false));
                    
                    // Badge 7: DO (celeste) - at start and end of middle line - NO TEXT
                    svg.appendChild(createBadge(startX, middleY, '#87ceeb', 'DO', false));
                    svg.appendChild(createBadge(endX, middleY, '#87ceeb', 'DO', false));
                }
                
                // Level 3: Add badges without colors (all black) and without note names
                if (currentLevel === '3') {
                    const badgeRadius = 10;
                    const startX = 50;
                    const endX = width - 50;
                    
                    // Helper function to create a badge (all black, no text)
                    function createBadge(x, y, color, noteText, showText = true) {
                        const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                        
                        // Anchor emoji in black (no color)
                        const anchorEmoji = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        anchorEmoji.setAttribute('x', x);
                        anchorEmoji.setAttribute('y', y + 6);
                        anchorEmoji.setAttribute('text-anchor', 'middle');
                        anchorEmoji.setAttribute('font-size', '20'); // Size 20
                        anchorEmoji.setAttribute('fill', '#000000'); // Black (no color)
                        anchorEmoji.setAttribute('font-family', 'Arial, sans-serif');
                        anchorEmoji.textContent = '‚öì';
                        group.appendChild(anchorEmoji);
                        
                        // Note name to the left of the anchor (in black) - only if showText is true
                        if (showText && noteText) {
                            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            text.setAttribute('x', x - 12);
                            text.setAttribute('y', y + 6);
                            text.setAttribute('text-anchor', 'end');
                            text.setAttribute('font-size', '10');
                            text.setAttribute('font-weight', 'bold');
                            text.setAttribute('fill', '#000');
                            text.setAttribute('font-family', 'Arial, sans-serif');
                            text.textContent = noteText;
                            group.appendChild(text);
                        }
                        
                        return group;
                    }
                    
                    // Badge 1: DO - at start and end of celeste space (treble) - NO TEXT, BLACK
                    svg.appendChild(createBadge(startX, spaceTreble, '#000000', 'DO', false));
                    svg.appendChild(createBadge(endX, spaceTreble, '#000000', 'DO', false));
                    
                    // Badge 2: FA - at start and end of green line (treble) - NO TEXT, BLACK
                    svg.appendChild(createBadge(startX, y1, '#000000', 'FA', false));
                    svg.appendChild(createBadge(endX, y1, '#000000', 'FA', false));
                    
                    // Badge 3: SOL - at start and end of yellow line (treble) - NO TEXT, BLACK
                    svg.appendChild(createBadge(startX, y4, '#000000', 'SOL', false));
                    svg.appendChild(createBadge(endX, y4, '#000000', 'SOL', false));
                    
                    // Badge 4: FA - at start and end of green line (bass) - NO TEXT, BLACK
                    svg.appendChild(createBadge(startX, y2, '#000000', 'FA', false));
                    svg.appendChild(createBadge(endX, y2, '#000000', 'FA', false));
                    
                    // Badge 5: SOL - at start and end of yellow line (bass) - NO TEXT, BLACK
                    svg.appendChild(createBadge(startX, y5, '#000000', 'SOL', false));
                    svg.appendChild(createBadge(endX, y5, '#000000', 'SOL', false));
                    
                    // Badge 6: DO - at start and end of celeste space (bass) - NO TEXT, BLACK
                    svg.appendChild(createBadge(startX, spaceBass, '#000000', 'DO', false));
                    svg.appendChild(createBadge(endX, spaceBass, '#000000', 'DO', false));
                    
                    // Badge 7: DO - at start and end of middle line - NO TEXT, BLACK
                    svg.appendChild(createBadge(startX, middleY, '#000000', 'DO', false));
                    svg.appendChild(createBadge(endX, middleY, '#000000', 'DO', false));
                }
            }
        }

        function generateNewNote() {
            // Clear previous selection
            clearStaffSelection();
            
            // Generate a random note (C4 to B5 range for treble clef)
            const noteIndex = Math.floor(Math.random() * 12); // 0-11 (C to B)
            const octave = 4 + Math.floor(Math.random() * 2); // 4 or 5
            
            const noteName = noteNames[noteIndex];
            const fullNoteName = `${noteName}${octave}`;
            
            window.currentStaffNote = {
                noteIndex: noteIndex,
                octave: octave,
                fullName: fullNoteName,
                noteName: noteName
            };
            
            // Draw the note on the staff
            drawNoteOnStaff(noteIndex, octave);
            
            // Hide feedback
            const feedback = document.getElementById('staffFeedback');
            if (feedback) {
                feedback.style.display = 'none';
            }
        }

        function drawNoteOnStaff(noteIndex, octave) {
            const svg = document.getElementById('staffSvg');
            if (!svg) return;
            
            // Remove previous note and stem
            const previousNote = svg.querySelector('.staff-note');
            if (previousNote) {
                previousNote.remove();
            }
            // Remove previous stems (all lines that are not staff lines)
            const previousStems = svg.querySelectorAll('line:not(.staff-line)');
            previousStems.forEach(stem => stem.remove());
            
            let staffTop, staffHeight, lineSpacing;
            
            // Level 1: Two staves (treble and bass) with reduced spacing
            if (currentLevel === '1') {
                staffHeight = 80; // Reduced from 200 to 80 (40% of original)
                lineSpacing = staffHeight / 4; // 20 instead of 50
                
                // Determine which staff to use based on octave
                // Treble clef: octave 4-5 (C4 and above)
                // Bass clef: octave 2-3 (below C4)
                if (octave >= 4) {
                    // Treble clef staff (top)
                    staffTop = 40;
                } else {
                    // Bass clef staff (bottom)
                    staffTop = 180; // Match the position in drawStaff()
                }
            } else {
                // Other levels: single treble clef staff
                staffTop = 50;
                staffHeight = 200;
                lineSpacing = staffHeight / 4;
            }
            
            // Calculate Y position based on note
            // Middle C (C4) is one line below the staff (ledger line)
            // C4 = noteIndex 0, octave 4
            // B4 = noteIndex 11, octave 4 (top line of staff)
            // C5 = noteIndex 0, octave 5 (one ledger line above)
            
            let yPosition;
            const noteValue = (octave - 4) * 12 + noteIndex;
            
            // Middle C (C4) is at position -1 (below staff)
            // B4 is at position 11 (top line)
            // C5 is at position 12 (above staff)
            
            // Map note to staff position
            // C4 = -1, D4 = 0, E4 = 1, F4 = 2, G4 = 3, A4 = 4, B4 = 5
            // C5 = 6, D5 = 7, etc.
            // For bass clef: C2 = -24, D2 = -22, E2 = -20, F2 = -19, G2 = -17, A2 = -15, B2 = -13
            // C3 = -12, D3 = -10, E3 = -8, F3 = -7, G3 = -5, A3 = -3, B3 = -1
            
            const notePositions = {
                // Octave 2 (bass clef - below staff)
                [-24]: -13,  // C2 - below bass staff (ledger line)
                [-23]: -12.5, // C#2
                [-22]: -12,  // D2 - below bass staff
                [-21]: -11.5, // D#2
                [-20]: -11,  // E2 - below bass staff
                [-19]: -10,  // F2 - below bass staff
                [-18]: -9.5, // F#2
                [-17]: -9,   // G2 - below bass staff
                [-16]: -8.5, // G#2
                [-15]: -8,   // A2 - below bass staff
                [-14]: -7.5, // A#2
                [-13]: -7,   // B2 - below bass staff
                // Octave 3 (bass clef)
                [-12]: -6,   // C3 - bass staff bottom line
                [-11]: -5.5, // C#3
                [-10]: -5,   // D3 - bass staff first space
                [-9]: -4.5,  // D#3
                [-8]: -4,    // E3 - bass staff second line
                [-7]: -3,    // F3 - bass staff second space
                [-6]: -2.5,  // F#3
                [-5]: -2,    // G3 - bass staff third line
                [-4]: -1.5,  // G#3
                [-3]: -1,    // A3 - bass staff third space
                [-2]: -0.5,  // A#3
                [-1]: 0,     // B3 - bass staff fourth line
                // Octave 4 (treble clef)
                0: -1,     // C4 - below treble staff (ledger line)
                1: -0.5,   // C#4 - between C and D
                2: 0,      // D4 - treble staff bottom line
                3: 0.5,    // D#4 - between D and E
                4: 1,      // E4 - treble staff first space
                5: 2,      // F4 - treble staff second line
                6: 2.5,    // F#4 - between F and G
                7: 3,      // G4 - treble staff second space
                8: 3.5,    // G#4 - between G and A
                9: 4,      // A4 - treble staff third line
                10: 4.5,   // A#4 - between A and B
                11: 5,     // B4 - treble staff third space
                // Octave 5 (treble clef - above staff)
                12: 6,     // C5 - treble staff top line
                13: 6.5,   // C#5
                14: 7,     // D5 - above treble staff
                15: 7.5,   // D#5
                16: 8,     // E5 - above treble staff
                17: 9,     // F5 - above treble staff
                18: 9.5,   // F#5
                19: 10,    // G5 - above treble staff
                20: 10.5,  // G#5
                21: 11,    // A5 - above treble staff
                22: 11.5,  // A#5
                23: 12,    // B5 - above treble staff
            };
            
            const position = notePositions[noteValue] !== undefined ? notePositions[noteValue] : noteValue - 1;
            yPosition = staffTop + (2 * lineSpacing) - (position * (lineSpacing / 2));
            
            // Draw note (circle)
            const note = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            note.setAttribute('cx', '400');
            note.setAttribute('cy', yPosition);
            note.setAttribute('r', currentLevel === '1' ? '10' : '15'); // Smaller note for level 1
            note.setAttribute('fill', '#e74c3c');
            note.setAttribute('stroke', '#000');
            note.setAttribute('stroke-width', '2');
            note.setAttribute('class', 'staff-note active');
            svg.appendChild(note);
            
            // Draw note stem if needed (notes above middle line go down, below go up)
            const middleLineY = staffTop + (2 * lineSpacing);
            const stemLength = currentLevel === '1' ? 24 : 60; // Shorter stem for level 1
            
            if (yPosition < middleLineY) {
                // Note is in upper half, stem goes down
                const stem = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                stem.setAttribute('x1', '415');
                stem.setAttribute('y1', yPosition);
                stem.setAttribute('x2', '415');
                stem.setAttribute('y2', yPosition + stemLength);
                stem.setAttribute('stroke', '#000');
                stem.setAttribute('stroke-width', '2');
                svg.appendChild(stem);
            } else {
                // Note is in lower half, stem goes up
                const stem = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                stem.setAttribute('x1', '385');
                stem.setAttribute('y1', yPosition);
                stem.setAttribute('x2', '385');
                stem.setAttribute('y2', yPosition - stemLength);
                stem.setAttribute('stroke', '#000');
                stem.setAttribute('stroke-width', '2');
                svg.appendChild(stem);
            }
        }

        function checkAnswer() {
            if (!window.currentStaffNote || selectedNotes.size === 0) {
                return;
            }
            
            const t = translations[currentLanguage];
            const feedback = document.getElementById('staffFeedback');
            
            // Get the selected note
            const selectedNote = Array.from(selectedNotes)[0];
            const selectedNoteName = selectedNote.replace(/\d+$/, '');
            const correctNoteName = window.currentStaffNote.noteName;
            
            // Decrease attempts (each key press uses one attempt)
            if (exerciseActive) {
                remainingAttempts--;
                updateCounters();
            }
            
            // Check if correct (compare note names, ignoring octave for now)
            if (selectedNoteName === correctNoteName) {
                if (exerciseActive) {
                    // Correct answer during exercise
                    correctCount++;
                    updateCounters();
                    
                    // Stop timer
                    if (timeInterval) {
                        clearInterval(timeInterval);
                        timeInterval = null;
                    }
                    
                    // Move to next note
                    setTimeout(() => {
                        nextNote();
                    }, 500);
                } else {
                    // Not in exercise mode - show feedback
                    feedback.textContent = t.correctAnswer;
                    feedback.className = 'staff-feedback correct';
                    feedback.style.display = 'block';
                }
            } else {
                if (exerciseActive) {
                    // Wrong answer during exercise
                    // Only count as failure if no attempts left or time is up
                    if (remainingAttempts <= 0 || timeRemaining <= 0) {
                        // This is a failure - increment wrong count
                        wrongCount++;
                        updateCounters();
                        
                        // Stop timer
                        if (timeInterval) {
                            clearInterval(timeInterval);
                            timeInterval = null;
                        }
                        // Move to next note
                        setTimeout(() => {
                            nextNote();
                        }, 500);
                    } else {
                        // Still have attempts - just clear selection for next attempt
                        // Do NOT increment wrong count yet
                        clearStaffSelection();
                    }
                } else {
                    // Not in exercise mode - show feedback
                    feedback.textContent = `${t.incorrectAnswer} (Correcta: ${correctNoteName})`;
                    feedback.className = 'staff-feedback incorrect';
                    feedback.style.display = 'block';
                }
            }
        }

        function clearStaffSelection() {
            selectedNotes.clear();
            document.querySelectorAll('#staffPiano .white-key.active, #staffPiano .black-key.active').forEach(key => {
                key.classList.remove('active');
            });
            
            // In practice mode, clear all practice notes
            if (currentLevel === 'Practicar') {
                practiceNotes = [];
                // Redraw staff to remove all practice notes
                drawStaff();
                return;
            }
            
            const feedback = document.getElementById('staffFeedback');
            if (feedback) {
                feedback.style.display = 'none';
            }
        }
        
        // Function to draw practice note on staff (oval, black, no stem)
        function drawPracticeNoteOnStaff(noteIndex, octave, xPosition, noteName) {
            const svg = document.getElementById('staffSvg');
            if (!svg) return;
            
            const staffHeight = 80;
            const lineSpacing = staffHeight / 4; // 20 pixels between consecutive lines
            const trebleStaffTop = 40;
            const bassStaffTop = 180;
            
            // Reference positions:
            // C4 (Do central) at middle line between staves: y = 150
            // E4 (Mi4) at treble bottom line (line 4): y = 120
            // A3 (La3) at bass top line (line 0): y = 180
            const middleLineY = 150; // C4 position
            const trebleBottomLine = trebleStaffTop + (4 * lineSpacing); // 120 (E4)
            const bassTopLine = bassStaffTop; // 180 (A3)
            
            // Map noteIndex to natural note position (0=C, 1=D, 2=E, 3=F, 4=G, 5=A, 6=B)
            // Natural notes: C(0), D(2), E(4), F(5), G(7), A(9), B(11)
            // Sharps: C#(1), D#(3), F#(6), G#(8), A#(10)
            const naturalNoteMap = {
                0: 0,   // C
                1: 0,   // C# -> use C position
                2: 1,   // D
                3: 1,   // D# -> use D position
                4: 2,   // E
                5: 3,   // F
                6: 3,   // F# -> use F position
                7: 4,   // G
                8: 4,   // G# -> use G position
                9: 5,   // A
                10: 5,  // A# -> use A position
                11: 6   // B
            };
            
            // Check if note is sharp
            const isSharp = noteName && noteName.includes('#');
            
            // Get natural note position in scale (0-6)
            const naturalPosition = naturalNoteMap[noteIndex] !== undefined ? naturalNoteMap[noteIndex] : 0;
            
            // Calculate note value from C4 using noteIndex directly (0-11 for semitones)
            // This ensures correct calculation for all notes including octave 2
            const noteValue = (octave - 4) * 12 + noteIndex;
            
            // Calculate Y position based on natural notes (10 pixels per natural note)
            // Each natural note step = 10 pixels
            // The pentagram follows the natural scale, not semitones
            let yPosition;
            const naturalNoteSpacing = 10; // 10 pixels per natural note step
            
            // Helper function to calculate steps from A3 using noteIndex directly
            function getNaturalStepsFromA3UsingNoteIndex(noteValue, noteIndex, octave) {
                // A3 is at octave 3, noteIndex 9
                // Calculate natural steps: A=0, G=1, F=2, E=3, D=4, C=5, B=6
                // Map noteIndex (0-11) directly to steps from A
                const noteToStepsFromA = {
                    9: 0,   // A = 0 steps
                    7: 1,   // G = 1 step down
                    5: 2,   // F = 2 steps down
                    4: 3,   // E = 3 steps down
                    2: 4,   // D = 4 steps down
                    0: 5,   // C = 5 steps down
                    11: 6,  // B = 6 steps down
                    // Accidentals map to their natural note
                    1: 5,   // C# -> C = 5 steps down
                    3: 4,   // D# -> D = 4 steps down
                    6: 2,   // F# -> F = 2 steps down
                    8: 1,   // G# -> G = 1 step down
                    10: 0   // A# -> A = 0 steps
                };
                
                // Use noteIndex directly (0-11), not the mapped natural position
                const stepsInOctave = noteToStepsFromA[noteIndex] !== undefined ? noteToStepsFromA[noteIndex] : 0;
                
                // Calculate octaves below A3
                // Special case: B2 is in octave 2 but comes right after C3, so it should be treated
                // as if it's at the end of octave 2, not the beginning
                let octavesBelow = 3 - octave; // A3 is octave 3
                
                // For B in octave 2, it's actually just 6 steps down from A3 (same octave distance as B3 would be)
                // B2 is noteValue -13, which is 12 semitones below B3 (noteValue -1)
                // So B2 should be: B3 position (6 steps) + 1 octave (7 steps) = 13 steps... wait, that's what we have
                // But the issue is that B2 should be positioned relative to C3, not at the end of octave 2
                
                // Actually, let's think differently: B2 is the last note before C3
                // C3 is at: (3-3)*7 + 5 = 5 steps from A3
                // B2 should be at: 5 - 1 = 4 steps from A3? No, that doesn't make sense either
                
                // Let me recalculate: B2 noteValue = -13, which is 12 semitones below B3 (-1)
                // In natural steps: B3 is 6 steps from A3, B2 is 6 + 7 = 13 steps from A3
                // But that puts B2 too low. The issue is that B comes after A in the same octave,
                // so B2 should be positioned as: same octave as A2 but 1 step higher (B comes before A in the cycle)
                
                // Actually wait, in music notation, B comes after A in the same octave
                // So B2 should be 1 step DOWN from A2, not up
                // A2 is at 7 steps from A3, so B2 should be at 6 steps from A3? No, that's B3
                
                // Let me think about this more carefully:
                // A3 = 0 steps from A3
                // G3 = 1 step down
                // F3 = 2 steps down
                // E3 = 3 steps down
                // D3 = 4 steps down
                // C3 = 5 steps down
                // B2 = ? steps down
                // A2 = 7 steps down (1 octave + 0)
                // G2 = 8 steps down
                
                // B2 should be 6 steps down from A3, which is the same as B3 would be
                // But B3 is noteValue -1, which is handled separately
                // B2 is noteValue -13, which is 12 semitones below B3
                // So B2 = B3 position (6 steps) but in the previous octave
                // That would be: 6 - 7 = -1? No, that doesn't work
                
                // Actually, I think the issue is simpler: B2 should be calculated as:
                // It's in octave 2, and B is 6 steps from A, so:
                // If we're in octave 2, we need to go down 1 octave (7 steps) and then B is 6 steps from A
                // But that gives us 13 steps, which is what we have
                
                // Wait, maybe the problem is that B2 is being positioned correctly but there's something else wrong
                // Let me check: if B2 is at y=310 and A2 is at y=250, then B2 is 60 pixels below A2
                // That's 6 natural note steps, which makes sense (B is 6 steps from A)
                // But the user says A2 and G2 are below B2, which means B2 should be higher
                
                // Oh! I think I misunderstood. The user says "A2 y G2 est√°n por debajo de B2"
                // which means "A2 and G2 are below B2" - so B2 is higher than A2 and G2
                // That means B2 should have a smaller yPosition value, not larger
                
                // So the calculation is backwards! B2 should be at fewer steps from A3, not more
                // B2 is the first note of octave 2 (the highest), so it should be closest to A3
                
                // Actually, in terms of pitch: B2 < A2 < G2 (B2 is lower pitch than A2)
                // But in terms of staff position: B2 should be drawn higher on the staff than A2
                // because B comes after A in the alphabet, so B2 is written higher than A2
                
                // Wait, I'm confused about the staff notation. Let me think:
                // In bass clef, lower notes are drawn lower on the staff
                // B2 has a lower pitch than A2, so B2 should be drawn lower (higher y value) than A2
                // But the user says A2 and G2 are below B2, which suggests B2 is drawn higher (lower y value)
                
                // Maybe the user means that A2 and G2 are written below B2 on the staff visually?
                // That would mean B2 is higher on the staff, which means lower y value
                
                // I think the issue is that B2's calculation is giving it too many steps
                // B2 should be positioned as: it's the note right after C3
                // C3 is at 5 steps from A3, so B2 should be at... hmm, but B comes before C in the cycle
                
                // Actually, I think the real issue is that B2 needs special handling because
                // it's the "wrap-around" note - it's in octave 2 but comes right after C3
                // So B2 should be calculated as: C3 position - 1 step = 5 - 1 = 4 steps from A3
                
                // But wait, that would put B2 at the same position as D3, which is wrong
                
                // Let me try a different approach: B2 should be at 6 steps from A3 (same as B3 would be)
                // but since it's in octave 2, we need to account for the octave difference differently
                
                // Actually, I think the simplest fix is: if noteIndex is 11 (B) and octave is 2,
                // then B2 should be positioned as 6 steps from A3 (not 13)
                if (noteIndex === 11 && octave === 2) {
                    // B2 is the note right after C3, so it should be 6 steps from A3
                    // (B is 6 steps from A, and we're still in the same relative position)
                    return 6;
                }
                
                // Total steps = octaves below * 7 (natural notes per octave) + steps in octave
                return (octavesBelow * 7) + stepsInOctave;
            }
            
            // Map noteValue to position using natural note steps from C4
            // We need to convert from semitones to natural note positions
            // Natural notes: C=0, D=2, E=4, F=5, G=7, A=9, B=11 (in semitones)
            // Natural positions: C=0, D=1, E=2, F=3, G=4, A=5, B=6 (in scale steps)
            
            // Convert noteValue (in semitones) to natural note position (0-6 in octave)
            // Then calculate steps from C4
            
            function semitonesToNaturalSteps(semitones) {
                // Map semitones to natural note steps within an octave
                // C=0->0, D=2->1, E=4->2, F=5->3, G=7->4, A=9->5, B=11->6
                const semitoneToStep = {
                    0: 0, 2: 1, 4: 2, 5: 3, 7: 4, 9: 5, 11: 6
                };
                // For notes in range 0-11
                if (semitones >= 0) {
                    const octaveSteps = Math.floor(semitones / 12) * 7; // 7 natural notes per octave
                    const noteInOctave = semitones % 12;
                    // Round to nearest natural note
                    let stepInOctave;
                    if (semitoneToStep[noteInOctave] !== undefined) {
                        stepInOctave = semitoneToStep[noteInOctave];
                    } else {
                        // For accidentals, round to nearest natural (down for #, up for b)
                        if (noteInOctave === 1) stepInOctave = 0; // C# -> C
                        else if (noteInOctave === 3) stepInOctave = 1; // D# -> D
                        else if (noteInOctave === 6) stepInOctave = 3; // F# -> F
                        else if (noteInOctave === 8) stepInOctave = 4; // G# -> G
                        else if (noteInOctave === 10) stepInOctave = 5; // A# -> A
                        else stepInOctave = 0;
                    }
                    return octaveSteps + stepInOctave;
                } else {
                    // For negative semitones (below C4)
                    const octaveSteps = Math.ceil(semitones / 12) * 7; // 7 natural notes per octave
                    const noteInOctave = ((semitones % 12) + 12) % 12; // Normalize to 0-11
                    let stepInOctave;
                    if (semitoneToStep[noteInOctave] !== undefined) {
                        stepInOctave = semitoneToStep[noteInOctave] - 7; // Negative for below C
                    } else {
                        // For accidentals, round to nearest natural
                        if (noteInOctave === 1) stepInOctave = -7; // C# -> C
                        else if (noteInOctave === 3) stepInOctave = -6; // D# -> D
                        else if (noteInOctave === 6) stepInOctave = -4; // F# -> F
                        else if (noteInOctave === 8) stepInOctave = -3; // G# -> G
                        else if (noteInOctave === 10) stepInOctave = -2; // A# -> A
                        else stepInOctave = -7;
                    }
                    return octaveSteps + stepInOctave;
                }
            }
            
            // Helper function to convert semitones to natural note steps
            // Natural notes: C=0, D=2, E=4, F=5, G=7, A=9, B=11
            // Natural steps: C=0, D=1, E=2, F=3, G=4, A=5, B=6 (within one octave)
            function getNaturalStepsFromC4(semitones) {
                const octaves = Math.floor(semitones / 12);
                const noteInOctave = semitones % 12;
                
                // Map note in octave to step in octave (0-6)
                const noteToStep = {
                    0: 0,   // C
                    2: 1,   // D
                    4: 2,   // E
                    5: 3,   // F
                    7: 4,   // G
                    9: 5,   // A
                    11: 6   // B
                };
                
                let stepInOctave;
                if (noteToStep[noteInOctave] !== undefined) {
                    stepInOctave = noteToStep[noteInOctave];
                } else {
                    // For accidentals, use natural note position
                    if (noteInOctave === 1) stepInOctave = 0; // C# -> C
                    else if (noteInOctave === 3) stepInOctave = 1; // D# -> D
                    else if (noteInOctave === 6) stepInOctave = 3; // F# -> F
                    else if (noteInOctave === 8) stepInOctave = 4; // G# -> G
                    else if (noteInOctave === 10) stepInOctave = 5; // A# -> A
                    else stepInOctave = 0;
                }
                
                // Total natural steps from C4: 7 steps per octave
                return (octaves * 7) + stepInOctave;
            }
            
            function getNaturalStepsFromA3(semitones) {
                // A3 is at -3 semitones from C4
                // Count natural steps down from A3 in bass clef
                // B3=-1 step (above A3), A3=0, G3=1 down, F3=2 down, E3=3 down, D3=4 down, C3=5 down, B2=6 down
                // For octave 2: A2=7 down, G2=8 down, F2=9 down, E2=10 down, D2=11 down, C2=12 down, B2=13 down
                
                // Calculate semitones difference from A3
                // A3 = -3, so difference = semitones - (-3) = semitones + 3
                const semitonesFromA3 = semitones + 3;
                
                // Handle B3 which is above A3 (semitonesFromA3 = 2, which maps to B)
                if (semitonesFromA3 === 2) {
                    return -1; // B3 is 1 step above A3
                }
                
                // For notes below A3, calculate octaves and note within octave
                // Handle negative values correctly
                let octavesBelow, noteInOctave;
                if (semitonesFromA3 >= 0) {
                    octavesBelow = Math.floor(semitonesFromA3 / 12);
                    noteInOctave = semitonesFromA3 % 12;
                } else {
                    // For negative values, we need to calculate differently
                    // Example: C2 = -24, semitonesFromA3 = -21
                    // -21 / 12 = -1.75, so we want -2 octaves
                    octavesBelow = Math.floor(semitonesFromA3 / 12);
                    // For noteInOctave with negative: -21 % 12 = -9, but we want 3 (which is 12 - 9)
                    noteInOctave = ((semitonesFromA3 % 12) + 12) % 12;
                }
                
                // Map note to steps down from A within an octave (A=0, G=1, F=2, E=3, D=4, C=5, B=6)
                const noteToStepsDown = {
                    9: 0,   // A = 0 steps (A3 itself)
                    7: 1,   // G = 1 step down
                    5: 2,   // F = 2 steps down
                    4: 3,   // E = 3 steps down
                    2: 4,   // D = 4 steps down
                    0: 5,   // C = 5 steps down
                    11: 6   // B = 6 steps down
                };
                
                let stepsInOctave;
                if (noteToStepsDown[noteInOctave] !== undefined) {
                    stepsInOctave = noteToStepsDown[noteInOctave];
                } else {
                    // For accidentals, map to nearest natural note (round down)
                    if (noteInOctave === 8) stepsInOctave = 1; // G# -> G = 1 step down
                    else if (noteInOctave === 6) stepsInOctave = 2; // F# -> F = 2 steps down
                    else if (noteInOctave === 3) stepsInOctave = 4; // D# -> D = 4 steps down
                    else if (noteInOctave === 1) stepsInOctave = 5; // C# -> C = 5 steps down
                    else if (noteInOctave === 10) stepsInOctave = 0; // A# -> A = 0 steps
                    else stepsInOctave = 0;
                }
                
                // Total steps = octaves below * 7 (natural notes per octave) + steps in octave
                // For negative semitonesFromA3 (notes above A3), this will be handled by the B3 check above
                return (octavesBelow * 7) + stepsInOctave;
            }
            
            // Calculate Y position using reference points
            if (noteValue === 0) {
                // C4 at middle line
                yPosition = middleLineY;
            } else if (noteValue === 2) {
                // D4: same distance above C4 as B3 is below C4
                // B3 is at y = 170 (bassTopLine - naturalNoteSpacing = 180 - 10)
                // C4 is at y = 150 (middleLineY)
                // Distance from C4 to B3: 170 - 150 = 20 pixels down
                // So D4 should be 20 pixels up from C4: 150 - 20 = 130
                const distanceC4ToB3 = (bassTopLine - naturalNoteSpacing) - middleLineY; // 20 pixels
                yPosition = middleLineY - distanceC4ToB3; // 130
            } else if (noteValue >= 4) {
                // E4 and above in treble clef
                if (noteValue === 4) {
                    // E4: at treble bottom line
                    yPosition = trebleBottomLine; // 120
                } else {
                    // E4 is step 2 from C4 (C4=0, D4=1, E4=2)
                    // Calculate natural steps from E4: F4=1, G4=2, A4=3, B4=4, C5=5, D5=6, E5=7, etc.
                    const stepsFromC4 = getNaturalStepsFromC4(noteValue);
                    const stepsFromE4 = stepsFromC4 - 2; // E4 is step 2 from C4
                    yPosition = trebleBottomLine - (stepsFromE4 * naturalNoteSpacing);
                }
            } else if (noteValue === -1) {
                // B3: 1 step up from A3 = 10px up (NOT down!)
                // B3 is above A3 in the bass clef, so it should be higher (lower Y)
                yPosition = bassTopLine - naturalNoteSpacing; // 170 (not 190!)
            } else if (noteValue <= -3) {
                // A3 and below in bass clef (including octave 2)
                if (noteValue === -3) {
                    // A3: at bass top line
                    yPosition = bassTopLine; // 180
                } else {
                    // A3 is at bass top (180), count steps down from A3
                    // Use noteIndex directly to calculate steps from A3 more accurately
                    // A3 has noteIndex 9, so we can calculate relative to A
                    const stepsFromA3 = getNaturalStepsFromA3UsingNoteIndex(noteValue, noteIndex, octave);
                    yPosition = bassTopLine + (Math.abs(stepsFromA3) * naturalNoteSpacing);
                }
            } else {
                // Notes between C4 and E4 (only D4, already handled above)
                const stepsFromC4 = getNaturalStepsFromC4(noteValue);
                yPosition = middleLineY - (stepsFromC4 * naturalNoteSpacing);
            }
            
            // Draw oval note (ellipse) - black, no stem
            const note = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
            note.setAttribute('cx', xPosition);
            note.setAttribute('cy', yPosition);
            note.setAttribute('rx', '8'); // Horizontal radius (oval)
            note.setAttribute('ry', '6'); // Vertical radius (oval)
            note.setAttribute('fill', '#000000'); // Black
            note.setAttribute('stroke', '#000');
            note.setAttribute('stroke-width', '1');
            note.setAttribute('class', 'practice-note');
            svg.appendChild(note);
            
            // Draw ledger lines for notes that need them
            // C4 needs a ledger line at the middle line
            if (noteValue === 0) {
                drawLedgerLine(svg, xPosition, yPosition);
            }
            
            // Draw ledger lines for notes above the treble staff (only A5 and B5)
            // Both A5 and B5 share the same ledger line
            // A5 is on the ledger line (noteValue = 21, noteIndex = 9)
            // B5 is in the space below the ledger line (noteValue = 23, noteIndex = 11)
            if (noteValue === 21 || noteValue === 23) {
                // Both A5 and B5 use the same ledger line position
                // The ledger line is at the first ledger line above the treble staff
                // Treble staff top line is at y = trebleStaffTop = 40
                // First ledger line above is at y = trebleStaffTop - lineSpacing = 40 - 20 = 20
                const ledgerY = trebleStaffTop - lineSpacing; // 20
                drawLedgerLine(svg, xPosition, ledgerY);
            }
            
            // Draw ledger lines for notes below the bass staff (octave 2 notes)
            // Bass staff bottom line is at y = bassTopLine + (4 * lineSpacing) = 180 + 80 = 260
            const bassStaffBottom = bassTopLine + (4 * lineSpacing); // 260
            
            // Specific ledger line rules for octave 2 notes:
            // F2 (noteValue = -19): no ledger
            // E2 (noteValue = -20): ledger at note position (crossing the note)
            // D2 (noteValue = -22): ledger above (same as E2)
            // C2 (noteValue = -24): TWO ledgers - same as E2/D2 plus one crossing the note
            
            if (noteValue === -20) {
                // E2: ledger crossing the note (at note position)
                drawLedgerLine(svg, xPosition, yPosition);
            } else if (noteValue === -22) {
                // D2: ledger above (same position as E2's ledger)
                // E2's ledger is at E2's yPosition, so we need to find E2's position
                // E2 is noteIndex 4, octave 2, so we calculate its position
                const e2StepsFromA3 = getNaturalStepsFromA3UsingNoteIndex(-20, 4, 2);
                const e2YPosition = bassTopLine + (Math.abs(e2StepsFromA3) * naturalNoteSpacing);
                drawLedgerLine(svg, xPosition, e2YPosition);
            } else if (noteValue === -24) {
                // C2: TWO ledgers
                // First ledger: same as E2/D2 (above)
                const e2StepsFromA3 = getNaturalStepsFromA3UsingNoteIndex(-20, 4, 2);
                const e2YPosition = bassTopLine + (Math.abs(e2StepsFromA3) * naturalNoteSpacing);
                drawLedgerLine(svg, xPosition, e2YPosition);
                // Second ledger: crossing the note (at C2's position)
                drawLedgerLine(svg, xPosition, yPosition);
            }
            
            // Helper function to draw a ledger line
            function drawLedgerLine(svg, xPos, yPos) {
                const lineLength = 25;
                const ledgerLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                ledgerLine.setAttribute('x1', xPos - (lineLength / 2));
                ledgerLine.setAttribute('y1', yPos);
                ledgerLine.setAttribute('x2', xPos + (lineLength / 2));
                ledgerLine.setAttribute('y2', yPos);
                ledgerLine.setAttribute('stroke', '#000000');
                ledgerLine.setAttribute('stroke-width', '2'); // Same as staff lines
                ledgerLine.setAttribute('class', 'practice-ledger-line');
                svg.appendChild(ledgerLine);
            }
            
            // Draw sharp symbol (#) if note is sharp, positioned to the left of the note
            if (isSharp) {
                const sharpSymbol = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                sharpSymbol.setAttribute('x', xPosition - 15); // Position to the left of note
                sharpSymbol.setAttribute('y', yPosition); // Same vertical position as note
                sharpSymbol.setAttribute('text-anchor', 'middle');
                sharpSymbol.setAttribute('font-size', '16');
                sharpSymbol.setAttribute('font-weight', 'bold');
                sharpSymbol.setAttribute('fill', '#000000');
                sharpSymbol.setAttribute('font-family', 'Arial, sans-serif');
                sharpSymbol.textContent = '#';
                svg.appendChild(sharpSymbol);
            }
        }
        
        // Function to toggle practice anchors and colored lines
        function togglePracticeAnchor(noteName) {
            if (currentLevel !== 'Practicar') return;
            
            // Toggle anchor state
            practiceAnchors[noteName] = !practiceAnchors[noteName];
            
            // Update button active state
            const button = document.querySelector(`.anchor-btn-${noteName.toLowerCase()}`);
            if (button) {
                if (practiceAnchors[noteName]) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            }
            
            // Remove existing anchor elements for this note
            practiceAnchorElements = practiceAnchorElements.filter(el => {
                if (el.dataset.anchorNote === noteName) {
                    el.remove();
                    return false;
                }
                return true;
            });
            
            // Draw or remove anchors and lines
            if (practiceAnchors[noteName]) {
                drawPracticeAnchors(noteName);
            }
        }
        
        // Function to draw anchors and colored lines for practice mode
        function drawPracticeAnchors(noteName) {
            const svg = document.getElementById('staffSvg');
            if (!svg) return;
            
            const staffHeight = 80;
            const lineSpacing = staffHeight / 4; // 20
            const trebleStaffTop = 40;
            const bassStaffTop = 180;
            const width = 800;
            const startX = 50;
            const endX = width - 50;
            
            // Calculate positions (same as level 1)
            const y1 = trebleStaffTop + (0 * lineSpacing); // Line 1 (green) - treble
            const y4 = trebleStaffTop + (3 * lineSpacing); // Line 4 (yellow) - treble
            const spaceTreble = trebleStaffTop + (1.5 * lineSpacing); // Second space from top (celeste) - treble
            const y2 = bassStaffTop + (1 * lineSpacing); // Line 2 (green) - bass
            const y5 = bassStaffTop + (4 * lineSpacing); // Line 5 (yellow) - bass
            const spaceBass = bassStaffTop + (2.5 * lineSpacing); // Second space from bottom (celeste) - bass
            const trebleStaffBottom = trebleStaffTop + (4 * lineSpacing);
            const middleY = (trebleStaffBottom + bassStaffTop) / 2; // Middle line between staves (celeste)
            
            let color, positions;
            
            // Define positions and color for each note
            if (noteName === 'DO') {
                color = '#87ceeb'; // Celeste
                positions = [
                    { y: spaceTreble, label: 'DO' }, // Treble space
                    { y: spaceBass, label: 'DO' }, // Bass space
                    { y: middleY, label: 'DO' } // Middle line
                ];
            } else if (noteName === 'FA') {
                color = '#00ff00'; // Green
                positions = [
                    { y: y1, label: 'FA' }, // Treble line 1
                    { y: y2, label: 'FA' } // Bass line 2
                ];
            } else if (noteName === 'SOL') {
                color = '#ffff00'; // Yellow
                positions = [
                    { y: y4, label: 'SOL' }, // Treble line 4
                    { y: y5, label: 'SOL' } // Bass line 5
                ];
            } else {
                return;
            }
            
            // Helper function to create badge with note name (same as level 1)
            function createBadge(x, y, color, noteText) {
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('data-anchor-note', noteName);
                
                // Anchor emoji in corresponding color
                const anchorEmoji = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                anchorEmoji.setAttribute('x', x);
                anchorEmoji.setAttribute('y', y + 6);
                anchorEmoji.setAttribute('text-anchor', 'middle');
                anchorEmoji.setAttribute('font-size', '20');
                anchorEmoji.setAttribute('fill', color);
                anchorEmoji.setAttribute('font-family', 'Arial, sans-serif');
                anchorEmoji.textContent = '‚öì';
                group.appendChild(anchorEmoji);
                
                // Note name to the left of the anchor (in black) - same as level 1
                if (noteText) {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', x - 12); // Positioned to the left of the anchor
                    text.setAttribute('y', y + 6); // Same vertical position as anchor
                    text.setAttribute('text-anchor', 'end'); // Right-aligned so it ends just before the anchor
                    text.setAttribute('font-size', '10');
                    text.setAttribute('font-weight', 'bold');
                    text.setAttribute('fill', '#000'); // Black text
                    text.setAttribute('font-family', 'Arial, sans-serif');
                    text.textContent = noteText;
                    group.appendChild(text);
                }
                
                return group;
            }
            
            // Draw colored highlights and badges
            positions.forEach(pos => {
                // Draw colored highlight line
                const highlight = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                highlight.setAttribute('x1', startX);
                highlight.setAttribute('y1', pos.y);
                highlight.setAttribute('x2', endX);
                highlight.setAttribute('y2', pos.y);
                highlight.setAttribute('stroke', color);
                
                // Set stroke width based on note type
                if (noteName === 'DO') {
                    highlight.setAttribute('stroke-width', pos.y === middleY ? '6' : '10');
                } else {
                    highlight.setAttribute('stroke-width', '8');
                }
                
                highlight.setAttribute('opacity', '0.5');
                highlight.setAttribute('stroke-linecap', 'round');
                highlight.setAttribute('data-anchor-note', noteName);
                svg.appendChild(highlight);
                practiceAnchorElements.push(highlight);
                
                // Draw badges at start and end with note names (same as level 1)
                const badge1 = createBadge(startX, pos.y, color, pos.label);
                const badge2 = createBadge(endX, pos.y, color, pos.label);
                svg.appendChild(badge1);
                svg.appendChild(badge2);
                practiceAnchorElements.push(badge1);
                practiceAnchorElements.push(badge2);
            });
            
            // For FA: Draw a thin chain/rope connecting the anchors with a simple curve (left side, curves left)
            if (noteName === 'FA') {
                // Connect the two FA anchors (one in treble, one in bass) with a curved chain/rope
                const faPositions = positions; // y1 (treble) and y2 (bass)
                if (faPositions.length === 2) {
                    const y1 = faPositions[0].y; // Treble FA position
                    const y2 = faPositions[1].y; // Bass FA position
                    const x = startX; // X position (left side)
                    const midY = (y1 + y2) / 2; // Middle point
                    
                    // Create a simple curved path that swings left (like a hanging rope/chain)
                    // Single smooth curve from top anchor to bottom anchor, curving left in the middle
                    const offsetX = -25; // How far left the curve goes (more pronounced)
                    
                    // Use darker green for better visibility
                    const darkerGreen = '#008000'; // Dark green / forest green
                    
                    // Simple single curve: start at top, curve left in middle, end at bottom
                    const pathData = `M ${x} ${y1} ` + // Move to start (top anchor)
                                    `Q ${x + offsetX} ${midY}, ` + // Control point (curve left at middle)
                                    `${x} ${y2}`; // End at bottom anchor
                    
                    const chain = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    chain.setAttribute('d', pathData);
                    chain.setAttribute('stroke', darkerGreen); // Darker green color for better visibility
                    chain.setAttribute('stroke-width', '2.5'); // Thicker for better visibility
                    chain.setAttribute('fill', 'none');
                    chain.setAttribute('opacity', '1'); // 100% opacity
                    chain.setAttribute('stroke-linecap', 'round');
                    chain.setAttribute('stroke-linejoin', 'round');
                    chain.setAttribute('data-anchor-note', noteName);
                    chain.setAttribute('data-chain-type', 'curved');
                    svg.appendChild(chain);
                    practiceAnchorElements.push(chain);
                }
            }
            
            // For SOL: Draw a thin chain/rope connecting the anchors with a simple curve (right side, curves right)
            if (noteName === 'SOL') {
                // Connect the two SOL anchors (one in treble, one in bass) with a curved chain/rope
                const solPositions = positions; // y4 (treble) and y5 (bass)
                if (solPositions.length === 2) {
                    const y1 = solPositions[0].y; // Treble SOL position
                    const y2 = solPositions[1].y; // Bass SOL position
                    const x = endX; // X position (right side)
                    const midY = (y1 + y2) / 2; // Middle point
                    
                    // Create a simple curved path that swings right (like a hanging rope/chain)
                    // Single smooth curve from top anchor to bottom anchor, curving right in the middle
                    const offsetX = 25; // How far right the curve goes (positive for right direction)
                    
                    // Use darker yellow for better visibility
                    const darkerYellow = '#d4af37'; // Golden yellow / darker yellow
                    
                    // Simple single curve: start at top, curve right in middle, end at bottom
                    const pathData = `M ${x} ${y1} ` + // Move to start (top anchor)
                                    `Q ${x + offsetX} ${midY}, ` + // Control point (curve right at middle)
                                    `${x} ${y2}`; // End at bottom anchor
                    
                    const chain = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    chain.setAttribute('d', pathData);
                    chain.setAttribute('stroke', darkerYellow); // Darker yellow color for better visibility
                    chain.setAttribute('stroke-width', '2.5'); // Thicker for better visibility
                    chain.setAttribute('fill', 'none');
                    chain.setAttribute('opacity', '1'); // 100% opacity
                    chain.setAttribute('stroke-linecap', 'round');
                    chain.setAttribute('stroke-linejoin', 'round');
                    chain.setAttribute('data-anchor-note', noteName);
                    chain.setAttribute('data-chain-type', 'curved');
                    svg.appendChild(chain);
                    practiceAnchorElements.push(chain);
                }
            }
        }

        // Initialize piano and language
        createPiano();
        updateLanguage();
        
        // Initialize exercise state and counters with exercise 1 values
        resetExerciseState();
        updateCounters();
    </script>
</body>
</html>
